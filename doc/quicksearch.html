<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"ApproverMatrix.js.html":{"id":"ApproverMatrix.js.html","title":"Source: ApproverMatrix.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: ApproverMatrix.js /** * @fileOverview This files contain Approver Matrix functions for BRMS Approver deployment * @author anadar * @version 1.0.0 */ /** * @module ApproverMatrix */ importPackage(com.vistaar.docserver.util); importPackage(org.json); importPackage(java.lang); /* The script to add Approver Matrix */ var inpRoles = new org.json.JSONArray(docServerManager.getAllRolesDetails()); var BRMSConnector = VistaarJSUtils.getBRMSConnector(userConnInfo); /* Commenting out delete RuleBundles var rulebundlesCodes= new Array (); rulebundlesCodes[0] = &quot;CWF_RB&quot;; BRMSConnector.deleteRuleBundles(rulebundlesCodes) ; var retVal = BRMSConnector.createRuleBundle(&quot;DOA_ApproverMatrix_RB&quot;,&quot;CWF_RB&quot;); println(&quot;Returned Value is&quot; + retVal); var arrRuleSetName=[]; BRMSConnector.addRuleSet(&quot;DOA_ApproverMatrix_RB&quot;, &quot;CWF_ApproverMatrix_DT&quot;); BRMSConnector.addRuleSet(&quot;DOA_ApproverMatrix_RB&quot;, &quot;Default Approver Setup&quot;); BRMSConnector.addRuleSet(&quot;DOA_ApproverMatrix_RB&quot;, &quot;CWF_Common&quot;); */ var ApproverMatrix = &quot;CWF_ApproverMatrix_DT&quot;; var creatorRuleSetObject = BRMSConnector.loadRuleSet(ApproverMatrix); //println(&quot;\\n\\n\\n\\n=========creatorRuleSet&quot;+creatorRuleSet); var creatorRuleSetObjectJSON = new org.json.JSONObject(creatorRuleSetObject.toString()); creatorRuleSetObjectJSON.get(&quot;DecisionTableInfo&quot;).put(&quot;Data&quot;, []); addToCreatorMatrix(inpRoles, creatorRuleSetObjectJSON); var CreatorMatrixRuleSet = new com.vistaar.rules.dataObjects.RuleSet(creatorRuleSetObjectJSON.toString()); BRMSConnector.saveRuleSet(CreatorMatrixRuleSet); var retVal = BRMSConnector.registerRules(&quot;DOA_ApproverMatrix_RB&quot;, 1, true); println(&quot;Returned Value is&quot; + retVal); output = &quot;success&quot;; function addToCreatorMatrix(inpRoles, CreatorMatrix_DT) { try { var ruleSetData = JSON.parse(CreatorMatrix_DT.get(&quot;DecisionTableInfo&quot;).get(&quot;Data&quot;)); var l_inpRolesLen = inpRoles.length(); var l_role = null; for (var roleItr = 0; roleItr &lt; l_inpRolesLen; roleItr++) { l_role = String(inpRoles.get(roleItr).get(&quot;roleName&quot;)); //if(l_role==&quot;Administrator&quot; || l_role==&quot;ADMIN-ALL GEOGRAPHY-ALL&quot;) if (l_role == &quot;ADMIN-ALL GEOGRAPHY-ALL&quot;) { var tempAP1 = [&quot;PricePlan&quot;, &quot;All Geography&quot;, &quot;All Geography&quot;, &quot;All Product&quot;, &quot;All Product&quot;, true, &quot;Level1&quot;, null, &quot;&quot;, &quot;&quot;]; var tempAP2 = [&quot;PricePlan&quot;, &quot;All Geography&quot;, &quot;All Geography&quot;, &quot;All Product&quot;, &quot;All Product&quot;, true, &quot;Level2&quot;, null, &quot;&quot;, &quot;&quot;]; var tempAP3 = [&quot;PricePlan&quot;, &quot;All Geography&quot;, &quot;All Geography&quot;, &quot;All Product&quot;, &quot;All Product&quot;, true, &quot;Level3&quot;, null, &quot;&quot;, &quot;&quot;]; tempAP1[8] = tempAP2[8] = tempAP3[8] = l_role; addRuleName(tempAP1, l_role); addRuleName(tempAP2, l_role); addRuleName(tempAP3, l_role); ruleSetData.push(tempAP1); ruleSetData.push(tempAP2); ruleSetData.push(tempAP3); createApprover(tempAP3[9], l_role); continue; } var l_roleSplitArr = l_role.split(&quot;-&quot;); var l_cust = l_roleSplitArr[0]; if (l_cust == &quot;AP1&quot; || l_cust == &quot;AP2&quot; || l_cust == &quot;AP3&quot;) { var geographyArr = l_roleSplitArr[1].split(&quot;_&quot;); var productArr = l_roleSplitArr[2].split(&quot;_&quot;); var geographyArrLen = geographyArr.length; var productArrLen = productArr.length; var l_ruleName; for (var geoItr = 0; geoItr &lt; geographyArrLen; geoItr++) { var CreatorMatrixEntry = [&quot;PricePlan&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, true, &quot;&quot;, null, &quot;&quot;, &quot;&quot;]; CreatorMatrixEntry[8] = l_role; addLevel(CreatorMatrixEntry, l_cust); addRuleName(CreatorMatrixEntry, l_role); l_ruleName = CreatorMatrixEntry[9]; var geog = geographyArr[geoItr]; addGeography(CreatorMatrixEntry, geog); for (var prodItr = 0; prodItr &lt; productArrLen; prodItr++) { var finalCreatorMatrixEntry = JSON.parse(JSON.stringify(CreatorMatrixEntry)); var prod = productArr[prodItr]; addProduct(finalCreatorMatrixEntry, prod); ruleSetData.push(finalCreatorMatrixEntry); } } println(&quot;Creating Approver Ruleset&quot;); createApprover(l_ruleName, l_role); } } CreatorMatrix_DT.get(&quot;DecisionTableInfo&quot;).put(&quot;Data&quot;, ruleSetData); } catch (err) { println('Failed to delete Ruleset ' + err); } } function createApprover(p_ruleName, p_RoleName) { try { var isDeletedRuleSet = deleteDeleteRuleSet(p_ruleName); if (isDeletedRuleSet) { var conditionalRuleSet = BRMSConnector.createRuleSet(p_ruleName, p_ruleName, &quot;Decision Table&quot;, &quot;CWF_DOA_Template&quot;); var approver = fetchApproverRules(p_RoleName); println(&quot;Approver&quot; + approver); println(conditionalRuleSet.toString()); //var ruleSetData = JSON.parse(conditionalRuleSet.get(&quot;DecisionTableInfo&quot;).get(&quot;Data&quot;)); //conditionalRuleSet.get(&quot;DecisionTableInfo&quot;).get(&quot;Data&quot;).push(JSON.parse(approver)); conditionalRuleSet.get(&quot;DecisionTableInfo&quot;).put(&quot;Data&quot;, JSON.parse(approver)); conditionalRuleSet.put(&quot;Content&quot;, null); println(conditionalRuleSet.toString()); var conditionalRuleSetObj = new com.vistaar.rules.dataObjects.RuleSet(conditionalRuleSet.toString()); BRMSConnector.saveRuleSet(conditionalRuleSetObj); BRMSConnector.addRuleSet(&quot;DOA_ApproverMatrix_RB&quot;, p_ruleName); } } catch (err) { println('Failed to delete Ruleset ' + err); } } function deleteDeleteRuleSet(p_ruleName) { try { var arr = []; arr.push(p_ruleName); BRMSConnector.deleteRuleSets(arr); return true; } catch (err) { println('Failed to delete Ruleset ' + err); return false; } } function fetchApproverRules(p_RoleName) { try { var AP1 = '[[&quot;Level1&quot;,&quot;ROLENAME&quot;,null,null,null,null,null,null,null,null,null,null,null,null,&quot;ROLENAME&quot;]]'; var AP2 = '[[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_FOB, this.Parent[this.Channels].MIN_NET_FOB_GUIDLINE, this.Parent[this.Channels].MIN_FOB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_FOB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Priceline NET FOB is below Min FOB guidance&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_GUIDLINE, this.Parent.Parent[this.Channels].AVG_FOB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Avg. full year Net FOB at Pricecat level is below Avg FOB guidance&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_PREVIOUS_YEAR_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_VS_PRIOR_YEAR_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_VS_PRIOR_YEAR_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Avg. full year Net FOB at Pricecat level is below Last Year&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_List_ATAX, this.Parent[this.Channels].MIN_NET_LIST_GUIDLINE, this.Parent[this.Channels].MIN_NETLIST_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_NETLIST_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 NET List is below Min Net List guidance.&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_FOB, this.Parent.Parent[this.Channels].MinCurrentNetFOB, this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_FOB_THRESHOLD\\\\&quot;].UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_FOB_THRESHOLD\\\\&quot;][\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Proposed priceline is deeper (NET FOB) than any current.&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_List_ATAX, this.Parent.Parent[this.Channels].MinCurrentNetList, this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_NETLIST_THRESHOLD\\\\&quot;].UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_NETLIST_THRESHOLD\\\\&quot;][\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Proposed priceline is deeper Net List than any current.&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.RAB, this.Parent[this.Channels].MIN_RAB_GUIDLINE, this.Parent[this.Channels].MIN_RAB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_RAB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Priceline RAB is below guidance&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_CURRENT_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_DECREASE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_DECREASE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Current FOB comparison&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Summary\\\\&quot; &amp;&amp; this.isPermissionCheckOnly&quot;, &quot;==&quot;, &quot;true&quot;, null, null, null, null, null, null, null, null, null, &quot;By Pass Threshold&quot;]]'; var AP3 = '[[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_FOB, this.Parent[this.Channels].MIN_NET_FOB_GUIDLINE, this.Parent[this.Channels].MIN_FOB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_FOB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Priceline NET FOB is below Min FOB guidance&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_GUIDLINE, this.Parent.Parent[this.Channels].AVG_FOB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Avg. full year Net FOB at Pricecat level is below Avg FOB guidance&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_PREVIOUS_YEAR_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_VS_PRIOR_YEAR_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_VS_PRIOR_YEAR_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Avg. full year Net FOB at Pricecat level is below Last Year&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_List_ATAX, this.Parent[this.Channels].MIN_NET_LIST_GUIDLINE, this.Parent[this.Channels].MIN_NETLIST_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_NETLIST_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 NET List is below Min Net List guidance.&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_FOB, this.Parent.Parent[this.Channels].MinCurrentNetFOB, this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_FOB_THRESHOLD\\\\&quot;].UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_FOB_THRESHOLD\\\\&quot;][\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Proposed priceline is deeper (NET FOB) than any current.&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_List_ATAX, this.Parent.Parent[this.Channels].MinCurrentNetList, this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_NETLIST_THRESHOLD\\\\&quot;].UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_NETLIST_THRESHOLD\\\\&quot;][\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Proposed priceline is deeper Net List.&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.RAB, this.Parent[this.Channels].MIN_RAB_GUIDLINE, this.Parent[this.Channels].MIN_RAB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_RAB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Priceline RAB is below guidance&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_CURRENT_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_DECREASE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_DECREASE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Current FOB comparison&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Summary\\\\&quot; &amp;&amp; this.isPermissionCheckOnly&quot;, &quot;==&quot;, &quot;true&quot;, null, null, null, null, null, null, null, null, null, &quot;By Pass Threshold&quot;]]'; var l_Admin = '[[&quot;Level1&quot;,&quot;ROLENAME&quot;,null,null,null,null,null,null,null,null,null,null,null,null,&quot;ROLENAME&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_FOB, this.Parent[this.Channels].MIN_NET_FOB_GUIDLINE, this.Parent[this.Channels].MIN_FOB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_FOB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Priceline NET FOB is below Min FOB guidance&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_GUIDLINE, this.Parent.Parent[this.Channels].AVG_FOB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Avg. full year Net FOB at Pricecat level is below Avg FOB guidance&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_PREVIOUS_YEAR_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_VS_PRIOR_YEAR_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_VS_PRIOR_YEAR_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Avg. full year Net FOB at Pricecat level is below Last Year&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_List_ATAX, this.Parent[this.Channels].MIN_NET_LIST_GUIDLINE, this.Parent[this.Channels].MIN_NETLIST_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_NETLIST_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 NET List is below Min Net List guidance.&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_FOB, this.Parent.Parent[this.Channels].MinCurrentNetFOB, this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_FOB_THRESHOLD\\\\&quot;].UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_FOB_THRESHOLD\\\\&quot;][\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Proposed priceline is deeper (NET FOB) than any current.&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_List_ATAX, this.Parent.Parent[this.Channels].MinCurrentNetList, this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_NETLIST_THRESHOLD\\\\&quot;].UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_NETLIST_THRESHOLD\\\\&quot;][\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Proposed priceline is deeper (NET FOB or Net List) than any current First condition.&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.RAB, this.Parent[this.Channels].MIN_RAB_GUIDLINE, this.Parent[this.Channels].MIN_RAB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_RAB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Priceline RAB is below guidance&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_CURRENT_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_DECREASE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_DECREASE_THRESHOLD[\\\\&quot;Level 2\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level2 Current FOB comparison&quot;],[&quot;Level2&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Summary\\\\&quot; &amp;&amp; this.isPermissionCheckOnly&quot;, &quot;==&quot;, &quot;true&quot;, null, null, null, null, null, null, null, null, null, &quot;By Pass Threshold&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_FOB, this.Parent[this.Channels].MIN_NET_FOB_GUIDLINE, this.Parent[this.Channels].MIN_FOB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_FOB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Priceline NET FOB is below Min FOB guidance&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_GUIDLINE, this.Parent.Parent[this.Channels].AVG_FOB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Avg. full year Net FOB at Pricecat level is below Avg FOB guidance&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_PREVIOUS_YEAR_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_VS_PRIOR_YEAR_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_VS_PRIOR_YEAR_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Avg. full year Net FOB at Pricecat level is below Last Year&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_List_ATAX, this.Parent[this.Channels].MIN_NET_LIST_GUIDLINE, this.Parent[this.Channels].MIN_NETLIST_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_NETLIST_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 NET List is below then Min Net List guidance.&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_FOB, this.Parent.Parent[this.Channels].MinCurrentNetFOB, this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_FOB_THRESHOLD\\\\&quot;].UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_FOB_THRESHOLD\\\\&quot;][\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Proposed priceline is deeper (NET FOB) than any current.&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.Net_List_ATAX, this.Parent.Parent[this.Channels].MinCurrentNetList, this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_NETLIST_THRESHOLD\\\\&quot;].UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels][\\\\&quot;DEEPEST_NETLIST_THRESHOLD\\\\&quot;][\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Proposed priceline is deeper Net List than any current.&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Proposed.RAB, this.Parent[this.Channels].MIN_RAB_GUIDLINE, this.Parent[this.Channels].MIN_RAB_VS_GUIDANCE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent[this.Channels].MIN_RAB_VS_GUIDANCE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Priceline RAB is below guidance&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Deal\\\\&quot; &amp;&amp; getDiffByType(this.Parent.Parent[this.Channels].AVG_FOB_PROPOSED_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_CURRENT_CALCULATED, this.Parent.Parent[this.Channels].AVG_FOB_DECREASE_THRESHOLD.UOM)&quot;, &quot;&gt;=&quot;, &quot;this.Parent.Parent[this.Channels].AVG_FOB_DECREASE_THRESHOLD[\\\\&quot;Level 3\\\\&quot;]&quot;, null, null, null, null, null, null, null, null, null, &quot;Level3 Current FOB comparison&quot;],[&quot;Level3&quot;, &quot;ROLENAME&quot;, &quot;this.Level==\\\\&quot;Summary\\\\&quot; &amp;&amp; this.isPermissionCheckOnly&quot;, &quot;==&quot;, &quot;true&quot;, null, null, null, null, null, null, null, null, null, &quot;By Pass Threshold&quot;]]'; var l_roleSplitArr = p_RoleName.split(&quot;-&quot;); var l_cust = l_roleSplitArr[0]; if (l_cust == &quot;AP3&quot;) { var regRoleName = RegExp(/ROLENAME/g); AP3 = AP3.replace(regRoleName, p_RoleName); return AP3; } else if (l_cust == &quot;AP2&quot;) { var regRoleName = RegExp(/ROLENAME/g); AP2 = AP2.replace(regRoleName, p_RoleName); return AP2; } else if (l_cust == &quot;AP1&quot;) { var regRoleName = RegExp(/ROLENAME/g); AP1 = AP1.replace(regRoleName, p_RoleName); return AP1; } else if (l_cust == &quot;ADMIN&quot; || l_cust == &quot;Administrator&quot;) { var regRoleName = RegExp(/ROLENAME/g); l_Admin = l_Admin.replace(regRoleName, p_RoleName); return l_Admin; } } catch (err) { println('Failed to delete Ruleset ' + err); } } function addGeography(CreatorMatrixEntry, geog) { if (geog == &quot;ALL GEOGRAPHY&quot;) { CreatorMatrixEntry[1] = &quot;All Geography&quot;; CreatorMatrixEntry[2] = &quot;All Geography&quot;; } else if (geog.charAt(0) == &quot;S&quot;) { CreatorMatrixEntry[1] = &quot;State&quot;; CreatorMatrixEntry[2] = geog; } else if (geog.charAt(0) == &quot;R&quot;) { CreatorMatrixEntry[1] = &quot;Region&quot;; CreatorMatrixEntry[2] = geog; } else { throw &quot;GEOGRAPHY LEVEL is not supported&quot;; } } function addProduct(CreatorMatrixEntry, prod) { if (prod == &quot;ALL&quot;) { CreatorMatrixEntry[3] = &quot;All Product&quot;; CreatorMatrixEntry[4] = &quot;All Product&quot;; } else { CreatorMatrixEntry[3] = &quot;Business Unit&quot;; CreatorMatrixEntry[4] = prod; } } function addLevel(CreatorMatrixEntry, l_cust) { if (l_cust == &quot;AP1&quot;) { CreatorMatrixEntry[6] = &quot;Level1&quot;; } else if (l_cust == &quot;AP2&quot;) { CreatorMatrixEntry[6] = &quot;Level2&quot;; } else { CreatorMatrixEntry[6] = &quot;Level3&quot;; } } function addRuleName(CreatorMatrixEntry, l_role) { var rgUnderscoe = RegExp(/-/g); var l_rulename = l_role.replace(rgUnderscoe, &quot;_&quot;); l_rulename = l_rulename.replace(&quot;Geography&quot;, &quot;Geo&quot;); CreatorMatrixEntry[9] = l_rulename + &quot;_Ruleset&quot;; } × Search results Close "},"CreatorMatrix.js.html":{"id":"CreatorMatrix.js.html","title":"Source: CreatorMatrix.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: CreatorMatrix.js /** * @fileOverview This files contain Creator Matrix functions for BRMS Creator deployment * @author anadar * @version 1.0.0 */ /** * @module CreatorMatrix */ importPackage(com.vistaar.docserver.util); importPackage(org.json); importPackage(java.lang); var inpRoles= new org.json.JSONArray(docServerManager.getAllRolesDetails()); var BRMSConnector = VistaarJSUtils.getBRMSConnector(userConnInfo); var CreatorMatrix = &quot;CWF_CreatorMatrix_DT&quot;; var creatorRuleSetObject = BRMSConnector.loadRuleSet(CreatorMatrix); var creatorRuleSetObjectJSON = new org.json.JSONObject(creatorRuleSetObject.toString()); creatorRuleSetObjectJSON.get(&quot;DecisionTableInfo&quot;).put(&quot;Data&quot;,[]); addToCreatorMatrix(inpRoles,creatorRuleSetObjectJSON); var CreatorMatrixRuleSet=new com.vistaar.rules.dataObjects.RuleSet(creatorRuleSetObjectJSON.toString()); BRMSConnector.saveRuleSet(CreatorMatrixRuleSet); var retVal = BRMSConnector.registerRules(&quot;DOA_CreatorMatrix_RB&quot;, 1 , true); output=&quot;success&quot;; function addToCreatorMatrix(inpRoles,CreatorMatrix_DT) { try{ var ruleSetData = JSON.parse(CreatorMatrix_DT.get(&quot;DecisionTableInfo&quot;).get(&quot;Data&quot;)); var l_inpRolesLen=inpRoles.length(); var l_role=null; for(var roleItr=0;roleItr &lt; l_inpRolesLen;roleItr++) { l_role=String(inpRoles.get(roleItr).get(&quot;roleName&quot;)); if(l_role==&quot;Administrator&quot; || l_role==&quot;ADMIN-ALL GEOGRAPHY-ALL&quot;) { var tmpArr=[&quot;PricePlan&quot;,&quot;All Geography&quot;,&quot;All Geography&quot;,&quot;All Product&quot;,&quot;All Product&quot;,false,null,null,&quot;&quot;,null]; tmpArr[8]=l_role; ruleSetData.push(tmpArr); continue; } var l_roleSplitArr=l_role.split(&quot;-&quot;); var l_cust=l_roleSplitArr[0]; if(l_cust==&quot;AP1&quot; || l_cust==&quot;AP2&quot; || l_cust==&quot;CR&quot; || l_cust==&quot;CRNR&quot; || l_cust==&quot;CRSD&quot;) { var geographyArr=l_roleSplitArr[1].split(&quot;_&quot;); var productArr=l_roleSplitArr[2].split(&quot;_&quot;); var geographyArrLen=geographyArr.length; var productArrLen=productArr.length; for(var geoItr=0;geoItr &lt; geographyArrLen;geoItr++) { var CreatorMatrixEntry=[&quot;PricePlan&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,false,null,null,&quot;&quot;,null]; CreatorMatrixEntry[8]=l_role; var geog=geographyArr[geoItr]; addGeography(CreatorMatrixEntry,geog); for(var prodItr=0;prodItr&lt;productArrLen;prodItr++) { var finalCreatorMatrixEntry=JSON.parse(JSON.stringify(CreatorMatrixEntry)); var prod=productArr[prodItr]; addProduct(finalCreatorMatrixEntry,prod); ruleSetData.push(finalCreatorMatrixEntry); } } } } CreatorMatrix_DT.get(&quot;DecisionTableInfo&quot;).put(&quot;Data&quot;,ruleSetData); }catch(err){ println('Error while adding user roles ' + err); } } function addGeography(CreatorMatrixEntry,geog) { if(geog==&quot;ALL GEOGRAPHY&quot;) { CreatorMatrixEntry[1]=&quot;All Geography&quot;; CreatorMatrixEntry[2]=&quot;All Geography&quot;; } else if(geog.charAt(0)==&quot;S&quot;) { CreatorMatrixEntry[1]=&quot;State&quot;; CreatorMatrixEntry[2]=geog; } else if(geog.charAt(0)==&quot;R&quot;) { CreatorMatrixEntry[1]=&quot;Region&quot;; CreatorMatrixEntry[2]=geog; }else{ throw &quot;GEOGRAPHY LEVEL is not supported&quot;; } } function addProduct(CreatorMatrixEntry,prod) { if(prod==&quot;ALL&quot;) { CreatorMatrixEntry[3]=&quot;All Product&quot;; CreatorMatrixEntry[4]=&quot;All Product&quot;; } else { CreatorMatrixEntry[3]=&quot;Business Unit&quot;; CreatorMatrixEntry[4]=prod; } } × Search results Close "},"ExportPricePlan.js.html":{"id":"ExportPricePlan.js.html","title":"Source: ExportPricePlan.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: ExportPricePlan.js /******************************************************************************** This work contains or references Vistaar generic components or Vistaar API, and is developed in accordance with Vistaar best practices and solution development guidelines. This work is designed and intended to be used only with licensed Vistaar software. ********************************************************************************/ /** * @fileOverview This files contain module Export Price Plan to export Price Plan in pdf and Excel Format. * It fetches Price Plan using scope data from the UI and then builds report using Jasper report and returns to the UI * @author anadar * @version 1.0.0 */ importPackage (java.lang) importPackage (java.io) importPackage (java.util) //global Export Price Plan Object var g_ExportPricePlan; //Object factory for Export Price Plan function getExportPricePlan() { if (g_ExportPricePlan == undefined) { g_ExportPricePlan = new ExportPricePlan(); } return g_ExportPricePlan; } //Export Price Plan Module /** @class */ function ExportPricePlan(){ //function module attributes/properties /**@type object*/ var m_scopeData; //hold price plan scope /**@type object*/ var m_exportConfig; //hold export Config from UI /**@type object*/ var m_pricePlan; //hold fetched price plan /**@type object*/ var m_docServerManager; /**@type object*/ var m_userConnInfo; /**@type object*/ var m_exportData; var m_Row = '{&quot;Grid Type&quot;: &quot;&quot;, &quot;Deleted Deal&quot;: &quot;&quot;, &quot;4MTHS&quot;: &quot;&quot;, &quot;Shelf&quot;: &quot;&quot;, &quot;NetFOB&quot;: &quot;&quot;, &quot;Deleted Time&quot;: &quot;&quot;, &quot;NetList&quot;: &quot;&quot;, &quot;Sep&quot;: &quot;&quot;, &quot;Feb&quot;: &quot;&quot;, &quot;YTD&quot;: &quot;&quot;, &quot;Mar&quot;: &quot;&quot;, &quot;rowtype&quot;: &quot;&quot;, &quot;EditableFrom&quot;: &quot;&quot;, &quot;Oct&quot;: &quot;&quot;, &quot;Qualifier&quot;: &quot;&quot;, &quot;FYvsPY&quot;: &quot;&quot;, &quot;Nov&quot;: &quot;&quot;, &quot;expanded&quot;: &quot;&quot;, &quot;leaf&quot;: &quot;&quot;, &quot;MetricsType&quot;: &quot;&quot;, &quot;Aug&quot;: &quot;&quot;, &quot;SKU Excluded&quot;: &quot;&quot;,&quot;Customer Included&quot; : &quot;&quot;,&quot;FY&quot;: &quot;&quot;, &quot;Apr&quot;: &quot;&quot;, &quot;Jan&quot;: &quot;&quot;, &quot;May&quot;: &quot;&quot;, &quot;Dec&quot;: &quot;&quot;, &quot;Jul&quot;: &quot;&quot;, &quot;DealID&quot;: &quot;&quot;, &quot;DealName&quot;: &quot;&quot;, &quot;Jun&quot;: &quot;&quot;, &quot;Metrics&quot;: &quot;&quot;, &quot;PY&quot;: &quot;&quot;, &quot;Distributor Excluded&quot;: &quot;&quot;}'; /** * InitModule * @param {object} p_inputContext The input Context to init the Export Price Plan this contains 'Scope Data', 'Export Config', 'Export Type', 'DocServer' and 'UserInfo' */ //Initialize module attributes/properties this.initModule = function(p_inputContext){ println('Export Price Plan: initModule' + p_inputContext); this.m_scopeData = p_inputContext.get('scopeData'); this.m_exportConfig = p_inputContext.get('exportConfig'); this.m_exportType = p_inputContext.get('exportType'); this.m_docServerManager = p_inputContext.get('DocServer'); this.m_userConnInfo = p_inputContext.get('UserInfo'); this.m_exportData = new org.json.JSONArray(); }; //Entity script call this function with the input context /** * It returns the final report to the Front End * @param {object} p_inputContext Input Context * @return {object} Report either excel/pdf */ this.getReport = function(p_inputContext){ return this.BuildReportDataFromUI(p_inputContext); /*this.initModule(p_inputContext); this.fetchPricePlan(); this.BuildObjectForReport(); return this.BuildReport(this.m_exportData);*/ } //Fetch Price Plan /** * To fetch Price Plan data using the scope */ this.fetchPricePlan = function(){ println('Export Price Plan' + this.m_scopeData); /* Form Script Input to call VPEntry Point */ var l_ScriptInput = new org.json.JSONObject(); var l_VPInput = new org.json.JSONObject(); l_ScriptInput.put('ModuleName','VolumePlanner'); l_ScriptInput.put('Operation','openWithScope'); l_VPInput.put('ScopeData',this.m_scopeData); l_ScriptInput.put('Input',l_VPInput); var inputJSON = l_ScriptInput.toString(); println('Export Price Plan: In fetch Price Plan' + inputJSON); try{ //Call VPEntry Point script var l_scriptOutput = vistaar.BevAlModule.VPModule_Entry.executeOperation(inputJSON, this.m_docServerManager, this.m_userConnInfo); println('Export Price Plan ' + l_scriptOutput) var jsOutput = l_scriptOutput; println('\\n\\nJS Output' + jsOutput.toString()); if(jsOutput.get(&quot;solStatus&quot;)=='success'){ this.m_pricePlan = jsOutput.get(&quot;solResponse&quot;); println('Print output' + jsOutput.toString()); } println('\\n\\nExport Price Plan: Fetched Price Plan' + this.m_pricePlan); }catch(e){ println('Export Price Plan failed to fetch price plan'+e); } }; /** * Thde data that has been fetch with fetchPrice Plan is formatted in this function * */ this.BuildObjectForReport = function(){ var l_Summary; var l_OFF; var l_ON; l_Summary = this.m_pricePlan.get(&quot;Price Plan&quot;).get(&quot;Summary&quot;); println('\\n\\nExport Price Plan: Summary ' + l_Summary.toString() ); for (var itr = 0; itr &lt; l_Summary.length(); itr++) { var currentRecord = l_Summary.get(itr); println('\\nExport Price Plan this.Row:' + m_Row); var l_Row = new org.json.JSONObject(m_Row); l_Row.put(&quot;Grid Type&quot;,&quot;Summary&quot;); for (var colkeys = l_Row.keys(); colkeys.hasNext(); ) { var ColumnKey = colkeys.next(); if(currentRecord.has(ColumnKey)){ var ColumnValue = currentRecord.get(ColumnKey); l_Row.put(ColumnKey,ColumnValue); } } println('Export Price Plan: current Record after put ' + currentRecord.toString() ); this.m_exportData.put(l_Row); } l_OFF = this.m_pricePlan.get(&quot;OFF&quot;).get(&quot;Current&quot;).get(&quot;children&quot;); if(l_OFF != undefined){ for (var itr = 0; itr &lt; l_OFF.length(); itr++) { var currentRecord = l_OFF.get(itr); var l_Row = new org.json.JSONObject(m_Row); l_Row.put(&quot;Grid Type&quot;,&quot;OFF&quot;); for (var colkeys = l_Row.keys(); colkeys.hasNext(); ) { var ColumnKey = colkeys.next(); if(currentRecord.has(ColumnKey)){ var ColumnValue = currentRecord.get(ColumnKey); l_Row.put(ColumnKey,ColumnValue); } } // currentRecord.put(&quot;Grid Type&quot;,&quot;OFF&quot;); // if(currentRecord.has(&quot;children&quot;)){ // currentRecord.remove(&quot;children&quot;); // } this.m_exportData.put(l_Row); } } l_ON = this.m_pricePlan.get(&quot;ON&quot;).get(&quot;Current&quot;).get(&quot;children&quot;); if(l_OFF != undefined){ for (var itr = 0; itr &lt; l_ON.length(); itr++) { var currentRecord = l_ON.get(itr); var l_Row = new org.json.JSONObject(m_Row); l_Row.put(&quot;Grid Type&quot;,&quot;ON&quot;); for (var colkeys = l_Row.keys(); colkeys.hasNext(); ) { var ColumnKey = colkeys.next(); if(currentRecord.has(ColumnKey)){ var ColumnValue = currentRecord.get(ColumnKey); l_Row.put(ColumnKey,ColumnValue); } } // currentRecord.put(&quot;Grid Type&quot;,&quot;ON&quot;); // if(currentRecord.has(&quot;children&quot;)){ // currentRecord.remove(&quot;children&quot;); // } this.m_exportData.put(l_Row); } } } /** * The data from front is converted to Report in this function * @param {Object} p_inputContext Input Constext from the front end */ this.BuildReportDataFromUI = function(p_inputContext){ var l_reportParameter = p_inputContext.get('reportParameter'); var l_exportType = p_inputContext.get('exportType'); var l_exportData = p_inputContext.get('exportData'); try { println(&quot;In BuildReport Data from UI Now&quot;); var ESPath = SolutionProperties.getPropertyValue(&quot;EntityServiceRunningAt&quot;); var exportType = l_exportType; //var compiledReportNamePath = new java.lang.String('/home/gallo_dev2/Vistaar3_11_5/WorkflowEntity/WorkflowEntityService/WebDeploy/WebUI/Gallo/Report/PricePlan.jasper'); var compiledReportNamePath = new java.lang.String(ESPath +'/WebDeploy/WebUI/Gallo/Report/PricePlan.jasper'); var reportJsonData =new java.lang.String(this.getCSVData(l_exportData)); var exportFileNameAndPath = new java.lang.String(' '); var reportParameters = new java.util.HashMap(); for (var keys = l_reportParameter.keys(); keys.hasNext(); ) { var ColumnKey = keys.next(); var ColumnValue = l_reportParameter.get(ColumnKey); reportParameters.put(ColumnKey,ColumnValue); } //reportParameters.put(&quot;Image-Path&quot;, &quot;/home/gallo_dev2/Vistaar3_11_5/WorkflowEntity/WorkflowEntityService/WebDeploy/WebUI/Gallo/BR1/resources/images&quot;); reportParameters.put(&quot;Image-Path&quot;, ESPath +&quot;/WebDeploy/WebUI/Gallo/BR1/resources/images&quot;); //reportParameters.put(&quot;Footer&quot;, &quot;&quot;); //reportParameters.put(&quot;Footer_copyright&quot;, &quot;&quot; ); println(&quot;Actual Time taken by Jasper Report execution Started @ &quot;); var jasperReportUtilObj = new com.vistaar.JasperReportUtility.reports.JasperReportUtility(); println(&quot;Object is :&quot;+ jasperReportUtilObj.toString()); var returnByteArrayPDF = jasperReportUtilObj.exportBinaryArrayOneReport(exportType,&quot;&quot;,compiledReportNamePath,reportJsonData,reportParameters); println(&quot;Actual Time taken by Jasper Report execution ended @ &quot;); println(&quot;Return Object Length : &quot; + returnByteArrayPDF.length); return returnByteArrayPDF; } catch(err){ println(&quot;Error in ExportReport &quot; + err); } }; //Build Price Plan Report with Jasper /** * It builds report by fetching CSV data and the jasper files * @param {object} pValue Json object of the report data * @example * var returnByteArrayPDF = jasperReportUtilObj.exportBinaryArrayOneReport(exportType,compiledReportNamePath,reportJsonData,reportParameters); */ this.BuildReport = function(pValue){ try { println(&quot;In BuildReport Now&quot;); //println(&quot;pValue : &quot; + pValue.toString()) //var paramVal = pValue.get(&quot;Param&quot;).get(0); //println(&quot;paramVal : &quot; + paramVal.toString()) var exportType = &quot;pdf&quot; // paramVal.get(&quot;exportType&quot;); var compiledReportNamePath = new java.lang.String('/home/gallo_dev2/Vistaar3_11_5/WorkflowEntity/WorkflowEntityService/WebDeploy/WebUI/Gallo/Report/PricePlan.jasper'); var reportJsonData =new java.lang.String(this.getCSVData(pValue)); var exportFileNameAndPath = new java.lang.String(' '); var reportParameters = new java.util.HashMap(); reportParameters.put(&quot;Scope&quot;, &quot;Test Scope&quot;); reportParameters.put(&quot;Image-Path&quot;, &quot;/home/gallo_dev2/Vistaar3_11_5/WorkflowEntity/WorkflowEntityService/WebDeploy/WebUI/Gallo/BR1/resources/images&quot;); //reportParameters.put(&quot;Footer&quot;, &quot;&quot;); //reportParameters.put(&quot;Footer_copyright&quot;, &quot;&quot; ); println(&quot;Actual Time taken by Jasper Report execution Started @ &quot;); var jasperReportUtilObj = new com.vistaar.JasperReportUtility.reports.JasperReportUtility(); println(&quot;Object is :&quot;+ jasperReportUtilObj.toString()); var returnByteArrayPDF = jasperReportUtilObj.exportBinaryArrayOneReport(exportType,compiledReportNamePath,reportJsonData,reportParameters); println(&quot;Actual Time taken by Jasper Report execution ended @ &quot;); println(&quot;Return Object Length : &quot; + returnByteArrayPDF.length); return returnByteArrayPDF; } catch(err){ println(&quot;Error in ExportReport &quot; + err); } } /** * Converts Json to CSV * @param {object} dataNode JSON object to convert * @return {string} Converted CSV data */ this.getCSVData = function(dataNode){ // var functionName = &quot;ExportManager.getCSVData&quot;; // var logger = new SimpleLogger(functionName, BaseTPMConstants.LOG_LEVEL_TEMP_DEBUG); try{ // logger.tempDebug(&quot;START&quot;); var csvDataStr = &quot;&quot;; for(var dataCount = 0; dataCount &lt; dataNode.length(); dataCount++){ var dataNodeObj = dataNode.get(dataCount); if(dataCount == 0){ var firstRecordValue = &quot;&quot;; for (var keys = dataNodeObj.keys(); keys.hasNext(); ) { var ColumnKey = keys.next(); csvDataStr = csvDataStr + '&quot;' + ColumnKey + '&quot;' + &quot;,&quot;; var ColumnValue = dataNodeObj.get(ColumnKey); firstRecordValue = firstRecordValue + '&quot;' + ColumnValue + '&quot;' + &quot;,&quot;; } // for(var property in dataNodeObj){ // if(dataNodeObj.has(property)){ // csvDataStr = csvDataStr + '&quot;' + property + '&quot;' + &quot;,&quot;; // firstRecordValue = firstRecordValue + '&quot;' + dataNodeObj[property] + '&quot;' + &quot;,&quot;; // } // } var replaceCharPos = csvDataStr.lastIndexOf(&quot;,&quot;); csvDataStr = csvDataStr.substring(0, replaceCharPos); csvDataStr = csvDataStr + &quot;\\r\\n&quot;; var replaceCharValusPos = firstRecordValue.lastIndexOf(&quot;,&quot;); firstRecordValue = firstRecordValue.substring(0, replaceCharValusPos); firstRecordValue = firstRecordValue + &quot;\\r\\n&quot;; //logger.tempDebug(&quot;\\n&quot; + functionName + &quot; - csvDataStr after 1st record columns\\n&quot; + String(csvDataStr)); //logger.tempDebug(&quot;\\n&quot; + functionName + &quot; - firstRecordValue\\n&quot; + String(firstRecordValue)); csvDataStr = csvDataStr + firstRecordValue; //logger.tempDebug(&quot;\\n&quot; + functionName + &quot; - csvDataStr after 1st record values\\n&quot; + csvDataStr); }else{ for (var keys = dataNodeObj.keys(); keys.hasNext(); ) { var ColumnKey = keys.next(); var ColumnValue = dataNodeObj.get(ColumnKey); csvDataStr = csvDataStr + '&quot;' + ColumnValue + '&quot;' + &quot;,&quot;; } // for(var property in dataNodeObj){ // if(dataNodeObj.hasOwnProperty(property)){ // csvDataStr = csvDataStr + '&quot;' + dataNodeObj[property] + '&quot;' + &quot;,&quot;; // } // } var replaceCharValusPos = csvDataStr.lastIndexOf(&quot;,&quot;); csvDataStr = csvDataStr.substring(0, replaceCharValusPos); csvDataStr = csvDataStr + &quot;\\r\\n&quot;; //logger.tempDebug(&quot;\\n&quot; + functionName + &quot; - csvDataStr after other records \\n&quot; + csvDataStr); } } var replaceCharValusPos = csvDataStr.lastIndexOf(&quot;\\r\\n&quot;); csvDataStr = csvDataStr.substring(0, replaceCharValusPos); //csvDataStr = csvDataStr + &quot;\\\\r\\\\n&quot;; //logger.tempDebug(&quot;\\n&quot; + functionName + &quot; - final csvDataStr\\n&quot; + csvDataStr); return csvDataStr; }catch(e){ // logger.error(&quot;Failed to evaluate ExportManager.getCSVData.&quot;); println(&quot;Error in CSV Conversion &quot;+ e) // ERROR.throwErr(functionName,e,&quot;Failed to evaluate ExportManager.getCSVData.&quot;); }finally{ // logger.tempDebug('END'); // logger.close(); } }; } × Search results Close "},"GWF_Normalize.js.html":{"id":"GWF_Normalize.js.html","title":"Source: GWF_Normalize.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: GWF_Normalize.js importPackage(org.json); importPackage(java.lang); importPackage(java.io); importPackage(java.util); /** * @module GWF_Normalize */ /** * GWF_Normalize function to convert the Price Plan document to Normalized structure that will be inputed to BRMS * @function * @memberof module:GWF_Normalize * @param {object} structureObject Price Plan structured object * @param {object} docProvider Document Provider * @param {object} userConnInfo User connection info * @param {Boolean} isPermissionCheckOnly Price Plan Permission check */ function GWF_Normalize(structureObject, docProvider, userConnInfo, isPermissionCheckOnly){ println(&quot;GWF_Normalize Start&quot;); if(isPermissionCheckOnly != undefined){ if(isPermissionCheckOnly == true){ var normalizeResult = '[{&quot;Level&quot; : &quot;Summary&quot;,&quot;Summary&quot; : &quot;Summary&quot;,&quot;isPermissionCheckOnly&quot; : true}]'; return normalizeResult; } } var startTime = new Date(); //CustomeToTemplate var transObj = new transformBADataStructure(); var secondaryKeyMap = new JSONObject(); secondaryKeyMap.put(&quot;Sizes&quot;, &quot;SizeMemberCode&quot;); secondaryKeyMap.put(&quot;Channels&quot;, &quot;ChannelMemberCode&quot;); secondaryKeyMap.put(&quot;TimeLines&quot;, &quot;TimeMemberCode&quot;); secondaryKeyMap.put(&quot;Version&quot;, &quot;VersionMemberCode&quot;); secondaryKeyMap.put(&quot;Exclusions&quot;, &quot;ExclTypeMemberCode&quot;); var structureKeys = new JSONArray(); structureKeys.put(&quot;DealContainer&quot;); structureKeys.put(&quot;PricePlan&quot;); transObj.customToTemplate(structureObject, secondaryKeyMap, structureKeys); var dealContainerJSON = structureObject.get(&quot;DealContainer&quot;); var pricePlanJSON = structureObject.get(&quot;PricePlan&quot;); var ppSizes = pricePlanJSON.get(&quot;Sizes&quot;); var priceStructureJSON = new JSONObject(); priceStructureJSON.put(&quot;Facts_Data&quot;, new JSONObject()); priceStructureJSON.put(&quot;scope&quot;, structureObject.get(&quot;scope&quot;)); //Fetching External Attributes var geographyCode = structureObject.get(&quot;scope&quot;).get(&quot;Geography&quot;); var time = structureObject.get(&quot;scope&quot;).get(&quot;Time&quot;); var productCode = structureObject.get(&quot;scope&quot;).get(&quot;Product&quot;); var inputJSON = new JSONObject(); inputJSON.put(&quot;scope&quot;, new JSONObject()); inputJSON.get(&quot;scope&quot;).put(&quot;Geography Code&quot;, geographyCode); inputJSON.get(&quot;scope&quot;).put(&quot;Product Code&quot;, productCode); inputJSON.get(&quot;scope&quot;).put(&quot;Time&quot;, time); var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### GWF_Normalize Get Call : Execution Time (milliseconds) : &quot; + executionTime); var l_start = new Date(); var l_loadAddOnPSProcessingDataObj = new LoadAddOnPSProcessingData(); //println(&quot;userConnInfo &gt;&gt; &quot; +userConnInfo); l_loadAddOnPSProcessingDataObj.init(inputJSON, docProvider, userConnInfo); var l_endTime = new Date(); var l_executionTime = l_endTime - l_start; println(&quot;#### GWF_Normalize LoadAddOnPSProcessingData Init Call : Execution Time (milliseconds) : &quot; + l_executionTime); var l_start = new Date(); var onYearLevelAttribute = l_loadAddOnPSProcessingDataObj.getGlobalAttributes(); var l_endTime = new Date(); var l_executionTime = l_endTime - l_start; println(&quot;#### GWF_Normalize LoadAddOnPSProcessingData getGlobalAttributes Call : Execution Time (milliseconds) : &quot; + l_executionTime); var startTime = new Date(); getAttributesForYearLvl(onYearLevelAttribute, dealContainerJSON); var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### GWF_Normalize getAttributesForYearLvl Call : Execution Time (milliseconds) : &quot; + executionTime); priceStructureJSON.get(&quot;Facts_Data&quot;).put(&quot;Data&quot;, dealContainerJSON.get(&quot;Data&quot;)); var sizeArr = new JSONArray(); var dcSizes = dealContainerJSON.get(&quot;Sizes&quot;); var startTime = new Date(); //Processing PricePlan JSON to get channel and data information. var channelDealArr = new JSONArray(); var outputArr = new JSONArray(); for(var sz1=0; sz1&lt;ppSizes.length(); sz1++){ for(var ppc=0; ppc&lt;ppSizes.get(sz1).get(&quot;Channels&quot;).length(); ppc++){ var chDealLevel = ppSizes.get(sz1).get(&quot;Channels&quot;).get(ppc).get(&quot;DealLevel&quot;); var channels = ppSizes.get(sz1).get(&quot;Channels&quot;).get(ppc).get(&quot;Channels&quot;); for(var chDeal=0; chDeal&lt;chDealLevel.length(); chDeal++){ var isDealExist = false; chDealLevel.get(chDeal).get(&quot;Data&quot;).put(&quot;Channels&quot;, channels); /* for(var c=0; c&lt;channelDealArr.length(); c++){ var existingDealID = channelDealArr.get(c).get(&quot;Data&quot;).get(&quot;DealID&quot;); var currentDealID = chDealLevel.get(chDeal).get(&quot;Data&quot;).get(&quot;DealID&quot;); if(existingDealID == currentDealID){ channelDealArr.get(c).get(&quot;Data&quot;).put(&quot;Channels&quot;, &quot;ALL&quot;); isDealExist = true; break; } } */ //if(isDealExist == false){ channelDealArr.put(chDealLevel.get(chDeal)); //outputArr.put(chDealLevel.get(chDeal)); outputArr.put(new org.json.JSONObject((chDealLevel.get(chDeal)).toString())); //new JSONObject((channelDealArr.get(chd)).toString()); //} } } } var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### GWF_Normalize First For loop Call : Execution Time (milliseconds) : &quot; + executionTime); var startTime = new Date(); var stime1 =0; var stime2 =0; for(var sz=0; sz&lt;dcSizes.length(); sz++){ var sizeData = dcSizes.get(sz).get(&quot;Data&quot;); var sizes = dcSizes.get(sz).get(&quot;Sizes&quot;); var sizeTimeLines = dcSizes.get(sz).get(&quot;TimeLines&quot;); //Loop over TimeLines var sizeTimeLinesLen = sizeTimeLines.length(); for(var stl=0; stl&lt;sizeTimeLinesLen; stl++){ var sizeTimeMemberCode = sizeTimeLines.get(stl).get(&quot;TimeLines&quot;); var channelArr = new JSONArray(); var timeLineJSON = new JSONObject(); timeLineJSON.put(&quot;TimeLines&quot;, sizeTimeMemberCode); timeLineJSON.put(&quot;Version&quot;, sizeTimeLines.get(stl).get(&quot;Version&quot;)); timeLineJSON.put(&quot;Data&quot;, sizeData); timeLineJSON.put(&quot;DealLevel&quot;, new JSONArray()); timeLineJSON.put(&quot;Size&quot;, sizes); var sizeDealLevel = dcSizes.get(sz).get(&quot;DealLevel&quot;); var sizeDealLeveLen = sizeDealLevel.length(); var index = 0; var outputArrLen = outputArr.length(); for(var chd=0; chd&lt;outputArrLen; chd++){ var dealID = outputArr.get(chd).get(&quot;Data&quot;).get(&quot;DealID&quot;); for(var sdl=0; sdl&lt;sizeDealLeveLen; sdl++){ if(sizeDealLevel.get(sdl).get(&quot;DealLevel&quot;) != &quot;Allocated PG&quot;){ var dealTimeLines = sizeDealLevel.get(sdl).get(&quot;TimeLines&quot;); var dealData = sizeDealLevel.get(sdl).get(&quot;Data&quot;); if (dealData.has(&quot;IsDeleted&quot;) &amp;&amp; !dealData.isNull(&quot;IsDeleted&quot;) &amp;&amp; dealData.get(&quot;IsDeleted&quot;) == true) //ET588 { println(&quot;skiped deal ID &quot;+dealID); continue; } if(dealData.get(&quot;DealID&quot;) == dealID){ var channelValue = outputArr.get(chd).get(&quot;Data&quot;).get(&quot;Channels&quot;); sizeDealLevel.get(sdl).get(&quot;Data&quot;).put(&quot;Channels&quot;, channelValue); var dataValue = sizeDealLevel.get(sdl).get(&quot;Data&quot;); var timeLineValue = sizeDealLevel.get(sdl).get(&quot;TimeLines&quot;); channelDealArr.get(chd).put(&quot;Data&quot;, dataValue); channelDealArr.get(chd).put(&quot;TimeLines&quot;, timeLineValue); var verArr = outputArr.get(chd).get(&quot;Version&quot;); for(var v=0; v&lt;verArr.length(); v++){ verArr.get(v).put(&quot;Data&quot;, new JSONObject()); if(verArr.get(v).get(&quot;Version&quot;) == &quot;Proposed&quot;){ var verTimelineArr = verArr.get(v).get(&quot;TimeLines&quot;); var starttime1 = new Date(); for(var vt=0; vt&lt;verTimelineArr.length(); vt++){ var channelTimeline = verTimelineArr.get(vt).get(&quot;TimeLines&quot;); if(sizeTimeMemberCode == channelTimeline){ var dealMixPerc = verTimelineArr.get(vt).get(&quot;Data&quot;).get(&quot;Deal_Mix_PERC&quot;); channelDealArr.get(chd).get(&quot;Data&quot;).put(&quot;Deal_Mix_PERC&quot;, dealMixPerc); } } var endtime1 = new Date(); var tTime1 = ((endtime1 - starttime1)/1000); stime1 += tTime1; } } var starttime2 = new Date(); //var strChannelDealArr = (channelDealArr.get(chd)).toString(); for(var dtl=0; dtl&lt;dealTimeLines.length(); dtl++){ var dealTimeMemberCode = dealTimeLines.get(dtl).get(&quot;TimeLines&quot;); if(sizeTimeMemberCode == dealTimeMemberCode){ //var channelDealObj = new JSONObject(channelDealArr.get(chd), JSONObject.getNames(channelDealArr.get(chd))); var channelDealObj = new JSONObject((channelDealArr.get(chd)).toString()); timeLineJSON.get(&quot;DealLevel&quot;).put(channelDealObj); break; } } var endtime2 = new Date(); var tTime2 = ((endtime2 - starttime2)/1000); stime2 += tTime2; break; } } } } sizeArr.put(timeLineJSON); } } var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### GWF_Normalize Second For loop Call : stime1 : &quot; + stime1); println(&quot;#### GWF_Normalize Second For loop Call : stime2 : &quot; + stime2); println(&quot;#### GWF_Normalize Second For loop Call : Execution Time (milliseconds) : &quot; + executionTime); /* var fileToWrite = new File(&quot;/home/cloud_es1/nshetye/workflow/sizeArr.json&quot;); var FW = new FileWriter(fileToWrite); FW.write(sizeArr); FW.close(); */ var startTime = new Date(); priceStructureJSON.get(&quot;Facts_Data&quot;).put(&quot;Size&quot;, sizeArr); priceStructureJSON.get(&quot;Facts_Data&quot;).put(&quot;Version&quot;, new JSONArray()); //Creating Fact Version arr. var factsVersionJSON = new JSONObject(); factsVersionJSON.put(&quot;Data&quot;, new JSONObject()); factsVersionJSON.put(&quot;Version&quot;, &quot;Current&quot;); priceStructureJSON.get(&quot;Facts_Data&quot;).get(&quot;Version&quot;).put(factsVersionJSON); var factsVersionJSON = new JSONObject(); factsVersionJSON.put(&quot;Data&quot;, new JSONObject()); factsVersionJSON.put(&quot;Version&quot;, &quot;Proposed&quot;); priceStructureJSON.get(&quot;Facts_Data&quot;).get(&quot;Version&quot;).put(factsVersionJSON); priceStructureJSON.get(&quot;Facts_Data&quot;).get(&quot;Data&quot;).put(&quot;isPermissionCheckOnly&quot;, isPermissionCheckOnly); //Altering PriceStructureJSON var psFacts = priceStructureJSON.get(&quot;Facts_Data&quot;); var psSize = new JSONArray((psFacts.get(&quot;Size&quot;)).toString()); var psLength = psSize.length(); var minNetFOB=&quot;&quot;, minNetList=&quot;&quot;; var totalRAB=0, totalNetFOB=0, dealCount=0; var channelJSON = new JSONArray(); channelJSON.put(&quot;ON&quot;);channelJSON.put(&quot;OFF&quot;); var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### GWF_Normalize JSON Edit Call : Execution Time (milliseconds) : &quot; + executionTime); var startTime = new Date(); for(var ch=0; ch&lt;channelJSON.length(); ch++){ for(var ps=0; ps &lt; psLength; ps++){ //External Attribute Call var timeline = psSize.get(ps).get(&quot;TimeLines&quot;); var size = psSize.get(ps).get(&quot;Size&quot;); var month = getMonthValue(timeline); var sizeData = psSize.get(ps).get(&quot;Data&quot;); var l_sizeMonthAttributes = l_loadAddOnPSProcessingDataObj.getSizeLevelAttributes(size, timeline); var onSizeLevelAttributeJSON = new JSONObject(l_sizeMonthAttributes); for(var attributeItr = onSizeLevelAttributeJSON.keys(); attributeItr.hasNext();) { var factType = attributeItr.next(); sizeData.put(factType, onSizeLevelAttributeJSON.get(factType)); } //getAttributesForMonthLvl(onSizeMonthLevelAttribute, dealContainerJSON); //.. var psDeal = psSize.get(ps).get(&quot;DealLevel&quot;); //var timeline = psSize.get(ps).get(&quot;TimeLines&quot;); var psdLength = psDeal.length(); for(var psd=0; psd&lt;psdLength; psd++){ var dealData = psDeal.get(psd).get(&quot;Data&quot;); dealData.put(&quot;Month&quot;, timeline); if(psDeal.get(psd).has(&quot;TimeLines&quot;)){ var timelineArr = psDeal.get(psd).get(&quot;TimeLines&quot;); for(var tl=0; tl &lt; timelineArr.length(); tl++){ var timelineValue = timelineArr.get(tl).get(&quot;TimeLines&quot;); if(timeline == timelineValue){ var tlVersion = timelineArr.get(tl).get(&quot;Version&quot;); psDeal.get(psd).put(&quot;Version&quot;, tlVersion); break; } } psDeal.get(psd).remove(&quot;TimeLines&quot;); } if(dealData.get(&quot;Channels&quot;) == channelJSON.get(ch)){ //Modify priceStructureJSON for adding MinCurrentNetFOB and MinCurrentNetList var dealVersion = psDeal.get(psd).get(&quot;Version&quot;); for(var dlv=0; dlv&lt;dealVersion.length(); dlv++){ var versionType = dealVersion.get(dlv).get(&quot;Version&quot;); if(versionType == &quot;Current&quot;){ var versionData = dealVersion.get(dlv).get(&quot;Data&quot;); var currentNetFOB = versionData.get(&quot;Net_FOB&quot;); var currentNetList = versionData.get(&quot;Net_List_ATAX&quot;); if(currentNetFOB == &quot;&quot;){ currentNetFOB = 0; } if(currentNetList == &quot;&quot;){ currentNetList = 0; } if(minNetFOB != &quot;&quot;){ if(currentNetFOB &lt; minNetFOB){ minNetFOB = currentNetFOB; } }else{ minNetFOB = currentNetFOB; } if(minNetList != &quot;&quot;){ if(currentNetList &lt; minNetList){ minNetList = currentNetList; } }else{ minNetList = currentNetList; } }else{ //Calculate AvgRAB attribute var versionData = dealVersion.get(dlv).get(&quot;Data&quot;); var RAB = versionData.get(&quot;RAB&quot;); var Net_FOB = versionData.get(&quot;Net_FOB&quot;); totalRAB = Number(totalRAB) + Number(RAB); totalNetFOB = Number(totalNetFOB) + Number(Net_FOB); dealCount = dealCount + 1; } } } } } psFacts.get(&quot;Data&quot;).get(channelJSON.get(ch)).put(&quot;MinCurrentNetFOB&quot;, minNetFOB); psFacts.get(&quot;Data&quot;).get(channelJSON.get(ch)).put(&quot;MinCurrentNetList&quot;, minNetList); } psFacts.remove(&quot;Size&quot;); psFacts.put(&quot;Size&quot;,psSize); var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### GWF_Normalize Third For loop Call : Execution Time (milliseconds) : &quot; + executionTime); //var avgRAB = (Number(totalRAB) / Number(dealCount)); //var avgNetFOB = (Number(totalNetFOB) / Number(dealCount)); //psFacts.get(&quot;Data&quot;).put(&quot;AvgRAB&quot;, avgRAB); //psFacts.get(&quot;Data&quot;).put(&quot;AvgYearNetFOB&quot;, avgNetFOB); //psFacts.get(&quot;Data&quot;).put(&quot;MinCurrentNetFOB&quot;, minNetFOB); //psFacts.get(&quot;Data&quot;).put(&quot;MinCurrentNetList&quot;, minNetList); var startTime = new Date(); println(&quot;Normalize_Main Called&quot;); var result = Normalize_Main(priceStructureJSON); var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### GWF_Normalize Normalize_Main Call : Execution Time (milliseconds) : &quot; + executionTime); /* var fileToWrite = new File(&quot;/home/cloud_es1/nshetye/workflow/target.out&quot;); var FW = new FileWriter(fileToWrite); FW.write(priceStructureJSON); FW.close(); var fileToWrite = new File(&quot;/home/cloud_es1/nshetye/workflow/normalize.out&quot;); var FW = new FileWriter(fileToWrite); FW.write(result); FW.close(); var fileToWrite = new File(&quot;/home/cloud_es1/nshetye/workflow/outputArr.json&quot;); var FW = new FileWriter(fileToWrite); FW.write(outputArr); FW.close(); */ return result; } function getAttributesForYearLvl(onYearLevelAttribute, dealContainerJSON){ var attributeJSON = new JSONObject(onYearLevelAttribute); for(var attributeItr = attributeJSON.keys(); attributeItr.hasNext();) { var factType = attributeItr.next(); dealContainerJSON.get(&quot;Data&quot;).put(factType, attributeJSON.get(factType)); } } function getAttributesForMonthLvl(onSizeLevelAttribute, dealContainerJSON){ var onSizeLevelAttributeJSON = new JSONObject(onSizeLevelAttribute); var dcSizes = dealContainerJSON.get(&quot;Sizes&quot;); for(var sz=0; sz&lt;dcSizes.length(); sz++){ var size = dcSizes.get(sz).get(&quot;Sizes&quot;); var sizeData = dcSizes.get(sz).get(&quot;Data&quot;); for(var attributeItr = onSizeLevelAttributeJSON.keys(); attributeItr.hasNext();) { var factType = attributeItr.next(); if(size == onSizeLevelAttributeJSON.get(factType)){ sizeData.put(factType, onSizeLevelAttributeJSON.get(factType)); } } /* var sizeDealLevel = dcSizes.get(sz).get(&quot;DealLevel&quot;); for(var dl=0; dl&lt;sizeDealLevel.length(); dl++){ var dealData = sizeDealLevel.get(dl).get(&quot;Data&quot;); for(var attributeItr = monthArrttributeJSON.keys(); attributeItr.hasNext();) { var factType = attributeItr.next(); dealData.put(factType, monthArrttributeJSON.get(factType)); } } */ } } function getMonthValue(date){ var dateArr = date.split(&quot;&quot;); var months = new JSONArray(); months.put(&quot;Jan&quot;);months.put(&quot;Feb&quot;);months.put(&quot;Mar&quot;);months.put(&quot;Apr&quot;);months.put(&quot;May&quot;);months.put(&quot;Jun&quot;);months.put(&quot;Jul&quot;);months.put(&quot;Aug&quot;); months.put(&quot;Sept&quot;);months.put(&quot;Oct&quot;);months.put(&quot;Nov&quot;);months.put(&quot;Dec&quot;); var actualDate = dateArr[1] + dateArr[2] + dateArr[3] + dateArr[4] + &quot;/&quot; + dateArr[5] + dateArr[6] + &quot;/&quot; + dateArr[7] + dateArr[8]; var dateObj = new Date(actualDate); var monthNumber = dateObj.getMonth(); var monthName = months.get(monthNumber); return monthName; } × Search results Close "},"WF_Execution.js.html":{"id":"WF_Execution.js.html","title":"Source: WF_Execution.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: WF_Execution.js /** * @fileOverview This files contain function related to Workflow Exection/Transition * It updates the Price Plan with persistent variables information needed during the Transition. * @author anadar * @version 1.0.0 */ /** * WF_Execution holds function for perform Workflow transition. * @module WF_Execution * @requires WF_NS_PriceStructure */ importPackage(org.json); importPackage(java.lang); importPackage(java.io); importPackage(java.util); /** * This is the main function which sets up persistent parameter and performs the Workflow Transtion of the Price Plan from UI * @function * @name WF_Execution * @memberof module:WF_Execution * @param {object} inputContext Workflow input Context * @param {object} docServerManager Entity Doc ServerManager * @param {object} userConnInfo User Connection Info * @param {object} bAutoPublish Boolean auto publish */ function WF_Execution(inputContext, docServerManager, userConnInfo, bAutoPublish){ var wfConnectionObj = null; println(&quot;inputContext &gt;&gt; &quot; + JSON.stringify(inputContext)); //var inputContext = JSON.parse(inputContext); var docIdArray = [inputContext[&quot;System Fields&quot;][&quot;Document Id&quot;]]; var wfTransition = inputContext[&quot;WF_Transition&quot;]; var comments = inputContext[&quot;Comments&quot;]; var productName = inputContext[&quot;Product Name&quot;]; var geographyName = inputContext[&quot;Geography Name&quot;]; var regionName = inputContext[&quot;Region Name&quot;]; var geographyCode = inputContext[&quot;Geography Code&quot;]; var productCode = inputContext[&quot;Product Code&quot;]; var timeCode = inputContext[&quot;Time Code&quot;]; var webURL = inputContext[&quot;link&quot;]; var brandCode = NormalizedHierachiesMap.get(&quot;PC_BRAND_MASTER&quot;).get(&quot;Price Category&quot;).get(productCode).get(&quot;Brand&quot;); var regionCode = NormalizedHierachiesMap.get(&quot;GeographyMaster&quot;).get(&quot;Market&quot;).get(geographyCode).get(&quot;Region&quot;); println(&quot;brandCode &gt; &quot; + brandCode + &quot; / regionCode &gt; &quot; + regionCode); var docIdArray = new JSONArray(docIdArray); var ErrorFileWriterObj = new A_FileWriter(&quot;WF_ExecutionError.Log&quot;, true); //var instanceCreationFileWriterObj = new A_FileWriter(&quot;InstanceCreation.Log&quot;, true); //var formatTMT = new java.text.SimpleDateFormat(&quot;EEE, dd MMM yyyy HH:mm:ss&quot;); //println(&quot;########### NS WF Execution Called ################&quot;); for(var docIdItr = 0, docIdLength = docIdArray.length(); docIdItr&lt;docIdLength; docIdItr++) { var documentId = docIdArray.get(docIdItr); //var libraryName = &quot;PriceStructure&quot;; var columnOption = new HashMap(); var columnMap = new HashMap(); if(documentId.equals(&quot;&quot;) || null == documentId) { ErrorFileWriterObj.writeline(&quot;Null Doc Id found.&quot;); } else { var finalQuery = new JSONObject(); var conditionFieldNames = new JSONArray(); var conditionType = new JSONArray(); var conditionValues = new JSONArray(); var units = new JSONArray(); conditionFieldNames.put(&quot;Document Id&quot;); conditionValues.put(documentId); conditionType.put(&quot;IN&quot;); var conditionalUnit = getUnitConditionalQuery(&quot;AND&quot;, &quot;OR&quot;, conditionFieldNames, conditionType, conditionValues); units.put(conditionalUnit); finalQuery.put(&quot;Units&quot;, units); finalQuery.put(&quot;UnitOperator&quot;, &quot;OR&quot;); var jsonQuery = finalQuery.toString(); var document = mergePricePlanAndDealContainerDocuments(jsonQuery, docServerManager, userConnInfo).get(0); var priceplanSystemFileds = document.get(&quot;PricePlan System Fields&quot;); var extraAttributes = new JSONObject(); extraAttributes.put(&quot;Comments&quot;, comments); extraAttributes.put(&quot;Product Name&quot;, productName); extraAttributes.put(&quot;Geography Name&quot;, geographyName); extraAttributes.put(&quot;Region Name&quot;, regionName); extraAttributes.put(&quot;Geography Code&quot;, geographyCode); extraAttributes.put(&quot;Product Code&quot;, productCode); extraAttributes.put(&quot;Time Code&quot;, timeCode); extraAttributes.put(&quot;URL&quot;, webURL); extraAttributes.put(&quot;Region Code&quot;, regionCode); extraAttributes.put(&quot;Brand Code&quot;, brandCode); var result = performWorkFlowTransitions(documentId, document.get(&quot;scope&quot;), priceplanSystemFileds, wfConnectionObj, docServerManager, userConnInfo, wfTransition, extraAttributes, bAutoPublish); return result; } } //instanceCreationFileWriterObj.close(); ErrorFileWriterObj.close(); //println(&quot;########### WF Execution Finished ################&quot;); } function convertHTMLcomment(comments){ var strHTML =&quot;&quot;; var strRecall=&quot;&quot;; if(comments.has('Creator')){ if(comments.get('Creator').get(0).get('Comments').has('Submit')){ var strSubmitComments= comments.get('Creator').get(0).get('Comments').get('Submit'); var arrSubmit = String(strSubmitComments).split(':'); if (arrSubmit[1] !== undefined){ strHTML = '&lt;tr&gt;&lt;td&gt;' + arrSubmit[0]+ '&lt;/td&gt;&lt;td&gt;' + arrSubmit[1] +'&lt;/td&gt;&lt;/tr&gt;'; return strHTML; } } if(comments.get('Creator').get(0).get('Comments').has('Recall')){ var arrRecall = String(comments.get('Creator').get(0).get('Comments').get('Recall')).split(':'); if(arrRecall[1] !== undefined ){ strRecall = '&lt;tr&gt;&lt;td&gt;' + arrRecall[0] + '&lt;/td&gt;&lt;td&gt;' + arrRecall[1] +'&lt;/td&gt;&lt;/tr&gt;'; return strRecall; } } } if(comments.has('Approver')){ for (var i = 0; i &lt; comments.get('Approver').length(); i++) { var objApprover = comments.get('Approver').get(i); if (objApprover.has('Comments')){ var arrAppComments = String(objApprover.get('Comments')).split(':'); if(arrAppComments.length &gt;= 1){ strHTML = strHTML + '&lt;tr&gt;&lt;td&gt;' + arrAppComments[0] + '&lt;/td&gt;&lt;td&gt;' + arrAppComments[1] +'&lt;/td&gt;&lt;/tr&gt;'; return strHTML; } } } } } function getWhatComments(comments){ if(comments.has('What')){ return comments.get('What'); } } function getCommentsforEmail(processDefinitionName,userConnInfo,processInstanceKey,persistantProps,plastComments){ var workflowConn= VistaarJSUtils.getWorkflowConnection(userConnInfo); //l_wfConn.getHistoryData(l_processDefinition, l_processInstanceKey, l_fillTaskHistory, l_fillNodeHistory, l_persistentParamKeyArrList); var l_persistentParamKeyArrList = java.util.ArrayList(); var iterator= persistantProps.entrySet().iterator(); while(iterator.hasNext()) { var parameter = iterator.next(); var key= parameter.getKey(); var value=parameter.getValue(); l_persistentParamKeyArrList.add(value); } var l_historyData =workflowConn.getHistoryData(processDefinitionName,processInstanceKey,true,false, l_persistentParamKeyArrList); var l_taskHistoryInfo = l_historyData.getTaskHistoryInfo(); println('History &gt;&gt;' + l_taskHistoryInfo.toString()); var strHTML=&quot;&lt;table&gt;&lt;tr&gt; &lt;th&gt; Actor &lt;/th&gt; &lt;th&gt; Comments &lt;/th&gt;&lt;/tr&gt; &quot;; for(var l_taskHistoryInfoIterator = 0; l_taskHistoryInfoIterator &lt; l_taskHistoryInfo.size(); l_taskHistoryInfoIterator++){ var l_task = l_taskHistoryInfo.get(l_taskHistoryInfoIterator); if(l_task.getEvent() == &quot;Completed&quot;){ var comments =l_task.getComments(); strHTML = strHTML + convertHTMLcomment(new JSONObject(comments[0])); } } strHTML = strHTML + convertHTMLcomment(new JSONObject(plastComments)); return strHTML + &quot;&lt;/table&gt;&quot;; } /** * Perform Workflow Transtion of Price Plan whose documet Id is passed &lt;br&gt; * The list of persistent parameter that are added to the Price Plan &lt;br&gt; * &lt;ul&gt; * &lt;li&gt;Comments&lt;/li&gt; * &lt;li&gt;Product Name&lt;/li&gt; * &lt;li&gt;Geography Name&lt;/li&gt; * &lt;li&gt;Region Name&lt;/li&gt; * &lt;li&gt;Geography Code&lt;/li&gt; * &lt;li&gt;Product Code&lt;/li&gt; * &lt;li&gt;URL&lt;/li&gt; * &lt;li&gt;Region Code&lt;/li&gt; * &lt;li&gt;Brand Code&lt;/li&gt; * &lt;li&gt;HTML Comments&lt;/li&gt; * &lt;li&gt;What&lt;/li&gt; * &lt;/ul&gt; * The current Workflow Status of plan is checked and based on the status the parameters are put and api * &lt;pre&gt; &lt;code&gt; * // executeScript * docServerManager.executeScript(&quot;ExecuteWorkflowTask&quot;, paramName, paramValue, userConnInfo); * &lt;/code&gt; &lt;/pre&gt; * is called and the workflow transtion is performed. * @function * @name performWorkFlowTransitions * @memberof module:WF_Execution * @param {string} documentId Price Plan Document Id in string * @param {object} scope Scope of the Price Plan * @param {object} priceplanSystemFileds Price Plan System Fields * @param {object} wfConnectionObj Vistaar Workflow Connection Object * @param {object} docServerManager Docment Server Managers * @param {object} userConnInfo User Connection Info * @param {string} wfTransition Next workflow Transtion * @param {object} extraAttributes Persistent Parameter List * @param {boolean} bAutoPublish Auto PUblish boolean */ function performWorkFlowTransitions(documentId, scope, priceplanSystemFileds, wfConnectionObj, docServerManager, userConnInfo, wfTransition, extraAttributes, bAutoPublish) { var localProps = new HashMap(); var persistantProps = new HashMap(); var processDefinitionName = &quot;PricePlan&quot;; var CurrentWFState = &quot;&quot;; var processInstanceKey = documentId; var comments = extraAttributes.get(&quot;Comments&quot;); var productName = extraAttributes.get(&quot;Product Name&quot;); var geographyName = extraAttributes.get(&quot;Geography Name&quot;); var regionName = extraAttributes.get(&quot;Region Name&quot;); var geographyCode = extraAttributes.get(&quot;Geography Code&quot;); var productCode = extraAttributes.get(&quot;Product Code&quot;); var timeCode = extraAttributes.get(&quot;Time Code&quot;); var webURL = extraAttributes.get(&quot;URL&quot;); var year = scope.get(&quot;Time&quot;); var regionCode = extraAttributes.get(&quot;Region Code&quot;); var brandCode = extraAttributes.get(&quot;Brand Code&quot;); var scopeForPermissionEvaluation = new JSONObject(); //CreatorMatrixMasters is a globally cached variable which holds the masters for CreatorMatrix. //println(&quot;CreatorMatrixMasters : &quot;+CreatorMatrixMasters); var currentWFStatus = new JSONArray(priceplanSystemFileds.get(&quot;WorkFlowStatus&quot;)); currentWFStatus = currentWFStatus.get(0); var PSDefinitionName = g_activePSDefinition; //println(&quot;currentWFStatus &gt;&gt;&gt; &quot; + currentWFStatus); //println(&quot;PSDefinitionName &gt;&gt;&gt; &quot; + PSDefinitionName); //println(&quot;scope &gt;&gt;&gt; &quot; + scope); var dimensionMasterArrayScope = getMastersScope(PSDefinitionName, scope, CreatorMatrixMasters); //println(&quot;dimensionMasterArrayScope &gt;&gt; &quot; + dimensionMasterArrayScope); scopeForPermissionEvaluation.put(&quot;Scope&quot;, dimensionMasterArrayScope); persistantProps.put(&quot;Scope&quot;, scopeForPermissionEvaluation.toString()); persistantProps.put(&quot;libraryName&quot;, &quot;PricePlan&quot; ); persistantProps.put(&quot;documentId&quot;, documentId ); persistantProps.put(&quot;geography&quot;, &quot;geography&quot; ); persistantProps.put(&quot;geography_Attrib&quot;, &quot;geography_Attrib&quot; ); persistantProps.put(&quot;product&quot;, &quot;product&quot; ); persistantProps.put(&quot;product_Attrib&quot;, &quot;product_Attrib&quot; ); var htmlcomments= getCommentsforEmail(processDefinitionName,userConnInfo,processInstanceKey,persistantProps,comments); var what = getWhatComments(new JSONObject(comments)); var geographyCode = scope.get(&quot;Geography&quot;); var time = scope.get(&quot;Time&quot;); var productCode = scope.get(&quot;Product&quot;); var inputJSON = new JSONObject(); inputJSON.put(&quot;scope&quot;, new JSONObject()); inputJSON.get(&quot;scope&quot;).put(&quot;Geography Code&quot;, geographyCode); inputJSON.get(&quot;scope&quot;).put(&quot;Product Code&quot;, productCode); inputJSON.get(&quot;scope&quot;).put(&quot;Time&quot;, time); var l_loadAddOnPSProcessingDataObj = new LoadAddOnPSProcessingData(); //l_loadAddOnPSProcessingDataObj.init(inputJSON, docServerManager, userConnInfo); //var onYearLevelAttribute = l_loadAddOnPSProcessingDataObj.getGlobalAttributes(); l_loadAddOnPSProcessingDataObj.initPostingAndFuturePlanning(inputJSON, docServerManager, userConnInfo); var onYearLevelAttribute = l_loadAddOnPSProcessingDataObj.getGAPostingAndFuturePlanning(); var onYearLevelAttributeJSON = new JSONObject(onYearLevelAttribute); var IsNonPostingMarket = onYearLevelAttributeJSON.get(&quot;ON&quot;).get(&quot;IsNonPostingMarket&quot;); if(bAutoPublish != undefined &amp;&amp; bAutoPublish) var IsFuturePlanning = 1; else var IsFuturePlanning = onYearLevelAttributeJSON.get(&quot;ON&quot;).get(&quot;IsFuturePlanning&quot;); if(wfConnectionObj == null) { wfConnectionObj = com.vistaar.workflow.core.WorkflowManagerImpl.getInstance(); } try{ var jsonInput = new JSONObject(); var jsonInputString = new JSONArray(); var entityName = &quot;PricePlan&quot;; var paramName = java.lang.reflect.Array.newInstance(java.lang.String, 1); var paramValue = java.lang.reflect.Array.newInstance(java.lang.String, 1); println(&quot;currentWFStatus &gt;&gt; &quot; + currentWFStatus); //currentWFStatus=&quot;&quot;; //WIP(wfConnectionObj, processDefinitionName, processInstanceKey, localProps, persistantProps, userConnInfo); if(currentWFStatus == &quot;&quot;){ println(&quot;## First WF Call&quot;); WIP(wfConnectionObj, processDefinitionName, processInstanceKey, localProps, persistantProps, userConnInfo); //println(&quot;## First WF End&quot;); } else if(currentWFStatus == &quot;WIP&quot;){ println(&quot;## WIP Called&quot;); //WIP(wfConnectionObj, processDefinitionName, processInstanceKey, localProps, persistantProps, userConnInfo); //println(&quot;## WIP End&quot;); //println(&quot;## Submit Start&quot;); jsonInput.put(&quot;System Fields&quot;, priceplanSystemFileds); jsonInput.put(&quot;Action&quot;, &quot;Submit&quot;); jsonInput.put(&quot;Comments&quot;, comments); jsonInput.put(&quot;What&quot;, what); jsonInput.put(&quot;HTMLComments&quot;, htmlcomments); jsonInput.put(&quot;Entity Name&quot;, entityName); jsonInput.put(&quot;IsNonPostingMarket&quot;, IsNonPostingMarket); jsonInput.put(&quot;IsFuturePlanning&quot;, IsFuturePlanning); jsonInput.put(&quot;Product Name&quot;, productName); jsonInput.put(&quot;Geography Name&quot;, geographyName); jsonInput.put(&quot;Region Name&quot;, regionName); jsonInput.put(&quot;Year&quot;, year); jsonInput.put(&quot;Geography Code&quot;, geographyCode); jsonInput.put(&quot;Product Code&quot;, productCode); jsonInput.put(&quot;Time Code&quot;, timeCode); jsonInput.put(&quot;URL&quot;, webURL); jsonInput.put(&quot;Region Code&quot;, regionCode); jsonInput.put(&quot;Brand Code&quot;, brandCode); jsonInputString.put(jsonInput); paramName[0] = &quot;jsonInputString&quot;; paramValue[0] = jsonInputString.toString(); //println(&quot;ExecuteWorkflowTask Called...&quot;); var executeWorkflowTask = docServerManager.executeScript(&quot;ExecuteWorkflowTask&quot;, paramName, paramValue, userConnInfo); executeWorkflowTask = new JSONObject(executeWorkflowTask); executeWorkflowTask.put(&quot;Comments&quot; , comments); return executeWorkflowTask; //println(&quot;executeWorkflowTask &gt;&gt; &quot; + executeWorkflowTask); //instanceCreationFileWriterObj.writeline(&quot;Workflow Instance Created for &quot;+processInstanceKey+&quot; with state WIP&quot;); println(&quot;## Submit End&quot;); } else if(currentWFStatus == &quot;Pending Approval&quot;){ println(&quot;## PA Called&quot;); if(wfTransition == &quot;Approve&quot;){ jsonInput.put(&quot;System Fields&quot;, priceplanSystemFileds); jsonInput.put(&quot;Action&quot;, &quot;Approve&quot;); jsonInput.put(&quot;Comments&quot;, comments); jsonInput.put(&quot;What&quot;, what); jsonInput.put(&quot;HTMLComments&quot;, htmlcomments); jsonInput.put(&quot;Entity Name&quot;, entityName); jsonInput.put(&quot;IsNonPostingMarket&quot;, IsNonPostingMarket); jsonInput.put(&quot;IsFuturePlanning&quot;, IsFuturePlanning); jsonInput.put(&quot;Product Name&quot;, productName); jsonInput.put(&quot;Geography Name&quot;, geographyName); jsonInput.put(&quot;Region Name&quot;, regionName); jsonInput.put(&quot;Year&quot;, year); jsonInput.put(&quot;Geography Code&quot;, geographyCode); jsonInput.put(&quot;Product Code&quot;, productCode); jsonInput.put(&quot;Time Code&quot;, timeCode); jsonInput.put(&quot;URL&quot;, webURL); jsonInput.put(&quot;Region Code&quot;, regionCode); jsonInput.put(&quot;Brand Code&quot;, brandCode); jsonInputString.put(jsonInput); paramName[0] = &quot;jsonInputString&quot;; paramValue[0] = jsonInputString.toString(); }else if(wfTransition == &quot;Reject&quot;){ jsonInput.put(&quot;System Fields&quot;, priceplanSystemFileds); jsonInput.put(&quot;Action&quot;, &quot;Reject&quot;); jsonInput.put(&quot;Comments&quot;, comments); //Reject mail notification changes var RejectRecallMsg1 = &quot;&lt;span style='color:red'&gt; &lt;b&gt; Action &lt;/b&gt; &lt;/span&gt;: &lt;b&gt; Price Plan rejected at Level&quot;; var RejectRecallMsg2 = &quot;Please review &lt;/b&gt;&quot;; jsonInput.put(&quot;RejectRecallSubject&quot;,&quot;ACTION&quot;); jsonInput.put(&quot;RejectRecallMsg1&quot;,RejectRecallMsg1); jsonInput.put(&quot;RejectRecallMsg2&quot;,RejectRecallMsg2); jsonInput.put(&quot;RejectRecallRole&quot;,userConnInfo.getRoleName()); jsonInput.put(&quot;What&quot;, what); jsonInput.put(&quot;HTMLComments&quot;, htmlcomments); jsonInput.put(&quot;IsNonPostingMarket&quot;, IsNonPostingMarket); jsonInput.put(&quot;IsFuturePlanning&quot;, IsFuturePlanning); jsonInput.put(&quot;Entity Name&quot;, entityName); jsonInput.put(&quot;wfTransition&quot;, wfTransition); jsonInput.put(&quot;Product Name&quot;, productName); jsonInput.put(&quot;Geography Name&quot;, geographyName); jsonInput.put(&quot;Region Name&quot;, regionName); jsonInput.put(&quot;Year&quot;, year); jsonInput.put(&quot;Geography Code&quot;, geographyCode); jsonInput.put(&quot;Product Code&quot;, productCode); jsonInput.put(&quot;Time Code&quot;, timeCode); jsonInput.put(&quot;URL&quot;, webURL); jsonInput.put(&quot;Region Code&quot;, regionCode); jsonInput.put(&quot;Brand Code&quot;, brandCode); jsonInputString.put(jsonInput); paramName[0] = &quot;jsonInputString&quot;; paramValue[0] = jsonInputString.toString(); }else if(wfTransition == &quot;Recall&quot;){ jsonInput.put(&quot;System Fields&quot;, priceplanSystemFileds); jsonInput.put(&quot;Action&quot;, &quot;Reject&quot;); jsonInput.put(&quot;Comments&quot;, comments); var RejectRecallMsg1 = &quot;Notification: Price Plan has been recalled at Level&quot;; var RejectRecallMsg2 = &quot;&quot;; jsonInput.put(&quot;RejectRecallSubject&quot;,&quot;NOTIFICATION&quot;); jsonInput.put(&quot;RejectRecallMsg1&quot;,RejectRecallMsg1); jsonInput.put(&quot;RejectRecallMsg2&quot;,RejectRecallMsg2); jsonInput.put(&quot;RejectRecallRole&quot;,userConnInfo.getRoleName()); jsonInput.put(&quot;What&quot;, what); jsonInput.put(&quot;HTMLComments&quot;, htmlcomments); jsonInput.put(&quot;IsNonPostingMarket&quot;, IsNonPostingMarket); jsonInput.put(&quot;IsFuturePlanning&quot;, IsFuturePlanning); jsonInput.put(&quot;Entity Name&quot;, entityName); jsonInput.put(&quot;wfTransition&quot;, wfTransition); jsonInput.put(&quot;Product Name&quot;, productName); jsonInput.put(&quot;Geography Name&quot;, geographyName); jsonInput.put(&quot;Region Name&quot;, regionName); jsonInput.put(&quot;Year&quot;, year); jsonInput.put(&quot;Geography Code&quot;, geographyCode); jsonInput.put(&quot;Product Code&quot;, productCode); jsonInput.put(&quot;Time Code&quot;, timeCode); jsonInput.put(&quot;URL&quot;, webURL); jsonInput.put(&quot;Region Code&quot;, regionCode); jsonInput.put(&quot;Brand Code&quot;, brandCode); jsonInputString.put(jsonInput); paramName[0] = &quot;jsonInputString&quot;; paramValue[0] = jsonInputString.toString(); } var executeWorkflowTask = docServerManager.executeScript(&quot;ExecuteWorkflowTask&quot;, paramName, paramValue, userConnInfo); executeWorkflowTask = new JSONObject(executeWorkflowTask); executeWorkflowTask.put(&quot;Comments&quot; , comments); return executeWorkflowTask; //instanceCreationFileWriterObj.writeline(&quot;Workflow Instance Created for : &quot;+processInstanceKey+&quot; with state Pending Approval&quot;); println(&quot;## PA End&quot;); } else if(currentWFStatus == &quot;Approved&quot;){ println(&quot;## AP Called&quot;); if(wfTransition == &quot;Approve&quot;){ jsonInput.put(&quot;System Fields&quot;, priceplanSystemFileds); jsonInput.put(&quot;Action&quot;, &quot;Publish&quot;); jsonInput.put(&quot;Comments&quot;, comments); jsonInput.put(&quot;What&quot;, what); jsonInput.put(&quot;HTMLComments&quot;, htmlcomments); jsonInput.put(&quot;Entity Name&quot;, entityName); jsonInput.put(&quot;IsNonPostingMarket&quot;, IsNonPostingMarket); jsonInput.put(&quot;IsFuturePlanning&quot;, IsFuturePlanning); jsonInput.put(&quot;Product Name&quot;, productName); jsonInput.put(&quot;Geography Name&quot;, geographyName); jsonInput.put(&quot;Region Name&quot;, regionName); jsonInput.put(&quot;Year&quot;, year); jsonInput.put(&quot;Geography Code&quot;, geographyCode); jsonInput.put(&quot;Product Code&quot;, productCode); jsonInput.put(&quot;Time Code&quot;, timeCode); jsonInput.put(&quot;URL&quot;, webURL); jsonInput.put(&quot;Region Code&quot;, regionCode); jsonInput.put(&quot;Brand Code&quot;, brandCode); jsonInputString.put(jsonInput); paramName[0] = &quot;jsonInputString&quot;; paramValue[0] = jsonInputString.toString(); }else if(wfTransition == &quot;Reject&quot;){ jsonInput.put(&quot;System Fields&quot;, priceplanSystemFileds); jsonInput.put(&quot;Action&quot;, &quot;Reject&quot;); jsonInput.put(&quot;Comments&quot;, comments); var RejectRecallMsg1 = &quot;&lt;span style='color:red'&gt; &lt;b&gt; Action &lt;/b&gt; &lt;/span&gt;: &lt;b&gt; Price Plan rejected at Level&quot;; var RejectRecallMsg2 = &quot;Please review &lt;/b&gt;&quot;; jsonInput.put(&quot;RejectRecallSubject&quot;,&quot;ACTION&quot;); jsonInput.put(&quot;RejectRecallMsg1&quot;,RejectRecallMsg1); jsonInput.put(&quot;RejectRecallMsg2&quot;,RejectRecallMsg2); jsonInput.put(&quot;RejectRecallRole&quot;,userConnInfo.getRoleName()); jsonInput.put(&quot;What&quot;, what); jsonInput.put(&quot;HTMLComments&quot;, htmlcomments); jsonInput.put(&quot;IsNonPostingMarket&quot;, IsNonPostingMarket); jsonInput.put(&quot;IsFuturePlanning&quot;, IsFuturePlanning); jsonInput.put(&quot;Entity Name&quot;, entityName); jsonInput.put(&quot;wfTransition&quot;, wfTransition); jsonInput.put(&quot;Product Name&quot;, productName); jsonInput.put(&quot;Geography Name&quot;, geographyName); jsonInput.put(&quot;Region Name&quot;, regionName); jsonInput.put(&quot;Year&quot;, year); jsonInput.put(&quot;Geography Code&quot;, geographyCode); jsonInput.put(&quot;Product Code&quot;, productCode); jsonInput.put(&quot;Time Code&quot;, timeCode); jsonInput.put(&quot;URL&quot;, webURL); jsonInput.put(&quot;Region Code&quot;, regionCode); jsonInput.put(&quot;Brand Code&quot;, brandCode); jsonInputString.put(jsonInput); paramName[0] = &quot;jsonInputString&quot;; paramValue[0] = jsonInputString.toString(); }else if(wfTransition == &quot;Recall&quot;){ jsonInput.put(&quot;System Fields&quot;, priceplanSystemFileds); jsonInput.put(&quot;Action&quot;, &quot;Reject&quot;); jsonInput.put(&quot;Comments&quot;, comments); var RejectRecallMsg1 = &quot;Notification: Price Plan has been recalled at Level&quot;; var RejectRecallMsg2 = &quot;&quot;; jsonInput.put(&quot;RejectRecallSubject&quot;,&quot;NOTIFICATION&quot;); jsonInput.put(&quot;RejectRecallMsg1&quot;,RejectRecallMsg1); jsonInput.put(&quot;RejectRecallMsg2&quot;,RejectRecallMsg2); jsonInput.put(&quot;RejectRecallRole&quot;,userConnInfo.getRoleName()); jsonInput.put(&quot;What&quot;, what); jsonInput.put(&quot;HTMLComments&quot;, htmlcomments); jsonInput.put(&quot;IsNonPostingMarket&quot;, IsNonPostingMarket); jsonInput.put(&quot;IsFuturePlanning&quot;, IsFuturePlanning); jsonInput.put(&quot;Entity Name&quot;, entityName); jsonInput.put(&quot;wfTransition&quot;, wfTransition); jsonInput.put(&quot;Product Name&quot;, productName); jsonInput.put(&quot;Geography Name&quot;, geographyName); jsonInput.put(&quot;Region Name&quot;, regionName); jsonInput.put(&quot;Year&quot;, year); jsonInput.put(&quot;Geography Code&quot;, geographyCode); jsonInput.put(&quot;Product Code&quot;, productCode); jsonInput.put(&quot;Time Code&quot;, timeCode); jsonInput.put(&quot;URL&quot;, webURL); jsonInput.put(&quot;Region Code&quot;, regionCode); jsonInput.put(&quot;Brand Code&quot;, brandCode); jsonInputString.put(jsonInput); paramName[0] = &quot;jsonInputString&quot;; paramValue[0] = jsonInputString.toString(); } println('JSONInput &gt;&gt;' + jsonInputString.toString() ); var executeWorkflowTask = docServerManager.executeScript(&quot;ExecuteWorkflowTask&quot;, paramName, paramValue, userConnInfo); executeWorkflowTask = new JSONObject(executeWorkflowTask); executeWorkflowTask.put(&quot;Comments&quot; , comments); return executeWorkflowTask; //instanceCreationFileWriterObj.writeline(&quot;Workflow Instance Created for : &quot;+processInstanceKey+&quot; with state Approved&quot;); println(&quot;## AP End&quot;); } else if(currentWFStatus == &quot;Published&quot;){ //println(&quot;## Publish Called&quot;); WIP(wfConnectionObj, processDefinitionName, processInstanceKey, localProps, persistantProps, userConnInfo); println(&quot;## Publish End&quot;); } } catch(e) { println(&quot;ERROR in performWorkflowTransition&quot; + e); //var TMTDateStr = formatTMT.format(new Date()); //ErrorFileWriterObj.writeline(TMTDateStr + &quot; Workflow instance creation failed for &quot;+processInstanceKey+&quot; with Exception \\n&quot;+e); //instanceCreationFileWriterObj.writeline(&quot;Workflow instance creation failed for &quot;+processInstanceKey+&quot; with Exception \\n&quot;+e); } } function WIP(wfConnectionObj, processDefinitionName, processInstanceKey, localProps, persistantProps, userConnInfo) { //Save PS println(&quot;Inside WIP&quot;); //var instanceId = wfConnectionObj.createNewProcessInstance(processDefinitionName, processInstanceKey, localProps, persistantProps, userConnInfo.userName, userConnInfo); var instanceId = wfConnectionObj.createNewProcessInstance(processDefinitionName, processInstanceKey, localProps, persistantProps, null, userConnInfo); //println(&quot;Instance Created&quot;); var activeNodesInfo = wfConnectionObj.getActiveNodes(processDefinitionName, processInstanceKey); //println(&quot;getActiveNodes&quot;); var actNodeInfo = activeNodesInfo[0]; var outGoingTransition = actNodeInfo.getOutgoingTransitions()[0]; var activeNodeId = actNodeInfo.getNodeId(); var exeTranResult = wfConnectionObj.executeTransition(instanceId, activeNodeId, outGoingTransition, localProps, persistantProps, userConnInfo); //println(&quot;executeTransition&quot;); } function Recall(wfConnectionObj, processDefinitionName, processInstanceKey, localProps, userConnInfo) { println(&quot;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@executeTransition for Recall&quot;); var activeNodesInfo = wfConnectionObj.getActiveNodes(processDefinitionName, processInstanceKey); var actNodeInfo = activeNodesInfo[0]; var outGoingTransition = actNodeInfo.getOutgoingTransitions()[0]; var activeNodeId = actNodeInfo.getNodeId(); instanceId = actNodeInfo.getInstanceId(); var persistantProps = wfConnectionObj.getContextVariables(instanceId); println(&quot;outGoingTransition &gt; &quot; + outGoingTransition); println(&quot;persistantProps &gt; &quot;+persistantProps); persistantProps.put(&quot;isRejectFlg&quot;, false); var exeTranResult = wfConnectionObj.executeTransition(instanceId, activeNodeId, outGoingTransition, localProps, persistantProps, userConnInfo); persistantProps = wfConnectionObj.getContextVariables(instanceId); currentState = persistantProps.get(&quot;CurrentState&quot;); println(&quot;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@executeTransition for Submit Completed&quot;); return &quot;&quot;; } function getMastersScope(PSDefinitionName, scope, configuredMasterArray) { println(&quot;scope :&quot;+scope); var ScopeObj = new JSONObject(); var extPrimaryKeyObj = new JSONObject(); var configuredMasterArrayLen = configuredMasterArray.length(); for(var masterItr = 0; masterItr &lt; configuredMasterArrayLen; masterItr++) { var curMasterName = configuredMasterArray.get(masterItr); if(curMasterName.equals(&quot;ProductMaster&quot;)) { //curMasterName = &quot;PricingGroupMaster&quot;; curMasterName = &quot;PC_BRAND_MASTER&quot;; } var priKeyArr = new JSONArray(); var priKeyObj = new JSONObject(); println(&quot;curMasterName &gt; &quot; + curMasterName); var curPrimaryKey = getPrimaryKeyNameFromMaster(PSDefinitionName, curMasterName); println(&quot;curPrimaryKey &gt; &quot; + curPrimaryKey); priKeyObj.put(&quot;Code&quot;, scope.get(curPrimaryKey)); priKeyObj.put(&quot;Level&quot;, scope.get(curPrimaryKey + &quot; Level&quot;)); priKeyArr.put(priKeyObj); extPrimaryKeyObj.put(curMasterName, priKeyArr); } //ScopeObj.put(&quot;Scope&quot;, extPrimaryKeyObj); //println(&quot;############################extPrimaryKeyObj : &quot;+extPrimaryKeyObj); return extPrimaryKeyObj; } function getPrimaryKeyNameFromMaster(PSDefinitionName, MasterName) { var primaryKeyInfo = g_GetPrimaryKeys(PSDefinitionName).get(&quot;Keys&quot;); //println(&quot;primaryKeyInfo &gt; &quot; + primaryKeyInfo); if(primaryKeyInfo != null &amp;&amp; JSONObject.NULL != primaryKeyInfo) { var primaryKeyInfoLength = primaryKeyInfo.length(); for(var i=0;i &lt; primaryKeyInfoLength; i++) { var primaryInfo = primaryKeyInfo.get(i); var primaryKeyCode = primaryInfo.get(&quot;Master&quot;); if(primaryKeyCode.equals(MasterName)) { return primaryInfo.get(&quot;Name&quot;); } } } } × Search results Close "},"WF_NS_PriceStructure.js.html":{"id":"WF_NS_PriceStructure.js.html","title":"Source: WF_NS_PriceStructure.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: WF_NS_PriceStructure.js /******************************************************************************** This work contains or references Vistaar generic components or Vistaar API, and is developed in accordance with Vistaar best practices and solution development guidelines. This work is designed and intended to be used only with licensed Vistaar software. ********************************************************************************/ /* Workflow Task and Notification assignment Script*/ /* Author: Abhishek Singh*/ /** * @fileOverview This files contain Workflow Task and Notification assignment Script * @author anadar * @version 1.0.0 */ /** * @module WF_NS_PriceStructure * @requires module:WF_NS_PS_Generic */ var VAR_DOCPROVIDER = &quot;vistaar.documentServiceProvider&quot;; /** * Runs from process definition is used to get the Max Approval Level of the Price Plan which is stored in the entity * @function * @name WF_NS_PriceStructure_getMaxSequence * @memberof module:WF_NS_PriceStructure * @param {Object} executionContext Workflow Execution Context * @example * &lt;action name=&quot;executeStartTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; * &lt;javascript&gt; * &lt;!--@ * println(&quot;# Inside node enter of Start!!&quot;); * * var LogUserInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var LogUserName = LogUserInfo.getUserName(); var LogUserRole = LogUserInfo.roleName; println(&quot;# Price structure Created by -: &quot;+LogUserName+&quot; / Role &quot; + LogUserRole); executionContext.setVariable(&quot;PS_Creator&quot;,LogUserName); executionContext.setVariable(&quot;PS_CreatorRole&quot;,LogUserRole); executionContext.setVariable(&quot;isAutoPublish&quot;, true); var TotalApprovalLevel = WF_NS_PriceStructure_getMaxSequence(executionContext); println(&quot;# Total number of approval level -: &quot; + TotalApprovalLevel); executionContext.setVariable(&quot;MaxApproval&quot;,TotalApprovalLevel); //var requiredFieldsArray = createTemplatePSAttributeList(); putTemplateRequiredInfoFromReportInExecutionContext(&quot;PricePlanView&quot;,executionContext); */ function WF_NS_PriceStructure_getMaxSequence(executionContext) { var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var contextInstance = getContextInstance(executionContext); var userInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var libraryName = executionContext.getVariable(&quot;libraryName&quot;); /* Get the maximum sequence number */ var libName = &quot;Task_Node_Master&quot;; var colValMap = new java.util.HashMap(); colValMap.put(&quot;Definition_Type&quot;, libraryName); var options = new java.util.HashMap(); var result_Seq = java.lang.reflect.Array.newInstance(java.lang.String, 1000); var result_Seq = docProvider.getAllDocs(libName, colValMap, userInfo, options); if (result_Seq != null) { var TotalApprovalLevel = result_Seq.length; println(&quot;# Total number of approval level -: &quot; + TotalApprovalLevel); // Return the Max sequence number to the caller Process Definition return TotalApprovalLevel.toString(); } else { println(&quot;# No Sequence found&quot;); } } /** * It is called from `WF_NS_PriceStructure_getSubmitRoleOnRejectionState` it creates Task for all the Delegates with * submit permission on the Price Plan * @function * @name WF_NS_PriceStructure_getSubmitRole * @memberof module:WF_NS_PriceStructure * @param {Object} executionContext Workflow Execution Context */ function WF_NS_PriceStructure_getSubmitRole(executionContext) { println(&quot;WF_NS_PriceStructure # I am inside Node Enter event of WIP&quot;); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var contextInstance = getContextInstance(executionContext); var taskAssineeString = &quot;&quot;; var RoleString = &quot;&quot;; var helper = new com.vistaar.workflow.util.WorkflowHelper(); var definitionType = &quot;PricePlan&quot;; //executionContext.getVariable(&quot;libraryName&quot;); println(&quot;definitionType &gt;&gt; &quot; + definitionType); var scope = executionContext.getVariable(&quot;Scope&quot;); var scopeJSONObj = new org.json.JSONObject(scope); var userInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); println(&quot;userInfo &gt;&gt; &quot; + userInfo); var permissionAdapter = new PermissionMtxAdapter_Intf(); permissionAdapter.Init(docProvider, userInfo); var result = permissionAdapter.getCreator(definitionType, scopeJSONObj); print(&quot;ExecuteScript Result: &quot; + result + &quot;\\n&quot;); var validRoles = result.get(&quot;Delegates&quot;); var getAllUserFromScope = new Array(); var getFormattedRoles = new Array(); //CR 28468 if (validRoles.length() != 0) { for (var j = 0; j &lt; validRoles.length(); j++) { var Role_JsonResult = validRoles.get(j); println(&quot;# Roles for Scope-: &quot; + Role_JsonResult); if (RoleString == &quot;&quot;) { RoleString = Role_JsonResult; } else { RoleString = RoleString + &quot;,&quot; + Role_JsonResult; } var usersArray = helper.getUsersForRole(Role_JsonResult); var k = 0; if (usersArray != null &amp;&amp; usersArray.length != 0) { for (k = 0; k &lt; usersArray.length; k++) { getAllUserFromScope.push(usersArray[k]); } } getFormattedRoles.push(&quot;@RoleName{&quot; + Role_JsonResult + &quot;}&quot;); } helper.createTaskInstance(getFormattedRoles, executionContext, &quot;Submit Task&quot;); taskAssineeString = taskUserString(getAllUserFromScope); println(&quot;# Task created for Submit PS&quot;); executionContext.setVariable(&quot;CurrentRole&quot;, RoleString); println(&quot;# Role string is -: &quot; + RoleString); //return taskAssineeString.toString(); return &quot;&quot;; } else { println(&quot;# No Role found for the given Geography for submit task&quot;); println(&quot;# Assigning the submit task to Administrator&quot;); var getAdminRole_User = helper.getUsersForRole(&quot;Administrator&quot;); taskAssineeString = taskUserString(getAdminRole_User); helper.createTaskInstance(['@RoleName{Administrator}'], executionContext, &quot;Submit Task&quot;); println(&quot;# Task created for Submit PS&quot;); RoleString = &quot;Administrator&quot;; executionContext.setVariable(&quot;CurrentRole&quot;, RoleString); println(&quot;# Role string is -: &quot; + RoleString); //return taskAssineeString.toString(); return &quot;&quot;; } } /** * Runs from process definition * @function * @name WF_NS_PriceStructure_getSubmitRoleOnRejectionState * @memberof module:WF_NS_PriceStructure * @param {Object} executionContext Workflow Execution Context * @example * &lt;task-node name=&quot;WIP&quot; create-tasks=&quot;false&quot; end-tasks=&quot;true&quot;&gt; &lt;task name=&quot;Submit Task&quot;&gt; &lt;description&gt;Task for Submit the price structure&lt;/description&gt; &lt;/task&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;setSubmitterRoles_PS&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ executionContext.setVariable(&quot;CurrentState&quot;,&quot;WIP&quot;); println(&quot;Processdefinition Step 1 : Create Submit Task !!&quot;); var App_Level =1; executionContext.setVariable(&quot;Approve_Level&quot;,String(App_Level)); var MailUserString = WF_NS_PriceStructure_getSubmitRoleOnRejectionState(executionContext); println(&quot;Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;SubmitMailUser&quot;,MailUserString); @--&gt; &lt;/javascript&gt; &lt;/action&gt; */ function WF_NS_PriceStructure_getSubmitRoleOnRejectionState(executionContext) { println(&quot;WF_NS_PriceStructure # WF_NS_PriceStructure_getSubmitRoleOnRejectionState&quot;); var requiredFieldsArray = createTemplatePSAttributeList(); //putTemplateRequiredInfoFromReportInExecutionContext(requiredFieldsArray,&quot;PriceStructureExt&quot;,executionContext); var helper = new com.vistaar.workflow.util.WorkflowHelper(); var RejectMailUserString = executionContext.getVariable(&quot;RejectMailUser&quot;); if (RejectMailUserString != null &amp;&amp; !executionContext.getVariable(&quot;RejectMailUser&quot;).equals(&quot;&quot;)) { var RolesForTaskJSONArray = new org.json.JSONArray(executionContext.getVariable(&quot;RejectionRoles&quot;)); var RolesForTaskArray = new Array(); var RolesForTaskJSONArrayLength = RolesForTaskJSONArray.length(); for (var itr1 = 0; itr1 &lt; RolesForTaskJSONArrayLength; itr1++) { RolesForTaskArray.push(RolesForTaskJSONArray.get(itr1)); } helper.createTaskInstance(RolesForTaskArray, executionContext, &quot;Submit Task&quot;); RejectMailUserString = getUniqueMalString(RejectMailUserString.toString()); return &quot;&quot;; } else { var taskAssineeString = WF_NS_PriceStructure_getSubmitRole(executionContext); taskAssineeString = getUniqueMalString(taskAssineeString.toString()); return &quot;&quot;; } } /** * Runs from process definition * @function * @name WF_NS_PriceStructure_getRejectRole * @memberof module:WF_NS_PriceStructure * @param {Object} executionContext Workflow Execution Context * @example * &lt;node name=&quot;Rejected&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;setMailUsers&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ var isRejectFlg = executionContext.getVariable(&quot;isRejectFlg&quot;); if(isRejectFlg == true){ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Rejected&quot;); var MailUserString = WF_NS_PriceStructure_getRejectRole(executionContext); println(&quot;#### Rejected Node - Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;RejectMailUser&quot;,MailUserString); executionContext.setVariable(&quot;RejectSubject&quot;,&quot;Rejected&quot;); println(&quot;#### Rejected Node javascript end&quot;); }else{ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Recall&quot;); var MailUserString = WF_NS_PriceStructure_getRecallRole(executionContext); println(&quot;#### Recall Node - Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;RejectMailUser&quot;,MailUserString); executionContext.setVariable(&quot;RejectSubject&quot;,&quot;Recalled&quot;); println(&quot;#### Recall Node javascript end&quot;); } @--&gt; &lt;/javascript&gt; */ function WF_NS_PriceStructure_getRejectRole(executionContext) { println(&quot;WF_NS_PriceStructure_getRejectRole # I am inside Node Enter event of Rejected&quot;); executionContext.setVariable(&quot;ApproverRoles&quot;, &quot;&quot;); //CR#27174 var requiredFieldsArray = createTemplatePSAttributeList(); //putTemplateRequiredInfoFromReportInExecutionContext(requiredFieldsArray,&quot;PriceStructureExt&quot;,executionContext); var blnSentNotification = true; var PS_CreatorRole = executionContext.getVariable(&quot;PS_CreatorRole&quot;); var Approve_Level = executionContext.getVariable(&quot;Approve_Level&quot;); try { println(&quot;executionContext &gt;&gt; &quot; + executionContext.toString()); blnSentNotification = executionContext.getVariable(&quot;blnSentNotification&quot;); } catch (e) { println(&quot;Got Exception for blnSentNotification&quot;); blnSentNotification = true; } println(&quot;blnSentNotification &gt;&gt; &quot; + blnSentNotification); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var contextInstance = getContextInstance(executionContext); var taskAssineeString = &quot;&quot;; var RoleString = &quot;&quot;; var helper = new com.vistaar.workflow.util.WorkflowHelper(); var definitionType = &quot;PricePlan&quot;; //executionContext.getVariable(&quot;libraryName&quot;); println(&quot;definitionType &gt;&gt; &quot; + definitionType); var scope = executionContext.getVariable(&quot;Scope&quot;); var scopeJSONObj = new org.json.JSONObject(scope); var userInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var permissionAdapter = new PermissionMtxAdapter_Intf(); permissionAdapter.Init(docProvider, userInfo); var result = permissionAdapter.getCreator(definitionType, scopeJSONObj); print(&quot;ExecuteScript Result: &quot; + result + &quot;\\n&quot;); var isRejectFlg = executionContext.getVariable(&quot;isRejectFlg&quot;); println(&quot;isRejectFlg &gt; &quot; + isRejectFlg); //if(isRejectFlg == true){ // var validRoles = result.get(&quot;Delegates&quot;); //}else{ // var validRoles = new JSONArray(); validRoles.put(PS_CreatorRole); var Max_Level = parseInt(executionContext.getVariable(&quot;MaxApproval&quot;)); var ActorHistoryInfo = new JSONObject(executionContext.getVariable(&quot;ActorHistoryInfo&quot;)); println(&quot;Max_Level ..... &quot; + Max_Level); for (var itr = ActorHistoryInfo.keys(); itr.hasNext();) { var key = itr.next(); var roles = ActorHistoryInfo.get(key); var roleArrObj = new JSONArray(roles); var Level = Number(key.replace('Level', '')); if (Level &lt;= Approve_Level) { println(&quot;Level &quot; + Level + &quot; &lt; Approvel Level&quot; + Approve_Level); for (var i = roleArrObj.length() - 1; i &gt;= 0; i--) { validRoles.put(roleArrObj.get(i)); } } println(&quot;ActorHistoryInfo ..... &quot; + ActorHistoryInfo.get(key)); } //var validRoles = result.get(&quot;Delegates&quot;); //} var getAllUserFromScope = new Array(); var getFormattedRoles = new org.json.JSONArray(); //CR 28468 if (validRoles.length() != 0) { for (var j = 0; j &lt; validRoles.length(); j++) { var Role_JsonResult = validRoles.get(j); println(&quot;# Roles for Scope-: &quot; + Role_JsonResult); if (RoleString == &quot;&quot;) { RoleString = Role_JsonResult; } else { RoleString = RoleString + &quot;,&quot; + Role_JsonResult; } var usersArray = helper.getUsersForRole(Role_JsonResult); var k = 0; if (usersArray != null &amp;&amp; usersArray.length != 0) { for (k = 0; k &lt; usersArray.length; k++) { getAllUserFromScope.push(usersArray[k]); } } getFormattedRoles.put(&quot;@RoleName{&quot; + Role_JsonResult + &quot;}&quot;); } var getAllUserFromScopeforRejectRejectionRoles = new Array(); var getRejectionRoles = new org.json.JSONArray(); //CR 28468 var rejectRoles = result.get(&quot;Delegates&quot;); for (var j = 0; j &lt; rejectRoles.length(); j++) { var Role_JsonResult = rejectRoles.get(j); println(&quot;# Roles for Scope-: &quot; + Role_JsonResult); if (RoleString == &quot;&quot;) { RoleString = Role_JsonResult; } else { RoleString = RoleString + &quot;,&quot; + Role_JsonResult; } var usersArray = helper.getUsersForRole(Role_JsonResult); var k = 0; if (usersArray != null &amp;&amp; usersArray.length != 0) { for (k = 0; k &lt; usersArray.length; k++) { getAllUserFromScopeforRejectRejectionRoles.push(usersArray[k]); } } getRejectionRoles.put(&quot;@RoleName{&quot; + Role_JsonResult + &quot;}&quot;); } executionContext.setVariable(&quot;RejectionRoles&quot;, getRejectionRoles.toString()); taskAssineeString = taskUserString(getAllUserFromScope); println(&quot;taskAssineeString1 &gt;&gt; &quot; + taskAssineeString); executionContext.setVariable(&quot;CurrentRole&quot;, RoleString); println(&quot;##### Role string after Rejection is -: &quot; + RoleString); taskAssineeString = getUniqueMalString(taskAssineeString.toString()); if (blnSentNotification == false) { taskAssineeString = &quot;&quot;; } println(&quot;taskAssineeString2 &gt;&gt; &quot; + taskAssineeString); return taskAssineeString; } else { println(&quot;#### No Creator Roles found after rejection ######&quot;); println(&quot;# Assigning the submit task to Administrator&quot;); var getAdminRole_User = helper.getUsersForRole(&quot;Administrator&quot;); taskAssineeString = taskUserString(getAdminRole_User); println(&quot;taskAssineeString1 &gt;&gt; &quot; + taskAssineeString); executionContext.setVariable(&quot;RejectionRoles&quot;, &quot;[\\&quot;@RoleName{Administrator}\\&quot;]&quot;); RoleString = &quot;Administrator&quot;; executionContext.setVariable(&quot;CurrentRole&quot;, RoleString); println(&quot;# Role string is -: &quot; + RoleString); taskAssineeString = getUniqueMalString(taskAssineeString.toString()); if (blnSentNotification == false) { taskAssineeString = &quot;&quot;; } println(&quot;taskAssineeString2 &gt;&gt; &quot; + taskAssineeString); return taskAssineeString; } } /** * Runs from process definition * @function * @name WF_NS_PriceStructure_getRecallRole * @memberof module:WF_NS_PriceStructure * @param {Object} executionContext Workflow Execution Context * @example * &lt;node name=&quot;Rejected&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;setMailUsers&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ var isRejectFlg = executionContext.getVariable(&quot;isRejectFlg&quot;); if(isRejectFlg == true){ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Rejected&quot;); var MailUserString = WF_NS_PriceStructure_getRejectRole(executionContext); println(&quot;#### Rejected Node - Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;RejectMailUser&quot;,MailUserString); executionContext.setVariable(&quot;RejectSubject&quot;,&quot;Rejected&quot;); println(&quot;#### Rejected Node javascript end&quot;); }else{ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Recall&quot;); var MailUserString = WF_NS_PriceStructure_getRecallRole(executionContext); println(&quot;#### Recall Node - Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;RejectMailUser&quot;,MailUserString); executionContext.setVariable(&quot;RejectSubject&quot;,&quot;Recalled&quot;); println(&quot;#### Recall Node javascript end&quot;); } @--&gt; &lt;/javascript&gt; */ function WF_NS_PriceStructure_getRecallRole(executionContext) { var PS_CreatorRole = executionContext.getVariable(&quot;PS_CreatorRole&quot;); var Approve_Level = executionContext.getVariable(&quot;Approve_Level&quot;); println(&quot;# I am inside Node Enter event of Recall&quot;); executionContext.setVariable(&quot;ApproverRoles&quot;, &quot;&quot;); var requiredFieldsArray = createTemplatePSAttributeList(); //putTemplateRequiredInfoFromReportInExecutionContext(requiredFieldsArray,&quot;PriceStructureExt&quot;,executionContext); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var contextInstance = getContextInstance(executionContext); var taskAssineeString = &quot;&quot;; var RoleString = &quot;&quot;; var helper = new com.vistaar.workflow.util.WorkflowHelper(); var definitionType = &quot;PricePlan&quot;; //executionContext.getVariable(&quot;libraryName&quot;); println(&quot;definitionType &gt;&gt; &quot; + definitionType); var scope = executionContext.getVariable(&quot;Scope&quot;); var scopeJSONObj = new org.json.JSONObject(scope); var userInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var permissionAdapter = new PermissionMtxAdapter_Intf(); permissionAdapter.Init(docProvider, userInfo); var result = permissionAdapter.getCreator(definitionType, scopeJSONObj); print(&quot;ExecuteScript Result: &quot; + result + &quot;\\n&quot;); var blnSentNotification = true; try { println(&quot;executionContext &gt;&gt; &quot; + executionContext.toString()); blnSentNotification = executionContext.getVariable(&quot;blnSentNotification&quot;); } catch (e) { println(&quot;Got Exception for blnSentNotification&quot;); blnSentNotification = true; } println(&quot;blnSentNotification &gt;&gt; &quot; + blnSentNotification); var ActorHistoryInfo = executionContext.getVariable(&quot;ActorHistoryInfo&quot;); var ActorHistoryInfoJSON = new JSONObject(ActorHistoryInfo); var validRoles = new JSONArray(); //get all userRoles from &quot;ActorHistoryInfo&quot; : [ApprovalLevel , Role] validRoles.put(PS_CreatorRole); println(&quot;ActorHistoryInfoJSON &gt; &quot; + ActorHistoryInfoJSON); for (var attributeItr = ActorHistoryInfoJSON.keys(); attributeItr.hasNext();) { var key = attributeItr.next(); var roles = ActorHistoryInfoJSON.get(key); var roleArrObj = new JSONArray(roles); var Level = Number(key.replace('Level', '')); if (Level &lt; Approve_Level) { println(&quot;Level &quot; + Level + &quot; &lt; Approvel Level&quot; + Approve_Level); for (var i = roleArrObj.length() - 1; i &gt;= 0; i--) { validRoles.put(roleArrObj.get(i)); } } } println(&quot;###### NS WF_PS validRoles &gt; &quot; + validRoles); var getAllUserFromScope = new Array(); var getFormattedRoles = new org.json.JSONArray(); //CR 28468 for (var j = 0; j &lt; validRoles.length(); j++) { var Role_JsonResult = validRoles.get(j); println(&quot;# Roles for Scope-: &quot; + Role_JsonResult); if (RoleString == &quot;&quot;) { RoleString = Role_JsonResult; } else { RoleString = RoleString + &quot;,&quot; + Role_JsonResult; } var usersArray = helper.getUsersForRole(Role_JsonResult); var k = 0; if (usersArray != null &amp;&amp; usersArray.length != 0) { for (k = 0; k &lt; usersArray.length; k++) { getAllUserFromScope.push(usersArray[k]); } } getFormattedRoles.put(&quot;@RoleName{&quot; + Role_JsonResult + &quot;}&quot;); } var getAllUserFromScopeforRejectRejectionRoles = new Array(); var getRejectionRoles = new org.json.JSONArray(); //CR 28468 var rejectRoles = result.get(&quot;Delegates&quot;); for (var j = 0; j &lt; rejectRoles.length(); j++) { var Role_JsonResult = rejectRoles.get(j); println(&quot;# Roles for Scope-: &quot; + Role_JsonResult); if (RoleString == &quot;&quot;) { RoleString = Role_JsonResult; } else { RoleString = RoleString + &quot;,&quot; + Role_JsonResult; } var usersArray = helper.getUsersForRole(Role_JsonResult); var k = 0; if (usersArray != null &amp;&amp; usersArray.length != 0) { for (k = 0; k &lt; usersArray.length; k++) { getAllUserFromScopeforRejectRejectionRoles.push(usersArray[k]); } } getRejectionRoles.put(&quot;@RoleName{&quot; + Role_JsonResult + &quot;}&quot;); } executionContext.setVariable(&quot;RejectionRoles&quot;, getRejectionRoles.toString()); taskAssineeString = taskUserString(getAllUserFromScope); executionContext.setVariable(&quot;CurrentRole&quot;, RoleString); println(&quot;##### Role string after Rejection is -: &quot; + RoleString); taskAssineeString = getUniqueMalString(taskAssineeString.toString()); if (blnSentNotification == false) { taskAssineeString = &quot;&quot;; } return taskAssineeString; } /** * It is called from `WF_NS_PS_Generic.PendingApproval_NodeEnter_Execute` it creates Task for all the Delegates with * approval permission on the Price Plan * @function * @name WF_NS_PriceStructure_createTaskForApprovalRoles * @memberof module:WF_NS_PriceStructure * @param {Object} executionContext Workflow Execution Context */ function WF_NS_PriceStructure_createTaskForApprovalRoles(approverRoles, executionContext) { println(&quot;# Price structure creator is :&quot; + executionContext.getVariable(&quot;PS_Creator&quot;)); var requiredFieldsArray = createTemplatePSAttributeList(); //putTemplateRequiredInfoFromReportInExecutionContext(requiredFieldsArray,&quot;PriceStructureExt&quot;,executionContext); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var contextInstance = getContextInstance(executionContext); var helper = new com.vistaar.workflow.util.WorkflowHelper(); var taskAssineeString = &quot;&quot;; var RoleString = &quot;&quot;; var userInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var result = new org.json.JSONObject(); var permissionValid = true; var validRoles; validRoles = approverRoles; validRoles = new org.json.JSONArray(validRoles.toString()); if (validRoles.length() == 0) permissionValid = false; println(&quot;validRoles fetched&quot;); result.put(&quot;IsPermissionValid&quot;, permissionValid); result.put(&quot;ValidRoles&quot;, validRoles); result = result.toString(); var resultObj = new org.json.JSONObject(result); var result_Approver = new org.json.JSONArray(); result_Approver = resultObj.get(&quot;ValidRoles&quot;); var getUserForApproval = new Array(); var getFormattedApprovalRoles = new Array(); //CR 28468 if (result_Approver.length() != 0) { println(&quot;# Length of Aprover result -: &quot; + result_Approver.length()); var i = 0; for (i = 0; i &lt; result_Approver.length(); i++) { var Role_JsonResult = result_Approver.get(i); println(&quot;############ In WF_NS_PriceStructure_createTaskForApprovalRoles : i : &quot; + i + &quot;, Role_JsonResult :&quot; + Role_JsonResult); if (RoleString == &quot;&quot;) { RoleString = Role_JsonResult; } else { RoleString = RoleString + &quot;,&quot; + Role_JsonResult; } var usersArray = helper.getUsersForRole(Role_JsonResult); var j = 0; if (usersArray != null &amp;&amp; usersArray.length != 0) { for (j = 0; j &lt; usersArray.length; j++) { getUserForApproval.push(usersArray[j]); } } getFormattedApprovalRoles.push(&quot;@RoleName{&quot; + Role_JsonResult + &quot;}&quot;); //CR 28468 } if (getUserForApproval.length != 0) { helper.createTaskInstance(getFormattedApprovalRoles, executionContext, &quot;Approve-Reject Task&quot;); taskAssineeString = taskUserString(getUserForApproval); println(&quot;#Task created for Approve-Reject&quot; + executionContext.getVariable(&quot;Approve_Level&quot;) + &quot;PS&quot;); executionContext.setVariable(&quot;CurrentRole&quot;, RoleString); println(&quot;# Role string is -: &quot; + RoleString); return taskAssineeString.toString(); } else { println(&quot;# No User found for the given role&quot;); return; } } else { println(&quot;# No Role found for the given scope for approval&quot;); println(&quot;# Assigning tha approval task to Administrator&quot;); var getAdminRole_User = helper.getUsersForRole(&quot;Administrator&quot;); taskAssineeString = taskUserString(getAdminRole_User); helper.createTaskInstance(['@RoleName{Administrator}'], executionContext, &quot;Approve-Reject Task&quot;); RoleString = &quot;Administrator&quot;; executionContext.setVariable(&quot;CurrentRole&quot;, RoleString); println(&quot;# Role string is -: &quot; + RoleString); return taskAssineeString.toString(); } } /** * It is called from `WF_NS_PS_Generic.Approved_NodeEnter_Execute` it creates Task for all the Delegates with * approval permission on the Price Plan * @function * @name WF_NS_PriceStructure_createTaskForPublisher * @memberof module:WF_NS_PriceStructure * @param {Object} executionContext Workflow Execution Context */ function WF_NS_PriceStructure_createTaskForPublisher(publisherRoles, executionContext) { println(&quot;#I am inside Node Enter event of Published&quot;); var requiredFieldsArray = createTemplatePSAttributeList(); //putTemplateRequiredInfoFromReportInExecutionContext(requiredFieldsArray,&quot;PriceStructureExt&quot;,executionContext); var contextInstance = getContextInstance(executionContext); var taskAssineeString = &quot;&quot;; var RoleString = &quot;&quot;; var helper = new com.vistaar.workflow.util.WorkflowHelper(); var result_Publisher = publisherRoles; var getUserForPublish = new Array(); var getFormattedPubishRoles = new Array(); //CR 28468 if (result_Publisher.length() != 0) { println(&quot;# Length of Aprover result -: &quot; + result_Publisher.length()); var i = 0; for (i = 0; i &lt; result_Publisher.length(); i++) { var Role_JsonResult = result_Publisher.get(i); if (RoleString == &quot;&quot;) { RoleString = Role_JsonResult; } else { RoleString = RoleString + &quot;,&quot; + Role_JsonResult; } var usersArray = helper.getUsersForRole(Role_JsonResult); var j = 0; if (usersArray != null &amp;&amp; usersArray.length != 0) { for (j = 0; j &lt; usersArray.length; j++) { getUserForPublish.push(usersArray[j]); } } getFormattedPubishRoles.push(&quot;@RoleName{&quot; + Role_JsonResult + &quot;}&quot;); //CR 28468 } if (getUserForPublish.length != 0) { helper.createTaskInstance(getFormattedPubishRoles, executionContext, &quot;Publish Task&quot;); //CR 28468 taskAssineeString = taskUserString(getUserForPublish); println(&quot;#Task created for Publish&quot; + &quot;PS&quot;); executionContext.setVariable(&quot;CurrentRole&quot;, RoleString); println(&quot;# Role string is -: &quot; + RoleString); return taskAssineeString.toString(); } else { println(&quot;# No User found for the given role&quot;); return; } } else { println(&quot;# No Role found for the given scope for pubish&quot;); println(&quot;# Assigning the publish task to Administrator&quot;); var getAdminRole_User = helper.getUsersForRole(&quot;Administrator&quot;); taskAssineeString = taskUserString(getAdminRole_User); helper.createTaskInstance(['@RoleName{Administrator}'], executionContext, &quot;Publish Task&quot;); //CR 28468 RoleString = &quot;Administrator&quot;; executionContext.setVariable(&quot;CurrentRole&quot;, RoleString); println(&quot;# Role string is -: &quot; + RoleString); return taskAssineeString.toString(); } } function taskUserString(usersArray) { println(&quot;# taskUserString Called&quot;); var i = 0; var AssineeString = &quot;&quot;; for (i = 0; i &lt; usersArray.length; i++) { if (AssineeString == &quot;&quot;) { AssineeString = usersArray[i]; } else { AssineeString = AssineeString + &quot;;&quot; + usersArray[i]; } } return AssineeString.toString(); } /** * Runs from process definition * @function * @name WF_NS_PriceStructure_getNotificationUserString * @memberof module:WF_NS_PriceStructure * @param {Object} executionContext Workflow Execution Context * @example * &lt;state name=&quot;Published&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;setPublisherRoles_PS&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Published&quot;); var NotifierString = WF_NS_PriceStructure_getNotificationUserString(executionContext); println(&quot;Notifier User String : &quot; + NotifierString); executionContext.setVariable(&quot;NotifyMailUser&quot;,NotifierString); @--&gt; &lt;/javascript&gt; &lt;/action&gt; */ function WF_NS_PriceStructure_getNotificationUserString(executionContext) { var PricePlanUser = executionContext.getVariable(&quot;PricePlanUser&quot;); println(&quot;# Notification routine called &quot;); var requiredFieldsArray = createTemplatePSAttributeList(); //putTemplateRequiredInfoFromReportInExecutionContext(requiredFieldsArray,&quot;PriceStructureExt&quot;,executionContext); var RoleString = &quot;&quot;; var taskAssineeString = &quot;&quot;; var DefinitionType = &quot;PricePlan&quot;; var workflow_State = executionContext.getVariable(&quot;CurrentState&quot;); var scope = executionContext.getVariable(&quot;Scope&quot;); var scopeJSONObj = new org.json.JSONObject(scope); var userConnInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var permissionAdapter = new PermissionMtxAdapter_Intf(); permissionAdapter.Init(docProvider, userConnInfo); var notifierInfo = permissionAdapter.getNotifier(DefinitionType, scopeJSONObj, workflow_State); var helper = new com.vistaar.workflow.util.WorkflowHelper(); println(&quot;notifierInfo: &quot; + notifierInfo); var notifierRoles; var blnSentNotification = true; try { println(&quot;executionContext &gt;&gt; &quot; + executionContext.toString()); blnSentNotification = executionContext.getVariable(&quot;blnSentNotification&quot;); } catch (e) { println(&quot;Got Exception for blnSentNotification&quot;); blnSentNotification = true; } println(&quot;blnSentNotification &gt;&gt; &quot; + blnSentNotification); if (notifierInfo.has(&quot;Delegates&quot;)) { notifierRoles = notifierInfo.get(&quot;Delegates&quot;); notifierRoles = new org.json.JSONArray(notifierRoles.toString()); } else notifierRoles = new org.json.JSONArray(); var getUserForNotification = new Array(); var ps_creatorRole = executionContext.getVariable(&quot;PS_CreatorRole&quot;); notifierRoles.put(ps_creatorRole); if (executionContext.getVariable(&quot;isAutoPublish&quot;) == false) { notifierRoles.put(&quot;Administrator&quot;); } //println(&quot;executionContext.getApprover &gt;&gt;&gt; &quot; + executionContext.getVariable(&quot;isAutoPublish&quot;)); // var ActorHistoryInfo = executionContext.getVariable(&quot;ActorHistoryInfo&quot;); var ActorHistoryInfoJSON = new JSONObject(ActorHistoryInfo); for (var attributeItr = ActorHistoryInfoJSON.keys(); attributeItr.hasNext();) { var key = attributeItr.next(); var roles = ActorHistoryInfoJSON.get(key); var roleArrObj = new JSONArray(roles); var Level = Number(key.replace('Level', '')); for (var i = roleArrObj.length() - 1; i &gt;= 0; i--) { notifierRoles.put(roleArrObj.get(i)); } } println(&quot;notifierRoles &gt;&gt; &quot; + notifierRoles); if (notifierRoles.length() != 0) { println(&quot;# Length of Notifier result -: &quot; + notifierRoles.length()); for (var i = 0, resultNitifierLength = notifierRoles.length(); i &lt; resultNitifierLength; i++) { var Role_JsonResult = notifierRoles.get(i); if (RoleString == &quot;&quot;) { RoleString = Role_JsonResult; } else { RoleString = RoleString + &quot;,&quot; + Role_JsonResult; } var usersArray = helper.getUsersForRole(Role_JsonResult); if (usersArray != null &amp;&amp; usersArray.length != 0) { for (var j = 0, usersArrayLength = usersArray.length; j &lt; usersArrayLength; j++) { getUserForNotification.push(usersArray[j]); } } } if (getUserForNotification.length != 0) { taskAssineeString = taskUserString(getUserForNotification); println(&quot;# Role string is -: &quot; + RoleString); println(&quot;# Task Assinee string is -: &quot; + taskAssineeString); if (blnSentNotification == false) { taskAssineeString = &quot;&quot;; return taskAssineeString; } println(&quot;Final taskAssineeString &gt;&gt; &quot; + taskAssineeString); if (PricePlanUser == null) return getUniqueMalString(taskAssineeString.toString()); return getUniqueMalString(taskAssineeString.toString() + &quot;;&quot; + PricePlanUser); } else { println(&quot;# No Notifier found for the given role&quot;); return; } } else { println(&quot;# No Role found for the given scope for Notification&quot;); var getAdminRole_User = &quot;&quot;; taskAssineeString = taskUserString(getAdminRole_User); if (blnSentNotification == false) { taskAssineeString = &quot;&quot;; } println(&quot;Final taskAssineeString &gt;&gt; &quot; + taskAssineeString); return taskAssineeString.toString(); } } function putTemplateRequiredInfoFromReportInExecutionContext(library, executionContext) { println(&quot;WF_NS_PriceStructure---putTemplateRequiredInfoFromReportInExecutionContext&quot;); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var userInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var colValMap = new java.util.HashMap(); var options = new java.util.HashMap(); colValMap.put(&quot;Document Id&quot;, executionContext.getVariable(&quot;documentId&quot;)); try { var requiredFieldsArray = new JSONArray(); requiredFieldsArray.put(&quot;Region Name&quot;); requiredFieldsArray.put(&quot;Pricing Market Name&quot;); requiredFieldsArray.put(&quot;Price Category Name&quot;); requiredFieldsArray.put(&quot;Year&quot;); var comboPSDocument = docProvider.getAllDocs(library, colValMap, userInfo, options); var comboPSJSONDocument = new org.json.JSONArray(comboPSDocument); var comboDoc = new org.json.JSONObject(comboPSJSONDocument.get(0)); println(&quot;Combo Doc &quot; + comboDoc); if (comboPSJSONDocument != null &amp;&amp; comboPSJSONDocument.length() != 0) { for (var index = 0; index &lt; requiredFieldsArray.length(); index++) { if (comboDoc.has(requiredFieldsArray.get(index))) { if (comboDoc.get(requiredFieldsArray.get(index)) != null &amp;&amp; org.json.JSONObject.NULL != comboDoc.get(requiredFieldsArray.get(index))) { executionContext.setVariable(requiredFieldsArray.get(index), org.json.JSONObject(comboPSJSONDocument.get(0)).get(requiredFieldsArray.get(index))); println(&quot;#############&quot; + org.json.JSONObject(comboPSJSONDocument.get(0)).get(requiredFieldsArray.get(index)) + &quot;#################&quot;); } else { executionContext.setVariable(requiredFieldsArray.get(index), &quot;&quot;); println(&quot;############# NULL VALUE SET #################&quot;); } } else { executionContext.setVariable(requiredFieldsArray.get(index), &quot;&quot;); println(&quot;############# NULL VALUE SET #################&quot;); } } } else { println(&quot;No record exists for given DocID!!&quot;); } } catch (error) { println(&quot;execution of getAllDocs api failed!!!&quot;); throw (error); } } function createTemplatePSAttributeList() { println(&quot;WF_NS_PriceStructure ---- createTemplatePSAttributeList &quot;); attributeList = new org.json.JSONArray(); attributeList.put(&quot;Distributor&quot;); attributeList.put(&quot;Effective Date&quot;); attributeList.put(&quot;Proof&quot;); attributeList.put(&quot;Supply Type&quot;); attributeList.put(&quot;Geography&quot;); attributeList.put(&quot;Product&quot;); return attributeList; } //This function takes the system fields of a document as an input and performs a WF task as per the Action specified. /** * Execute Workflow Operation * @param {object} systemFieldsObject System Fields * @param {object} wfConnectionObj Workflow Connection Object * @param {object} userConnInfo User Connection Info */ function g_ExecuteWorkflowOperation(systemFieldsObject, wfConnectionObj, userConnInfo) { var wfConnectionObj = com.vistaar.workflow.core.WorkflowManagerImpl.getInstance(); var action = systemFieldsObject.get(&quot;Action&quot;); var comment = systemFieldsObject.get(&quot;Comments&quot;); if (systemFieldsObject.has(&quot;What&quot;)) { var What = systemFieldsObject.get(&quot;What&quot;); } else { var What = &quot;&quot;; } if (systemFieldsObject.has(&quot;HTMLComments&quot;)) { var HTMLComments = systemFieldsObject.get(&quot;HTMLComments&quot;); } else { var HTMLComments = &quot;&quot;; } if (systemFieldsObject.has(&quot;RejectRecallSubject&quot;)) { var RejectRecallSubject = systemFieldsObject.get(&quot;RejectRecallSubject&quot;); } else { var RejectRecallSubject = &quot;&quot;; } if (systemFieldsObject.has(&quot;RejectRecallMsg1&quot;)) { var RejectRecallMsg1 = systemFieldsObject.get(&quot;RejectRecallMsg1&quot;); } else { var RejectRecallMsg1 = &quot;&quot;; } if (systemFieldsObject.has(&quot;RejectRecallMsg2&quot;)) { var RejectRecallMsg2 = systemFieldsObject.get(&quot;RejectRecallMsg2&quot;); } else { var RejectRecallMsg2 = &quot;&quot;; } if (systemFieldsObject.has(&quot;RejectRecallRole&quot;)) { var RejectRecallRole = systemFieldsObject.get(&quot;RejectRecallRole&quot;); } else { var RejectRecallRole = &quot;&quot;; } if (systemFieldsObject.has(&quot;wfTransition&quot;)) { var wfTransition = systemFieldsObject.get(&quot;wfTransition&quot;); } else { var wfTransition = &quot;&quot;; } if (systemFieldsObject.has(&quot;IsNonPostingMarket&quot;)) { var IsNonPostingMarket = systemFieldsObject.get(&quot;IsNonPostingMarket&quot;); } else { var IsNonPostingMarket = &quot;&quot;; } if (systemFieldsObject.has(&quot;IsFuturePlanning&quot;)) { var IsFuturePlanning = systemFieldsObject.get(&quot;IsFuturePlanning&quot;); } else { var IsFuturePlanning = &quot;&quot;; } if (systemFieldsObject.has(&quot;Product Name&quot;)) { var productName = systemFieldsObject.get(&quot;Product Name&quot;); } else { var productName = &quot;&quot;; } if (systemFieldsObject.has(&quot;Geography Name&quot;)) { var geographyName = systemFieldsObject.get(&quot;Geography Name&quot;); } else { var geographyName = &quot;&quot;; } if (systemFieldsObject.has(&quot;Year&quot;)) { var year = systemFieldsObject.get(&quot;Year&quot;); } else { var year = &quot;&quot;; } if (systemFieldsObject.has(&quot;Region Name&quot;)) { var regionName = systemFieldsObject.get(&quot;Region Name&quot;); } else { var regionName = &quot;&quot;; } if (systemFieldsObject.has(&quot;Time Code&quot;)) { var timeCode = systemFieldsObject.get(&quot;Time Code&quot;); } else { var timeCode = &quot;&quot;; } if (systemFieldsObject.has(&quot;Geography Code&quot;)) { var geographyCode = systemFieldsObject.get(&quot;Geography Code&quot;); } else { var geographyCode = &quot;&quot;; } if (systemFieldsObject.has(&quot;Product Code&quot;)) { var productCode = systemFieldsObject.get(&quot;Product Code&quot;); } else { var productCode = &quot;&quot;; } if (systemFieldsObject.has(&quot;Region Code&quot;)) { var regionCode = systemFieldsObject.get(&quot;Region Code&quot;); } else { var regionCode = &quot;&quot;; } if (systemFieldsObject.has(&quot;Brand Code&quot;)) { var brandCode = systemFieldsObject.get(&quot;Brand Code&quot;); } else { var brandCode = &quot;&quot;; } if (systemFieldsObject.get(&quot;System Fields&quot;).has(&quot;Document Id&quot;)) { var docID = systemFieldsObject.get(&quot;System Fields&quot;).get(&quot;Document Id&quot;); } else { var docID = &quot;&quot;; } if (systemFieldsObject.has(&quot;URL&quot;)) { var webURL = systemFieldsObject.get(&quot;URL&quot;); var rgSpace = RegExp(/\\s/g); var rgDoubleQuote = RegExp(/&quot;/g); webURL = webURL + '?PricePlan={&quot;Operation&quot;:&quot;Open Price Plan&quot;,&quot;Input&quot;:{&quot;ScopeData&quot;:{&quot;Geography Level&quot;:&quot;Market&quot;,&quot;Geography Code&quot;:&quot;' + geographyCode + '&quot;,&quot;Time Level&quot;:&quot;Year&quot;,&quot;Time&quot;:&quot;' + timeCode + '&quot;,&quot;Product Code&quot;:&quot;' + productCode + '&quot;,&quot;Product Level&quot;:&quot;Price Category&quot;,&quot;Region Code&quot;:&quot;' + regionCode + '&quot;,&quot;Brand Code&quot;:&quot;' + brandCode + '&quot;}}}'; webURL = webURL.replace(rgSpace, '%20'); webURL = webURL.replace(rgDoubleQuote, '%22'); } else { var webURL = &quot;&quot;; } println(&quot;webURL &gt; &quot; + webURL); var processInstanceKey = systemFieldsObject.get(&quot;System Fields&quot;).get(&quot;WorkFlowProcessInstanceKey&quot;); var processDefinitionName = systemFieldsObject.get(&quot;System Fields&quot;).get(&quot;WorkFlowProcessDef&quot;); println(&quot;processInstanceKey &gt;&gt; &quot; + processInstanceKey); println(&quot;processDefinitionName &gt;&gt; &quot; + processDefinitionName); var activeNodesInfo = wfConnectionObj.getActiveNodes(processDefinitionName, processInstanceKey); println(&quot;activeNodesInfo &gt;&gt; &quot; + activeNodesInfo); var actNodeInfo = activeNodesInfo[0]; var activeNodeId = actNodeInfo.getNodeId(); var processInstanceId = actNodeInfo.getInstanceId(); systemFieldsObject.put(&quot;ProcessInstanceId&quot;, processInstanceId); var contextVariables = wfConnectionObj.getContextVariables(processInstanceId); //println(&quot;contextVariables &gt;&gt; &quot; + contextVariables); //println(&quot;&gt;&gt;&gt; &quot; + actNodeInfo.nodeType); // var PricePlanUser = contextVariables.get(&quot;PricePlanUser&quot;); println('Price Plan User &gt;' + PricePlanUser); if (PricePlanUser == null) { PricePlanUser = userConnInfo.getUserName(); } else { PricePlanUser = PricePlanUser + &quot;;&quot; + userConnInfo.getUserName(); } if (actNodeInfo.nodeType.equals(&quot;Task&quot;)) { contextVariables.put(&quot;Comments&quot;, comment); contextVariables.put(&quot;What&quot;, What); contextVariables.put(&quot;HTMLComments&quot;, HTMLComments); contextVariables.put(&quot;RejectRecallSubject&quot;, RejectRecallSubject); contextVariables.put(&quot;RejectRecallMsg1&quot;, RejectRecallMsg1); contextVariables.put(&quot;RejectRecallMsg2&quot;, RejectRecallMsg2); contextVariables.put(&quot;RejectRecallRole&quot;, RejectRecallRole); contextVariables.put(&quot;UserDecision&quot;, action); contextVariables.put(&quot;IsNonPostingMarket&quot;, IsNonPostingMarket); contextVariables.put(&quot;IsFuturePlanning&quot;, IsFuturePlanning); contextVariables.put(&quot;Product Name&quot;, productName); contextVariables.put(&quot;Geography Name&quot;, geographyName); contextVariables.put(&quot;Region Name&quot;, regionName); contextVariables.put(&quot;Year&quot;, year); contextVariables.put(&quot;Geography Code&quot;, geographyCode); contextVariables.put(&quot;Product Code&quot;, productCode); contextVariables.put(&quot;Time Code&quot;, timeCode); contextVariables.put(&quot;Document Id&quot;, docID); contextVariables.put(&quot;URL&quot;, webURL); contextVariables.put(&quot;PricePlanUser&quot;, PricePlanUser); //ET#1534 contextVariables.put(&quot;MyActorId&quot;, userConnInfo.getUserName()); println(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;before executeTasks&quot;); if (wfTransition == &quot;Reject&quot;) { contextVariables.put(&quot;isRejectFlg&quot;, true); } else if (wfTransition == &quot;Recall&quot;) { contextVariables.put(&quot;isRejectFlg&quot;, false); } var taskInstanceInfo = wfConnectionObj.getTasksForNode(processInstanceId, activeNodeId); var taskInfo = new com.vistaar.workflow.dataobjects.TaskExecutionInfo(taskInstanceInfo[0].getTaskId(), comment, null, contextVariables); var taskInfoList = new Array(); taskInfoList[0] = taskInfo; var actorId = userConnInfo.getUserName(); println(&quot;taskInfoList : &quot; + taskInfoList); try { wfConnectionObj.executeTasks(taskInfoList, actorId, userConnInfo); } catch (e) { throw new Error(e); } } else if (actNodeInfo.nodeType.equals(&quot;State&quot;)) { var l_LocalPropsMap = new java.util.HashMap(); var removablePersistantPropsArray = new Array(); if (systemFieldsObject.has(&quot;persistentParamMap&quot;)) { var persistentParamMapObject = systemFieldsObject.get(&quot;persistentParamMap&quot;); var persistantProps = new java.util.HashMap(); var removablePersistantPropsArrayCounter = 0; for (var itr = persistentParamMapObject.keys(); itr.hasNext();) { var key = itr.next(); persistantProps.put(key, persistentParamMapObject.get(key).get(&quot;Value&quot;)); println(&quot;Adding Persistent Property: &quot; + key + &quot; &quot; + persistentParamMapObject.get(key).get(&quot;Value&quot;)); if (persistentParamMapObject.get(key).has(&quot;DeletePostWFExecution&quot;) &amp;&amp; persistentParamMapObject.get(key).get(&quot;DeletePostWFExecution&quot;) == true) { removablePersistantPropsArray[removablePersistantPropsArrayCounter] = key; removablePersistantPropsArrayCounter++; } } if (persistantProps.size() != 0) { println(&quot;------------context variables set---------------&quot;); wfConnectionObj.setContextVariables(processInstanceId, persistantProps); } } if (systemFieldsObject.has(&quot;localParamMap&quot;)) { l_LocalPropsMap = systemFieldsObject.get(&quot;localParamMap&quot;); } try { println(&quot;***************** Execute Transition called for State Node *****************&quot;); if (wfTransition == &quot;Reject&quot;) { persistantProps.put(&quot;isRejectFlg&quot;, true); } else if (wfTransition == &quot;Recall&quot;) { persistantProps.put(&quot;isRejectFlg&quot;, false); } wfConnectionObj.executeTransition(processInstanceId, activeNodeId, action, l_LocalPropsMap, persistantProps, userConnInfo); } catch (e) { throw new Error(&quot;Execute Transition has failed.&quot;); println(e); } if (removablePersistantPropsArray.length != 0) { println(&quot;-------------Removing Context Variables---------------&quot; + removablePersistantPropsArray); wfConnectionObj.deleteContextVariables(processInstanceId, removablePersistantPropsArray); } } } function getApprovalLevel(systemFieldsObject, wfConnectionObj) { var wfConnectionObj = com.vistaar.workflow.core.WorkflowManagerImpl.getInstance(); var processInstanceKey = systemFieldsObject.get(&quot;System Fields&quot;).get(&quot;WorkFlowProcessInstanceKey&quot;); var processDefinitionName = systemFieldsObject.get(&quot;System Fields&quot;).get(&quot;WorkFlowProcessDef&quot;); //println(&quot;processInstanceKey &gt;&gt; &quot; + processInstanceKey); //println(&quot;processDefinitionName &gt;&gt; &quot; + processDefinitionName); var activeNodesInfo = wfConnectionObj.getActiveNodes(processDefinitionName, processInstanceKey); //println(&quot;activeNodesInfo &gt;&gt; &quot; + activeNodesInfo); var actNodeInfo = activeNodesInfo[0]; var activeNodeId = actNodeInfo.getNodeId(); var processInstanceId = actNodeInfo.getInstanceId(); systemFieldsObject.put(&quot;ProcessInstanceId&quot;, processInstanceId); var contextVariables = wfConnectionObj.getContextVariables(processInstanceId); var approvalLevel = contextVariables.get(&quot;Approve_Level&quot;); return approvalLevel; } function g_checkLockDocument(executionContext) { var startTime = new Date(); println(&quot;---------------------------CheckLockDocument Script Started-------------------------------&quot;); var PSExpiryObject = g_getPSExpiryObject(g_activePSDefinition); println(&quot;PSExpiryObject : &quot; + PSExpiryObject); if (PSExpiryObject.length() != 0) { var libraryName = executionContext.getVariable(&quot;libraryName&quot;); var psDocument = WF_NS_PS_Generic.GetPriceStructure(executionContext); var psDefinitionName = g_activePSDefinition; // executionContext.getVariable(&quot;PSDefinitionName&quot;); var docServerManager = getJBPMConfigObject(VAR_DOCPROVIDER); var userConnInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); scope = g_getScopeFromDocument(psDocument, psDefinitionName); var lastPublishedPSDocument = g_getLastOrNextPublishedData(libraryName, scope, psDefinitionName, false, docServerManager, userConnInfo); if (lastPublishedPSDocument.has(&quot;System Fields&quot;)) { var lockUser = lastPublishedPSDocument.get(&quot;System Fields&quot;).get(&quot;Lock Owner&quot;); if (!lockUser.equals(&quot;&quot;)) { if (!lockUser.equals(userConnInfo.getUserName())) { //executionContext.setVariable(&quot;Lock User&quot;, lockUser); //var scopeString = generateScopeString(lastPublishedPSDocument); var message = &quot;Price Structure Publish operation could not be completed successfully because system could not update previous Published Price Structure which is currently being used by user &quot; + lockUser; if (PSExpiryObject.has(&quot;JSMessage&quot;) &amp;&amp; PSExpiryObject.get(&quot;JSMessage&quot;).has(&quot;LockDocument&quot;)) { var message = PSExpiryObject.get(&quot;JSMessage&quot;).get(&quot;LockDocument&quot;).get(&quot;FailureMessage&quot;); var Config = PSExpiryObject.get(&quot;JSMessage&quot;).get(&quot;LockDocument&quot;).get(&quot;ScopeStringConfig&quot;); var scopeString = generateScopeString(lastPublishedPSDocument, Config); message = message.replace(&quot;&lt;scopeString&gt;&quot;, scopeString); message = message.replace(&quot;&lt;lockUser&gt;&quot;, lockUser); } throw message; } } } } println(&quot;---------------------------CheckLockDocument Script Ended-------------------------------&quot;); var endTime = new Date(); println(&quot;Time taken for CheckLockDocument : &quot; + (endTime - startTime)); } function generateScopeString(PSDocument, Config) { var scope = &quot;&quot;; var length = Config.get(&quot;Config&quot;).length(); var separator = Config.get(&quot;Separator&quot;); for (var iCount = 0; iCount &lt; length; iCount++) { var obj = Config.get(&quot;Config&quot;).get(iCount); var fetchType = obj.get(&quot;Fetch Type&quot;); if (fetchType.equals(&quot;Master Entity&quot;)) { var master = obj.get(&quot;Master&quot;); var level = obj.get(&quot;Level&quot;) + &quot;&quot;; var levelArray = level.split(&quot;.&quot;); var value = new JSONObject(PSDocument.toString()); for (var jCount = 0; jCount &lt; levelArray.length; jCount++) { value = value.get(levelArray[jCount]); } level = value; value = new JSONObject(PSDocument.toString()); var code = obj.get(&quot;Code&quot;) + &quot;&quot;; var codeArray = code.split(&quot;.&quot;); for (var jCount = 0; jCount &lt; codeArray.length; jCount++) { value = value.get(codeArray[jCount]); } code = value; var outputKey = obj.get(&quot;Output&quot;); if (NormalizedHierachiesMap.containsKey(master) &amp;&amp; NormalizedHierachiesMap.get(master).containsKey(level)) { value = NormalizedHierachiesMap.get(master).get(level).get(code).get(outputKey); } else { //Query for Master Entity. var queryString = '{&quot;ConditionOperator&quot;:&quot;And&quot;,&quot;Condition&quot;:[{&quot;FieldName&quot;:&quot;Code&quot;,&quot;Value&quot;:{&quot;Type&quot;:&quot;Text&quot;,&quot;Content&quot;:&quot;' + code + '&quot;},&quot;ConditionType&quot;:&quot;=&quot;},{&quot;FieldName&quot;:&quot;Level Code&quot;,&quot;Value&quot;:{&quot;Type&quot;:&quot;Text&quot;,&quot;Content&quot;:&quot;' + level + '&quot;},&quot;ConditionType&quot;:&quot;=&quot;}]}'; var optionsParam = new HashMap(); optionsParam.put(&quot;ColumnOptions&quot;, &quot;DocumentColumn&quot;); var result = docServerManager.getJSONDocsByQuery(master, queryString, userConnInfo, optionsParam); value = result.get(0).get(outputKey); } value = NormalizedHierachiesMap.get(master).get(level).get(code).get(outputKey); } else if (fetchType.equals(&quot;Document&quot;)) { var value = new JSONObject(PSDocument.toString()); var out = obj.get(&quot;Output&quot;) + &quot;&quot;; var keyArray = out.split(&quot;.&quot;); for (var jCount = 0; jCount &lt; keyArray.length; jCount++) value = value.get(keyArray[jCount]); } if (typeof(updateScopeValueForCustomMessage) === 'function') //if solution function defined to update value. { value = updateScopeValueForCustomMessage(value, obj); } scope = scope + value; if (iCount &lt; length - 1) scope = scope + separator; } return scope; } function getUniqueMalString(stringValue) { var sourceString = stringValue.split(&quot;;&quot;); var mailStringJSON = new JSONObject(); var mailStringArr = new JSONArray(); var mailString = &quot;&quot;; for (var i = 0; i &lt; sourceString.length; i++) { if (!mailStringJSON.has(sourceString[i])) { mailStringJSON.put(sourceString[i], sourceString[i]); mailStringArr.put(sourceString[i]); } } for (var m = 0; m &lt; mailStringArr.length(); m++) { mailString = mailString + &quot;;&quot; + mailStringArr.get(m) + &quot;;&quot;; } //var mailString = mailStringArr.toString(); //mailString = mailString.replace(&quot;,&quot;, &quot;;&quot;); return mailString; } × Search results Close "},"PricePlanBestPractices.js.html":{"id":"PricePlanBestPractices.js.html","title":"Source: PricePlanBestPractices.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: PricePlanBestPractices.js /****************************************************************************** This work contains or references Vistaar generic components or Vistaar API, and is developed in accordance with Vistaar best practices and solution development guidelines. This work is designed and intended to be used only with licensed Vistaar software. ********************************************************************************/ /** * @namespace WebUI */ /** * &lt;p&gt; &lt;img uml=&quot;actor user rectangle PricePlanBestPractice { user -- (show) (show) --&gt; (evalBestPractice &amp; setCountOfBestPractice) }&quot;&gt;&lt;/p&gt; * @class * @memberof WebUI */ function PricePlanBestPracticesManager() { var m_PricePlanViolationObject; var m_PricePlanBestPracticePopupObject; var m_arrMonths = [&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;]; var m_FactCode = [&quot;Bill_FOB&quot;, &quot;Shelf&quot;, &quot;Net_List_ATAX&quot;]; // 19Oct15 var m_TGOBJECT = &quot;TGObj&quot;; var m_DGSUMMARYPROPOSED = &quot;grdSummaryProposed&quot;; var m_TGOFFPREMISESPROPOSED = &quot;TG_OffPremisesProposed&quot;; var m_TGOONPREMISESPROPOSED = &quot;TG_OnPremisesProposed&quot;; var m_TGOFFPREMISESCURRENT = &quot;TG_OffPremisesCurrent&quot;; var m_TGONPREMISESCURRENT = &quot;TG_OnPremisesCurrent&quot;; var m_objTreeGridOff; var m_objTreeGridOn; var m_objSummaryTreeGrid; var m_CurGrdMapping; var m_ProGrdMapping; var m_EditableFrom; var m_HistorEditFrom; var m_PGEffectivity; var m_notificationTemplate = &quot;&lt;div&gt;&lt;div class='clsNotificationDataDiv'&gt;PLACE_HOLDER_FOR_MESSAGE&lt;/div&gt; &lt;button type='button' class='clsBestCloseBtn' onclick='getObjectFactory().getPricePlanControllerManager().getPricePlanUIManager().getPriceBestPracticeManager().hideBestPracticePopup()' title='Close Best Practice'&gt;&lt;/div&gt; &quot;; /*var m_notificationTemplate = &quot;&lt;div&gt;&lt;div class='clsNotificationDataDiv'&gt;PLACE_HOLDER_FOR_MESSAGE&lt;/div&gt; &lt;button type='button' class='clsBestCloseBtn' onclick='getObjectFactory().getPricePlanControllerManager().getPricePlanUIManager().getPriceBestPracticeManager().hideBestPracticePopup()' ontouchstart='getObjectFactory().getPricePlanControllerManager().getPricePlanUIManager().getPriceBestPracticeManager().hideBestPracticePopup()' title='Close Best Practice'&gt;&lt;/div&gt; &quot;;*/ var m_ON = &quot;ON&quot;; var m_OFF = &quot;OFF&quot;; /** * ### List of Best Practices * * | Type | Best Practice | Message | |---------- |:----------------------: |------------------------------------------------------------------------------------------- | | Hardstop | VolumeNot100 | The % of Business must sum to 100% for each month | | Hardstop | VolumeNotPresent | Deal Line does not have volume entered for the year | | Hardstop | DuplicateNetList | Deal Lines in the same channel cannot have the same Net List in same month | | Hardstop | WPSame | WP cannot be different for the same month across Deal Lines | | Hardstop | DASame | DA cannot be different for the same month across Deal Lines | | Hardstop | IncompletePriceLine | Deal Line is missing required inputs | | Softstop | RABNegative | RAB cannot be negative | | Softstop | ProposedNetFOBDeeeper | Proposed Priceline Net FOB is deeper than current | | Softstop | ProposedNetListDeeeper | Proposed Priceline Net List is deeper than current | | Softstop | MinNetFOBGuidance | Net FOB is below guidance value | | Softstop | MinNetListGuidance | Net list is below guidance value | | Softstop | MinRABGuidance | RAB is below guidance value | | Softstop | AvgRABGuidance | Avg full Year RAB is below guidance value | | Softstop | AvgNetFOBGuidance | Avg full Year Net FOB is below guidance value | | Softstop | AvgPYNetFOBGuidance | Avg full Year Net FOB is below previous year avg full Year Net FOB | | Softstop | NegativePerctBusiness | Percentage of business is negative | | Softstop | MinDaysToChange | This is a posting market. Please make sure pricing is submitted within the posting window | | Softstop | AvgVolumeGuidance | Full year volume percent for Priceline is either below or above threshold | | Softstop | AvgFOBDecreased | Proposed Avg FOB decreased from Current Avg FOB | &lt;p&gt; &lt;img uml=&quot; object BestPractice { count = 0 text = The % of Business must sum to 100% for each month list = List of Locations type = HardStop/SoftStop isReadOnly = false } &quot;&gt; &lt;/p&gt; * @type {Object} * */ var m_objlistPractices = { &quot;VolumeNot100&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;The % of Business must sum to 100% for each month&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;HardStop&quot;, &quot;isReadOnly&quot;: false }, &quot;VolumeNotPresent&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Deal Line does not have volume entered for the year&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;HardStop&quot;, &quot;isReadOnly&quot;: false }, &quot;DuplicateNetList&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Deal Lines in the same channel cannot have the same Net List in same month&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;HardStop&quot;, &quot;isReadOnly&quot;: false }, &quot;WPSame&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;WP cannot be different for the same month across Deal Lines&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;HardStop&quot;, &quot;isReadOnly&quot;: false }, &quot;DASame&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;DA cannot be different for the same month across Deal Lines&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;HardStop&quot;, &quot;isReadOnly&quot;: false }, &quot;AllowanceDiff&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;∆ SDA &gt; ∆ Net List&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;IncompletePriceLine&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Deal Line is missing required inputs&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;HardStop&quot;, &quot;isReadOnly&quot;: false }, &quot;RABNegative&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;RAB cannot be negative&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;ProposedNetFOBDeeeper&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Proposed priceline Net FOB is deeper than current&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;ProposedNetListDeeeper&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Proposed priceline Net List is deeper than current&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;MinNetFOBGuidance&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Net FOB is below guidance value&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;MinNetListGuidance&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Net list is below guidance value&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;MinRABGuidance&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;RAB is below guidance value&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;AvgRABGuidance&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Avg full Year RAB is below guidance value&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;AvgNetFOBGuidance&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Avg full Year Net FOB is below guidance value&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;AvgPYNetFOBGuidance&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Avg full Year Net FOB is below previous year avg full Year Net FOB&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;NegativePerctBusiness&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Percentage of business is negative&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;HardStop&quot;, &quot;isReadOnly&quot;: false }, &quot;MinDaysToChange&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;This is a posting market. Please make sure pricing is submitted within the posting window&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: true }, &quot;AvgVolumeGuidance&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Full year volume percent for priceline is either below or above threshold&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false }, &quot;AvgFOBDecreased&quot;: { &quot;count&quot;: 0, &quot;text&quot;: &quot;Proposed Avg FOB decreased from Current Avg FOB&quot;, &quot;list&quot;: [], &quot;type&quot;: &quot;SoftStop&quot;, &quot;isReadOnly&quot;: false } }; var m_currentPractice; var m_currentPracticeList; var m_prevCellElement = []; var m_nonManDealsMaster, m_skuManDealsMaster, m_disManDealsMaster, m_disSNDDealsMaster, m_skuSNDDealsMaster; this.getSelectedBestPractice = function(l_text) { for (var practices in m_objlistPractices) { if (m_objlistPractices[practices].text == l_text &amp;&amp; m_objlistPractices[practices].count &gt; 0) { m_currentPractice = practices; return m_objlistPractices[practices]; } } return undefined; }; this.getPreviousBestPractice = function(l_text) { var l_keyarr = []; var bnext = false; var blast; for (var practices in m_objlistPractices) { l_keyarr.push(practices); } for (var i = l_keyarr.length - 1; i &gt;= 0; i--) { if (bnext &amp;&amp; m_objlistPractices[l_keyarr[i]].count &gt; 0 &amp;&amp; m_objlistPractices[l_keyarr[i]].isReadOnly == false) { m_currentPractice = l_keyarr[i]; return m_objlistPractices[l_keyarr[i]]; } else { if (m_objlistPractices[l_keyarr[i]].text == l_text) { bnext = true; } } blast = l_keyarr[i]; }; return this.getPrevNonEmptyBestPractices(); }; this.getNextBestPractice = function(l_text) { var bnext = false; var blast; for (var practices in m_objlistPractices) { if (bnext &amp;&amp; m_objlistPractices[practices].count &gt; 0 &amp;&amp; m_objlistPractices[practices].isReadOnly == false) { m_currentPractice = practices; return m_objlistPractices[practices]; } else { if (m_objlistPractices[practices].text == l_text) { bnext = true; } } blast = practices; }; return this.getNextNonEmptyBestPractices(); }; this.getNextNonEmptyBestPractices = function() { for (var practices in m_objlistPractices) { if (m_objlistPractices[practices].count &gt; 0 &amp;&amp; m_objlistPractices[practices].isReadOnly == false) { return m_objlistPractices[practices]; } } }; this.getPrevNonEmptyBestPractices = function() { var l_keyarr = []; for (var practices in m_objlistPractices) { l_keyarr.push(practices); } for (var i = l_keyarr.length - 1; i &gt;= 0; i--) { if (m_objlistPractices[l_keyarr[i]].count &gt; 0 &amp;&amp; m_objlistPractices[l_keyarr[i]].isReadOnly == false) { return m_objlistPractices[l_keyarr[i]]; } }; }; /** * When user clicks on Best Practice button this function is called * @param {number} l_xPosition X postion * @param {number} l_yPostion Y position * @param {number} l_width Width * @param {number} l_height Height */ this.show = function(l_xPosition, l_yPostion, l_width, l_height) { //Show PP Operation button tray -- IPAD View if (getCommonFuncMgr().isNonDeskTopView() &amp;&amp; !VistaarExtjs.getCmp(&quot;btnExpandCollpseToolBar&quot;).pressed) { VistaarExtjs.getCmp(&quot;btnExpandCollpseToolBar&quot;).toggle(true); getPricePlanControllerManagerObj().getPricePlanUIManager().btn_ExpandCollapsePricePlanTabTool_Click(VistaarExtjs.getCmp(&quot;btnExpandCollpseToolBar&quot;)); } var obj_MenuViolation = Ext.getCmp(&quot;menuBestPractices&quot;); var l_btnpractice = Ext.ComponentQuery.query('button[id=btnBestPractices]')[0]; l_xPosition = l_btnpractice.getX(); l_yPostion = l_btnpractice.getY(); l_width = l_btnpractice.getWidth(); l_height = l_btnpractice.getHeight(); if (m_PricePlanViolationObject == undefined) { m_PricePlanViolationObject = obj_MenuViolation; obj_MenuViolation.showAt(l_xPosition - ((obj_MenuViolation.width) / 2) + (l_width / 2) - 6, l_yPostion + l_height - 5); } else { obj_MenuViolation.showAt(l_xPosition - ((obj_MenuViolation.width) / 2) + (l_width / 2) - 6, l_yPostion + l_height - 5); } /**IPAD related changes**/ obj_MenuViolation.setX(l_xPosition - ((obj_MenuViolation.width) / 2) + (l_width / 2) - 6); obj_MenuViolation.setY(l_yPostion + l_height - 5); Ext.getStore('store_Violations').loadData([]); Ext.getStore('store_Errors').loadData([]); setCursorMode(WAITCURSORMODE, 'menuBestPractices', 'Loading'); Ext.Function.defer(function() { this.evalBestPractice(); this.setCountOfBestPractice(); }, 1000, this); //setDefaultCursor(); }; this.hide = function() { if (m_PricePlanViolationObject != undefined) { m_PricePlanViolationObject.hide(); }; }; this.ishidden = function() { if (m_PricePlanViolationObject == undefined) { return true; } else { return m_PricePlanViolationObject.hidden; } }; /** * Intialize function of Price Plan Best Practice it does following * * Init `m_objlistPractices` object count to zero * * Init SKUMaster and DistributoMaster for Across Channel Best Practices * * Init Current Grid Mapping */ this.initializeModuleObjects = function() { m_CurGrdMapping = {}; m_ProGrdMapping = {}; m_objTreeGridOff = Ext.getCmp([m_TGOFFPREMISESPROPOSED])[m_TGOBJECT]; m_objTreeGridOn = Ext.getCmp([m_TGOONPREMISESPROPOSED])[m_TGOBJECT]; // m_objCurrentTreeGridOn = Ext.getCmp([m_TGONPREMISESCURRENT])[m_TGOBJECT]; // m_objCurrentTreeGridOff = Ext.getCmp([m_TGOFFPREMISESCURRENT])[m_TGOBJECT]; //8Oct15 - create cureent grid data array object m_CurGrdMapping[m_ON] = this.createCurGrdMappingArray(Ext.getCmp([m_TGONPREMISESCURRENT])); m_CurGrdMapping[m_OFF] = this.createCurGrdMappingArray(Ext.getCmp([m_TGOFFPREMISESCURRENT])); //30Oct10 - deeper price line logic change //m_ProGrdMapping[m_ON] = this.createProGrdMappingArray(m_objTreeGridOn); //m_ProGrdMapping[m_OFF] = this.createProGrdMappingArray(m_objTreeGridOff); m_ProGrdMapping[m_ON] = this.createProGrdMappingArray(Ext.getCmp([m_TGONPREMISESCURRENT])); m_ProGrdMapping[m_OFF] = this.createProGrdMappingArray(Ext.getCmp([m_TGOFFPREMISESCURRENT])); m_objSummaryTreeGrid = Ext.getCmp([m_DGSUMMARYPROPOSED])[&quot;DGObj&quot;]; //4Jul16 new DA,WP and Duplicate Net requirement --- AC m_nonManDealsMaster = getPricePlanControllerManagerObj().getActivePricePlanData()['SKUMaster']; m_skuManDealsMaster = getPricePlanControllerManagerObj().getActivePricePlanData()['SKUMaster']; m_disManDealsMaster = getPricePlanControllerManagerObj().getActivePricePlanData()['DistributorMaster']; m_disSNDDealsMaster = getPricePlanControllerManagerObj().getActivePricePlanData()['DistributorMaster']; m_skuSNDDealsMaster = getPricePlanControllerManagerObj().getActivePricePlanData()['SKUMaster']; for (var item in m_objlistPractices) { m_objlistPractices[item].count = 0; m_objlistPractices[item].list = []; //m_objlistPractices[item].isReadOnly = false; } this.loadBestPracticesStore(); }; this.createCurGrdMappingArray = function(p_GridObj) { var l_gridRow; var l_mappingArray = []; var l_data = p_GridObj[m_TGOBJECT].getStore().data; // itrate over data items for (var rowIdx in l_data.items) { l_gridRow = l_data.items[rowIdx]; // check if deal id is present if (l_gridRow.data.DealID &amp;&amp; l_gridRow.data.MetricsType !== &quot;PG&quot;) { l_mappingArray[l_gridRow.data.DealID] = l_gridRow; } } return l_mappingArray; }; this.createProGrdMappingArray = function(p_GridObj) { var l_gridRow; var l_mappingArray = []; //var l_data = p_GridObj.getStore().data;//30Oct10 - deeper price line logic change var l_data = p_GridObj[m_TGOBJECT].getStore().data; var childData = []; // itrate over data items for (var rowIdx in l_data.items) { l_gridRow = l_data.items[rowIdx]; // check if deal id is present if (l_gridRow.data.DealID &amp;&amp; l_gridRow.data.MetricsType !== &quot;PG&quot;) { childData = []; for (var childRowIdx in l_gridRow.childNodes) { childData[l_gridRow.childNodes[childRowIdx].data.FactCode] = l_gridRow.childNodes[childRowIdx].data; } l_mappingArray[l_gridRow.data.DealID] = childData; } } return l_mappingArray; }; this.loadBestPracticesStore = function() { var l_arrBestListHS = []; var l_arrBestListSS = []; setCursorMode(DEFAULTCURSORMODE, 'menuBestPractices', 'Loading'); for (var practices in m_objlistPractices) { if (m_objlistPractices[practices].count &gt; 0 &amp;&amp; m_objlistPractices[practices].type == 'HardStop') { l_arrBestListHS.push(m_objlistPractices[practices]); } if (m_objlistPractices[practices].count &gt; 0 &amp;&amp; m_objlistPractices[practices].type == 'SoftStop') { l_arrBestListSS.push(m_objlistPractices[practices]); } }; Ext.getStore('store_Violations').loadData(l_arrBestListHS); Ext.getStore('store_Errors').loadData(l_arrBestListSS); }; //blur event on Violation poup window this.onWindowBlurEvent = function(window, event, eOpts) { var btnBestPractices = VistaarExtjs.getCmp(&quot;btnPricePlanBestPractices&quot;); m_PricePlanViolationObject.hide(); btnBestPractices.toggle(); }; this.hideBestPracticePopup = function() { //var bestwindow = Ext.ComponentQuery.query('window[cls=clsWindowNotificationWidget animated slideInRight]')[0]; // if(Ext.DomQuery.hasOwnProperty('selectNode')) //{ var bestwindow = Ext.DomQuery.selectNode(&quot;div[class^=x-window clsWindowNotificationWidget animated]&quot;); if (bestwindow != undefined) { VistaarFunctionLib.closeWindow(m_PricePlanBestPracticePopupObject); } this.removeClsfromPrevElement(); //} }; this.showBestPracticePopup = function(l_practicetext) { //show best practice popup or create one //m_PricePlanBestPracticePopupObject = VistaarFunctionLib.showWindow(&quot; BestPracticePopup &quot;); //var bestwindow = Ext.ComponentQuery.query('window[cls=clsWindowNotificationWidget animated slideInRight]')[0]; var bestwindow = Ext.DomQuery.selectNode(&quot;div[class^=x-window clsWindowNotificationWidget animated]&quot;); if (bestwindow === undefined) { m_PricePlanBestPracticePopupObject = VistaarFunctionLib.showWindow(&quot;BestPracticePopup&quot;); } else { var panelinfo = m_PricePlanBestPracticePopupObject.getComponent('pnlNotificationDetailInfo'); panelinfo.show(); //bestwindow.show(); - 24dec15 } /* if (m_PricePlanBestPracticePopupObject === undefined) { m_PricePlanBestPracticePopupObject = VistaarFunctionLib.showWindow(&quot; BestPracticePopup &quot;); } else { var panelButton = m_PricePlanBestPracticePopupObject.getComponent('pnlButtonParent'); panelButton.show(); var panelinfo = m_PricePlanBestPracticePopupObject.getComponent('pnlNotificationDetailInfo'); panelinfo.show(); } */ m_currentPracticeList = new list(this.getSelectedBestPractice(l_practicetext)); this.updateNotificationPanel(); this.getElementtoaddCls(m_currentPracticeList.getElement()); m_PricePlanViolationObject.hide(); setDefaultCursor(); }; this.updateNotificationPanel = function() { var pnlnotify = m_PricePlanBestPracticePopupObject.getComponent('pnlNotificationDetailInfo'); var l_textToShow = m_currentPracticeList.getElement().text; if (!l_textToShow) { l_textToShow = m_currentPracticeList.text; } var l_notification = m_notificationTemplate.replace('PLACE_HOLDER_FOR_MESSAGE', l_textToShow); pnlnotify.setHtml(l_notification); }; //on Data View click this.onDvItemClickViolation = function(view, record, item, index, event, eOpts) { try { if (record.data.isReadOnly == false) { // activate price plan setWaitCursor(); Ext.defer(function() { this.activatePricePlanForBP(); this.showBestPracticePopup(record.data.text); var btn = VistaarExtjs.getCmp(&quot;btnBestPractices&quot;); btn.toggle(false); }, 50, getPricePlanControllerManagerObj().getPricePlanUIManager().getPriceBestPracticeManager()); } } catch (err) { setDefaultCursor(); console.log('Error in onDvItemClickViolation from previous element'); } }; this.onDvItemClickErrors = function(view, record, item, index, event, eOpts) { try { if (record.data.isReadOnly == false) { setWaitCursor(); Ext.defer(function() { // activate price plan this.activatePricePlanForBP(); this.showBestPracticePopup(record.data.text); var btn = VistaarExtjs.getCmp(&quot;btnBestPractices&quot;); btn.toggle(false); }, 50, getPricePlanControllerManagerObj().getPricePlanUIManager().getPriceBestPracticeManager()); } } catch (err) { setDefaultCursor(); console.log('Error in onDvItemClickViolation from previous element'); } }; this.activatePricePlanForBP = function() { // 29Oct15 if (!getPricePlanControllerManagerObj().getPricePlanUIManager().isPricePlanGridViewActive()) { // imapct analysis toggle button VistaarExtjs.getCmp(&quot;btnImpactAnalysisOpen&quot;).toggle(false); getPricePlanControllerManagerObj().setPricePlanMainView(); } //Expand Total Column before best practices navigation....(IPAD issue 22-Dec) getPricePlanControllerManagerObj().getPricePlanUIManager().expandTotalColumn_Prior_BP_Nav(); }; /** * This is function run on show of the Best Practice popup * &lt;p&gt; &lt;img uml=&quot; * (*) -down-&gt; &amp;quot;initializeModuleObjects&amp;quot; * -down-&gt; &amp;quot;lookupSummaryGridForBestPractice&amp;quot; * -down-&gt; &amp;quot;lookupGridForBestPractice&amp;quot; * note right: Off section * -down-&gt; &amp;quot;lookupGridForBestPractice&amp;quot; * note right: ON section * -down-&gt; &amp;quot;checkBPAcrossChannel&amp;quot; * -down-&gt; &amp;quot;loadBestPracticesStore&amp;quot; * -down-&gt; (*) * &quot; &gt; &lt;/p&gt; */ this.evalBestPractice = function() { // This is used to fetch Best Practices list /* List of Best Practice to consider 1.Volume is not 100% 2.Price line without out volume 3.Duplicate Net List 4.Allowance should be same 5.Difference of allowance &gt; difference of Net List 6.Incomplete Price line (For Price line with volume &gt; 0) Deal Line Name Bill FOB Net List Shelf...... */ var currentMonth = getGlobalConstantsObj().getTimeDetails().CurrentMonthName; var closedMonth = getCommonFuncMgr().m_PP_ClosedMonth; closedMonth === 'Dec' ? m_EditableFrom = ' ' : closedMonth === '' ? m_EditableFrom = 'Jan' : m_EditableFrom = currentMonth; //m_EditableFrom = getGlobalConstantsObj().getTimeDetails().CurrentMonthName; //getCommonFuncMgr().m_PP_ClosedMonth; // getCommonFuncMgr().m_PP_EditableFrom; // getPricePlanControllerManagerObj().getActivePricePlanData().AdditionalInfo.EditableFrom var editInfo = getPricePlanControllerManagerObj().getPricePlanUIManager().getPricePlanGridManager().fetchEditedInfo(); m_HistorEditFrom = getPricePlanControllerManagerObj().getActivePricePlanData().AdditionalInfo.EvalBestPracticeMonths; m_HistorEditFrom = this.updateHistoryEdit(m_HistorEditFrom, editInfo); m_PGEffectivity = getCommonFuncMgr().m_PP_PG_Effectivity; var l_BestPractice = getPricePlanControllerManagerObj().getBestracticeGuidanceData(); //- 6Oct15 var p_factCodeArr = {}; if (l_BestPractice !== undefined) { this.initializeModuleObjects(); this.lookupSummaryGridForBestPractice(l_BestPractice); //- 5Oct15 this.lookupGridForBestPractice(m_OFF, l_BestPractice[m_OFF], p_factCodeArr); this.lookupGridForBestPractice(m_ON, l_BestPractice[m_ON], p_factCodeArr); this.checkBPAcrossChannel(p_factCodeArr); //13Nov15 this.loadBestPracticesStore(); } }; this.updateHistoryEdit = function(p_history, p_edited) { for (var obj = 0; obj &lt; p_edited.length; obj++) { for (month in p_edited[obj]['Values']) { var channel = p_history[p_edited[obj]['Variable Attributes']['Channels']]; if (!channel.hasOwnProperty(month)) { channel[month] = true; } } } return p_history; }; this.checkBPAcrossChannel = function(p_factCodeArr) { //new requirement change 4th July AC /* var key; for (key in p_factCodeArr) { this.checkAllowanceSeggreagated(p_factCodeArr[key], key, &quot;&quot;, &quot;DA&quot;, m_objlistPractices.DASame); this.checkAllowanceSeggreagated(p_factCodeArr[key], key, &quot;&quot;, &quot;WP&quot;, m_objlistPractices.WPSame); } */ try { var dealID = []; var l_preference = getPricePlanControllerManagerObj().getPricePlanUIManager().m_UserPrefrence; if (l_preference['WP'] !== undefined) { this.newevaluateFactObjects(&quot;WP&quot;, m_objlistPractices.WPSame, 'ALL', m_nonManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;WP&quot;, m_objlistPractices.WPSame, 'ALL', m_skuManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;WP&quot;, m_objlistPractices.WPSame, 'ALL', m_disManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;WP&quot;, m_objlistPractices.WPSame, 'ALL', m_disSNDDealsMaster, dealID); this.newevaluateFactObjects(&quot;WP&quot;, m_objlistPractices.WPSame, 'ALL', m_skuSNDDealsMaster, dealID); } if (l_preference['DA'] !== undefined) { dealID = []; this.newevaluateFactObjects(&quot;DA&quot;, m_objlistPractices.DASame, 'ALL', m_nonManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;DA&quot;, m_objlistPractices.DASame, 'ALL', m_skuManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;DA&quot;, m_objlistPractices.DASame, 'ALL', m_disManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;DA&quot;, m_objlistPractices.DASame, 'ALL', m_disSNDDealsMaster, dealID); this.newevaluateFactObjects(&quot;DA&quot;, m_objlistPractices.DASame, 'ALL', m_skuSNDDealsMaster, dealID); } dealID = []; this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'OFF', m_nonManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'OFF', m_skuManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'OFF', m_disManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'OFF', m_disSNDDealsMaster, dealID); this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'OFF', m_skuSNDDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'ON', m_nonManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'ON', m_skuManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'ON', m_disManDealsMaster, dealID); dealID = []; this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'ON', m_disSNDDealsMaster, dealID); this.newevaluateFactObjects(&quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList, 'ON', m_skuSNDDealsMaster, dealID); } catch (err) { console.log('Error in newevaluateFactObjects'); } }; this.checkGridforDA = function(p_sGridName) { var l_objGrid = (p_sGridName == 'OFF' ? m_objTreeGridOff : m_objTreeGridOn); }; this.getMonthFromString = function(p_Month) { return p_Month ? new Date(Date.parse(p_Month + &quot; 1, 2012&quot;)).getMonth() + 1 : 0; }; this.lookupSummaryGridForBestPractice = function(pBPGuidance) { var l_dgOBj = Ext.getCmp(m_DGSUMMARYPROPOSED).DGObj; var l_store = l_dgOBj.getStore(); var l_data = l_store.data.items; //VistaarDG.getDataFromDynamicGrid(m_DGSUMMARYPROPOSED); var l_OffNetFOB, l_OnNetFOB; var l_FY = &quot;FY&quot;; var l_grdName = &quot;Summary&quot;; // minimum days to change -- 19Oct15 if (pBPGuidance[&quot;Additional Information&quot;][&quot;Posting Flag&quot;] == &quot;1&quot;) { this.buildBestPractices(0, l_FY, l_grdName, m_objlistPractices.MinDaysToChange.list, m_objlistPractices.MinDaysToChange.text); m_objlistPractices.MinDaysToChange.count += 1; } for (var rowIdx in l_data) { //if (l_data[rowIdx].data.Metrics == &quot;Seasonality (Current)&quot;) { // break; //} // if (l_data[rowIdx].Metrics == &quot;Off Premise RAB&quot; || l_data[rowIdx].Metrics == &quot;on Premise RAB&quot;) { // if (l_data[rowIdx][l_FY] &lt; pBPGuidance[&quot;AVG_RAB_VS_GUIDANCE&quot;]) { // this.buildBestPractices(rowIdx, l_FY, l_grdName, m_objlistPractices.AvgRABGuidance.list, l_data[rowIdx].Metrics); // m_objlistPractices.AvgRABGuidance.count += 1; // } // } else // if (l_data[rowIdx].data.Type == &quot;Proposed&quot;) { if (l_data[rowIdx].data.Metrics == &quot;Off Premise Net FOB&quot; || l_data[rowIdx].data.Metrics == &quot;On Premise Net FOB&quot;) { // Avg. full year Net FOB at Pricecat level is below Last Year if (l_data[rowIdx].data[l_FY] &lt; l_data[rowIdx].data[&quot;PY&quot;]) { this.buildBestPractices(rowIdx, l_FY, l_grdName, m_objlistPractices.AvgPYNetFOBGuidance.list, m_objlistPractices.AvgPYNetFOBGuidance.text, &quot;&quot;, l_data[rowIdx].data.Metrics); m_objlistPractices.AvgPYNetFOBGuidance.count += 1; } } if (l_data[rowIdx].data.Metrics == &quot;Off Premise Net FOB&quot;) { if (l_data[rowIdx].data[l_FY] &lt; pBPGuidance[m_OFF][&quot;AVG_FOB_GUIDLINE&quot;]) { this.buildBestPractices(rowIdx, l_FY, l_grdName, m_objlistPractices.AvgNetFOBGuidance.list, m_objlistPractices.AvgNetFOBGuidance.text + &quot; \\&quot;&quot; + pBPGuidance[m_OFF][&quot;AVG_FOB_GUIDLINE&quot;] + &quot;\\&quot;&quot;, &quot;&quot;, l_data[rowIdx].data.Metrics); m_objlistPractices.AvgNetFOBGuidance.count += 1; } l_OffNetFOB = l_data[rowIdx].data[l_FY]; } if (l_data[rowIdx].data.Metrics == &quot;On Premise Net FOB&quot;) { if (l_data[rowIdx].data[l_FY] &lt; pBPGuidance[m_ON][&quot;AVG_FOB_GUIDLINE&quot;]) { this.buildBestPractices(rowIdx, l_FY, l_grdName, m_objlistPractices.AvgNetFOBGuidance.list, m_objlistPractices.AvgNetFOBGuidance.text + &quot; \\&quot;&quot; + pBPGuidance[m_ON][&quot;AVG_FOB_GUIDLINE&quot;] + &quot;\\&quot;&quot;, &quot;&quot;, l_data[rowIdx].data.Metrics); m_objlistPractices.AvgNetFOBGuidance.count += 1; } l_OnNetFOB = l_data[rowIdx].data[l_FY] } } else { if (l_data[rowIdx].data.Metrics == &quot;Off Premise Net FOB&quot;) { if (l_OffNetFOB &lt; l_data[rowIdx].data[l_FY]) { var l_Percent = ((l_data[rowIdx].data[l_FY] - l_OffNetFOB) / l_data[rowIdx].data[l_FY]) * 100; this.buildBestPractices(rowIdx, l_FY, l_grdName, m_objlistPractices.AvgFOBDecreased.list, m_objlistPractices.AvgFOBDecreased.text + &quot; &quot; + getCommonFuncMgr().setNumberFormat(l_Percent, 2) + &quot;%&quot;, &quot;&quot;, l_data[rowIdx].data.Metrics); m_objlistPractices.AvgFOBDecreased.count += 1; } } if (l_data[rowIdx].data.Metrics == &quot;On Premise Net FOB&quot;) { if (l_OnNetFOB &lt; l_data[rowIdx].data[l_FY]) { var l_Percent = ((l_data[rowIdx].data[l_FY] - l_OffNetFOB) / l_data[rowIdx].data[l_FY]) * 100; this.buildBestPractices(rowIdx, l_FY, l_grdName, m_objlistPractices.AvgFOBDecreased.list, m_objlistPractices.AvgFOBDecreased.text + &quot; &quot; + getCommonFuncMgr().setNumberFormat(l_Percent, 2) + &quot;%&quot;, &quot;&quot;, l_data[rowIdx].data.Metrics); m_objlistPractices.AvgFOBDecreased.count += 1; } } } } }; /** *@description The function that loops through grid data * * &lt;p&gt; &lt;img uml=&quot; * title lookupGridForBestPractice start while (Months?) if (Editable From and History Edit ? ) then (yes) if (Business Line ?) then (yes) : Check volume and volume mix 1. if volume is there volume mix should be 100 2. if volume is not there then volume mix should be 0/100/empty 3. Negative Percent of Business; else (no) if ( Not Deleted Deal and Volume Mix Present and Childrens ? ) then (yes) :lookupChildforBestPractice updateFactsObjects; endif endif endif endwhile stop * &quot;&gt; &lt;/p&gt; * @param {string} p_sGridName Grid Name ON/OFF * @param {object} p_BPGuidanceData Guidance Data * @param {object} p_factCodeArr Fact Code to check */ this.lookupGridForBestPractice = function(p_sGridName, p_BPGuidanceData, p_factCodeArr) { try { //Looping through which Grid var l_objGrid = (p_sGridName == 'OFF' ? m_objTreeGridOff : m_objTreeGridOn); var l_rootNode = l_objGrid.getRootNode(); var l_store = l_objGrid.getStore(); var l_data = l_store.data; var l_grdview = l_objGrid.getView(); var l_gridRow; var l_bCheckDealName = true; var l_bVolumeMix; var l_VolumeValue = 0; var l_otherFacts; var l_allowance; var curChildrens; l_rootNode.collapseChildren(); /* Removing volume check var l_bVolume; l_bVolume = true; if (this.ValidateNumberReturnBlank(this.getVolume(l_objGrid)) == &quot;&quot;) { l_bVolume = false; }; */ //to perform best practice check on FY this.lookupForAvgBestPractice(l_data, l_bCheckDealName, p_sGridName, p_BPGuidanceData); //loop with months for (var l_Month in m_arrMonths) { l_otherFacts = []; if (!p_factCodeArr[m_arrMonths[l_Month]]) { p_factCodeArr[m_arrMonths[l_Month]] = []; } l_allowance = 0; curChildrens = {}; //loop through rows along ON/OFF section treegrid for (var rowIdx in l_data.items) { l_gridRow = l_data.items[rowIdx]; l_bVolumeMix = true; //if (this.getMonthFromString(m_arrMonths[l_Month]) &gt;= this.getMonthFromString(l_gridRow.data[&quot;EditableFrom&quot;])) { Change of global EditableFrom if ((this.getMonthFromString(m_arrMonths[l_Month]) &gt;= this.getMonthFromString(m_EditableFrom) || m_HistorEditFrom[p_sGridName].hasOwnProperty(m_arrMonths[l_Month])) &amp;&amp; m_PGEffectivity[m_arrMonths[l_Month]]) { if (l_gridRow.data.MetricsType == &quot;Business&quot;) { //Check % of Business not 100% when volume - var l_volume = this.ValidateNumberReturnBlank(this.getVolumeByMonth(l_objGrid, m_arrMonths[l_Month])); var l_volumeMix = Math_toFixedTo(this.ValidateNumberReturnZero(l_gridRow.data[m_arrMonths[l_Month]]), 0); if (l_volume !== &quot;&quot; &amp;&amp; l_volume !== 0) { //18Nov15 -742 // if volume is there volume mix should be 100 if (l_volumeMix != 100) { //this.buildBestPractices(msg, l_gridRow, 7 + parseInt(l_Month), l_sGridName,m_objlistPractices.VolumeNot100.list); this.buildBestPractices(l_gridRow, m_arrMonths[l_Month], p_sGridName, m_objlistPractices.VolumeNot100.list, m_objlistPractices.VolumeNot100.text); m_objlistPractices.VolumeNot100.count += 1; } } else { // if volume is not there then volume mix should be 0/100/&quot;&quot; if (!(l_volumeMix == 100 || l_volumeMix == 0 || l_volumeMix == &quot;&quot;)) { //this.buildBestPractices(msg, l_gridRow, 7 + parseInt(l_Month), l_sGridName,m_objlistPractices.VolumeNot100.list); this.buildBestPractices(l_gridRow, m_arrMonths[l_Month], p_sGridName, m_objlistPractices.VolumeNot100.list, m_objlistPractices.VolumeNot100.text); m_objlistPractices.VolumeNot100.count += 1; } } //#745 - Negative Percent of Business if (l_gridRow.data[m_arrMonths[l_Month]] &lt; 0) { this.buildBestPractices(l_gridRow, m_arrMonths[l_Month], p_sGridName, m_objlistPractices.NegativePerctBusiness.list); m_objlistPractices.NegativePerctBusiness.count += 1; } } else { //if (!l_gridRow.data['Deleted Deal']) { if (!(l_gridRow.data['Deleted Deal'] &amp;&amp; (this.getMonthFromString(l_gridRow.data['Deleted Time']) &lt; this.getMonthFromString(m_arrMonths[l_Month])))) { //Volume mix is not entered //to check lookup FY columns if (this.ValidateNumberReturnBlank(l_gridRow.data[m_arrMonths[l_Month]]) === &quot;&quot;) { l_bVolumeMix = false; } if (l_bVolumeMix) { //Check allowance and create array of facts var childrens = l_gridRow.data.children; if (m_CurGrdMapping[p_sGridName][l_gridRow.data.DealID]) { curChildrens = m_CurGrdMapping[p_sGridName][l_gridRow.data.DealID].data.children; } //Check if the Row contains Children if (childrens != undefined) { //get time memeber code (YYddmm) var l_timeMemberCode = getPricePlanControllerManagerObj().getPricePlanUIManager().getTimeMemberCode(parseInt(l_Month) + 1); var facts = this.lookupChildForBestPractices(childrens, l_gridRow, m_arrMonths[l_Month], p_sGridName, curChildrens, p_BPGuidanceData[l_timeMemberCode]); facts.VolumeMix = l_gridRow.data[m_arrMonths[l_Month]]; facts[&quot;GridName&quot;] = p_sGridName; l_otherFacts.push(facts); p_factCodeArr[m_arrMonths[l_Month]].push(facts); //13Nov15 - Acrooss chaneel DA if (l_bCheckDealName) { this.checkDealName(l_gridRow, p_sGridName); }; this.updateFactsObject(facts, l_timeMemberCode, m_arrMonths[l_Month], l_gridRow.data['SKU Excluded'], l_gridRow.data['Distributor Excluded']); } }; } }; } } l_bCheckDealName = false; //31Oct15 - SDA and Netlist delta check - IT#634 //ET#1241 : The best practice '∆ SDA &gt; ∆ Net List' needs to be turned off. //this.checkNetListandAllowance(l_otherFacts, m_arrMonths[l_Month], p_sGridName); //this.checkDuplicateNetList(l_otherFacts, m_arrMonths[l_Month], p_sGridName); //comment it on 4 July for new change in requiremnt //this.checkAllowanceSeggreagated(l_otherFacts, m_arrMonths[l_Month], p_sGridName, &quot;Net_List_ATAX&quot;, m_objlistPractices.DuplicateNetList); //this.checkAllowanceSeggreagated(l_otherFacts, m_arrMonths[l_Month], p_sGridName, &quot;WP&quot;, m_objlistPractices.WPSame); - 18Nov15 //this.checkAllowanceSeggreagated(l_otherFacts, m_arrMonths[l_Month], p_sGridName, &quot;DA&quot;, m_objlistPractices.DASame); //l_FactsArr[m_arrMonths[l_Month]] = l_otherFacts; } } catch (err) { console.log('Error in removeCls from previous element'); } }; /** * To Check following best Practice * * VolumeNotPresent * * AvgVolumeGuidance * @param {object} p_data Grid Data * @param {boolean} p_bCheckDealName Check Deal Name * @param {string} p_sGridName Grid Name ON/OFF * @param {object} p_BPGuidanceData Guidance Data */ this.lookupForAvgBestPractice = function(p_data, p_bCheckDealName, p_sGridName, p_BPGuidanceData) { try { var l_volThreshold = p_BPGuidanceData[&quot;DEEP_PERCENT_OF_BUSINESS&quot;]; for (var rowIdx in p_data.items) { l_gridRow = p_data.items[rowIdx]; var l_VolumePresent = true; if (l_gridRow.data.MetricsType !== &quot;Business&quot;) { if (!l_gridRow.data['Deleted Deal']) { //check if its not PG deal and volume is present if (p_bCheckDealName &amp;&amp; !(l_gridRow.data['MetricsType'] == 'Volume') &amp;&amp; !(l_gridRow.data['MetricsType'] == 'PG')) { if (l_gridRow.data[&quot;DealLevelCode&quot;] !== &quot;Frontline&quot;) { // added FL condition 11Dec15 // check if all values of volume across months are blank - 27Oct15 if (this.ValidateNumberReturnZero(l_gridRow.data[&quot;FY&quot;]) == 0) { if (this.checkVolumeNotPresent(l_gridRow.data)) { this.buildFYVolumeBP(&quot;VolumeNotPresent&quot;, p_sGridName, l_gridRow.data['DealID']); l_VolumePresent = false; } } } if (l_VolumePresent &amp;&amp; (l_gridRow.data[&quot;FY&quot;] &lt; (l_volThreshold[&quot;Threshold_1&quot;] * 100) || l_gridRow.data[&quot;FY&quot;] &gt; (l_volThreshold[&quot;Threshold_2&quot;] * 100))) { var l_textToShow = &quot; \\&quot;&quot; + l_volThreshold['Threshold_1'] * 100 + &quot; - &quot; + l_volThreshold['Threshold_2'] * 100 + &quot;\\&quot;&quot;; // check if avg year volume threshold this.buildFYVolumeBP(&quot;AvgVolumeGuidance&quot;, p_sGridName, l_gridRow.data['DealID'], l_textToShow); } } } } } } catch (err) { console.log('Error in Avg best practices'); } }; this.buildFYVolumeBP = function(p_BestPractice, p_sGridName, p_DealID, p_Text) { var l_objBestPractice = {}; l_objBestPractice.GridName = p_sGridName; l_objBestPractice.Column = &quot;FY&quot;; l_objBestPractice.DealID = []; l_objBestPractice.DealID.push(p_DealID); if (p_Text) { l_objBestPractice.text = m_objlistPractices[p_BestPractice].text + p_Text; } else { l_objBestPractice.text = m_objlistPractices[p_BestPractice].text; } m_objlistPractices[p_BestPractice].list.push(l_objBestPractice); m_objlistPractices[p_BestPractice].count += 1; }; /* check if entire row data is blank*/ this.checkVolumeNotPresent = function(pGridRowData) { for (var l_Month in m_arrMonths) { //if (this.getMonthFromString(m_arrMonths[l_Month]) &gt;= this.getMonthFromString(pGridRowData.data[&quot;EditableFrom&quot;])) //check for null and blank - 31Oct15 - IT #632 if (pGridRowData[m_arrMonths[l_Month]] !== &quot;&quot; &amp;&amp; pGridRowData[m_arrMonths[l_Month]] !== null) { return false; } } return true; }; this.getVolume = function(p_GridObj) { /* Get the row from the grid object with uniquie DealID */ var l_gridRow; var l_rootNode = p_GridObj.getRootNode(); var l_data = l_rootNode.data; for (var rowIdx in l_rootNode.childNodes) { if (l_rootNode.childNodes[rowIdx].data.MetricsType == &quot;Volume&quot;) { return l_rootNode.childNodes[rowIdx].data.FY; } } }; this.getVolumeByMonth = function(p_GridObj, p_Month) { /* Get the row from the grid object with uniquie DealID */ var l_gridRow; var l_rootNode = p_GridObj.getRootNode(); var l_data = l_rootNode.data; for (var rowIdx in l_rootNode.childNodes) { if (l_rootNode.childNodes[rowIdx].data.MetricsType == &quot;Volume&quot;) { return l_rootNode.childNodes[rowIdx].data[p_Month]; } } } this.checkNetListandAllowance = function(p_otherFacts, p_nocolumn, p_sGridName) { // body... //Delta only volume var l_dltaAllowance; var l_dltaNetList; for (var i = 0; i &lt; p_otherFacts.length - 1; i++) { //l_dltaAllowance = Math.abs(p_otherFacts[i + 1]['Allowance'] - p_otherFacts[i]['Allowance']); l_dltaAllowance = Math.abs(p_otherFacts[i + 1]['SDA'] - p_otherFacts[i]['SDA']); l_dltaNetList = Math.abs(p_otherFacts[i + 1]['Net_List_ATAX'] - p_otherFacts[i]['Net_List_ATAX']); if (l_dltaAllowance &gt; l_dltaNetList) { var l_objBestPractice = {}; l_objBestPractice.GridName = p_sGridName; l_objBestPractice.Column = p_nocolumn; l_objBestPractice.DealID = []; l_objBestPractice.DealID.push(p_otherFacts[i + 1]['DealID']); l_objBestPractice.DealID.push(p_otherFacts[i]['DealID']); m_objlistPractices.AllowanceDiff.list.push(l_objBestPractice); m_objlistPractices.AllowanceDiff.count += 1; } }; } this.updateFactsObject = function(p_facts, p_TimeMemberCode, Month, bSKU, bDist) { var dealID = p_facts.DealID; var skuList = this.getIncList('SKU_Included', dealID, p_TimeMemberCode); var distList = this.getIncList('Distributor_Included', dealID, p_TimeMemberCode); p_facts['SKUList'] = skuList; p_facts['DISList'] = distList; p_facts['Month'] = Month; bSKU ? p_facts['SKU'] = true : p_facts['SKU'] = false; bDist ? p_facts['DIS'] = true : p_facts['DIS'] = false; if (!bSKU &amp;&amp; !bDist) { for (deal in m_nonManDealsMaster[p_TimeMemberCode]) { var obj = m_nonManDealsMaster[p_TimeMemberCode][deal]; if (skuList.indexOf(obj['Code']) &gt;= 0) { obj['Facts'] ? obj['Facts'].push(p_facts) : obj['Facts'] = [p_facts]; } } } if (bSKU &amp;&amp; !bDist) { for (deal in m_skuManDealsMaster[p_TimeMemberCode]) { var obj = m_skuManDealsMaster[p_TimeMemberCode][deal]; if (skuList.indexOf(obj['Code']) &gt;= 0) { obj['Facts'] ? obj['Facts'].push(p_facts) : obj['Facts'] = [p_facts]; } } } if (bDist &amp;&amp; !bSKU) { for (deal in m_disManDealsMaster[p_TimeMemberCode]) { var obj = m_disManDealsMaster[p_TimeMemberCode][deal]; if (distList.indexOf(obj['Code']) &gt;= 0) { obj['Facts'] ? obj['Facts'].push(p_facts) : obj['Facts'] = [p_facts]; } } } if (bSKU &amp;&amp; bDist) { for (deal in m_disSNDDealsMaster[p_TimeMemberCode]) { var obj = m_disSNDDealsMaster[p_TimeMemberCode][deal]; if (distList.indexOf(obj['Code']) &gt;= 0) { obj['Facts'] ? obj['Facts'].push(p_facts) : obj['Facts'] = [p_facts]; } } for (deal in m_skuSNDDealsMaster[p_TimeMemberCode]) { var obj = m_skuSNDDealsMaster[p_TimeMemberCode][deal]; if (skuList.indexOf(obj['Code']) &gt;= 0) { obj['Facts'] ? obj['Facts'].push(p_facts) : obj['Facts'] = [p_facts]; } } } } this.newevaluateFactObjects = function(p_fact, p_list, p_channel, p_masterData, dealID) { //console.log(m_skuMaster); for (time in p_masterData) { var nonManaged = p_masterData[time] .filter(function(obj) { return !!obj['Facts']; }).map(function(obj) { return obj['Facts'].filter( function(chanl) { return p_channel == 'ALL' ? true : chanl['GridName'] == p_channel; }).map(function(factin) { return factin[p_fact]; }); }); if (nonManaged.length &gt; 0) { for (l in nonManaged) { var nonManagedCount = p_fact == 'Net_List_ATAX' ? this.reduceArray(nonManaged[l]) : this.removeDup(nonManaged[l]);; if (nonManagedCount.length &gt; 1) { for (var k = 1; k &lt; nonManagedCount.length; k++) { var obj = p_masterData[time] .filter(function(obj) { return !!obj['Facts']; }).map(function(obj2) { return obj2['Facts'].filter( function(chanl) { return p_channel == 'ALL' ? true : chanl['GridName'] == p_channel; }).filter(function(fact) { return fact[p_fact] == nonManagedCount[k]; }); }); for (key in obj) { for (key2 in obj[key]) { if (dealID.indexOf(obj[key][key2].DealID + obj[key][key2].GridName + obj[key][key2].Month) == -1) { var l_objBestPractice = {}; l_objBestPractice.GridName = obj[key][key2].GridName; l_objBestPractice.Qualifier = p_fact == 'Net_List_ATAX' ? 'Net List' : p_fact; l_objBestPractice.Column = obj[key][key2].Month; l_objBestPractice.DealID = obj[key][key2].DealID; p_list.list.push(l_objBestPractice); p_list.count += 1; dealID.push(obj[key][key2].DealID + obj[key][key2].GridName + obj[key][key2].Month); } } } } } } } } } this.SameCount = function(arr) { var map = new Object(); for (var i = 0; i &lt; uniqueCount.length; i++) { if (map[uniqueCount[i]] != null) { map[uniqueCount[i]] += 1; } else { map[uniqueCount[i]] = 1; } } return map; } this.removeDup = function(arr) { return arr.sort(). filter(function(me, i, arr) { return (i === 0) || (me !== arr[i - 1]); }).filter(function(value) { return value !== undefined; }); } this.reduceArray = function(arr) { var obj = arr.reduce(function(countMap, word) { countMap[word] = ++countMap[word] || 1; return countMap }, {}); var newarr = [&quot;0&quot;]; for (key in obj) { if (obj[key] &gt; 1) newarr.push(key); } return newarr; } this.extractCode = function(obj) { return obj['Code']; } this.getIncList = function(p_Type, dealID, timecode) { var inclusion = getPricePlanControllerManagerObj().getActivePricePlanData()[&quot;InclusionDetails&quot;]; return inclusion[dealID][timecode][p_Type].map(this.extractCode); } this.checkAllowanceSeggreagated = function(l_otherFacts, p_nocolumn, p_sGridName, p_AllowanceName, p_objlist) { /* To check allowance we need to check if Volume Mix is not 0 if volume mix is 0 then it is meant that the Deal is inactive */ var l_duplicate = {}; var l_max = []; var l_duplicateGrp = []; var l_allowanceValue; var matched; // get active price plan exclution data var l_pricePlanExclusionData = getPricePlanControllerManagerObj().getActivePricePlanData()[&quot;ExclusionDetails&quot;]; //get time member code var l_timeMemberCode = getPricePlanControllerManagerObj().getPricePlanUIManager().getTimeMemberCode(m_arrMonths.indexOf(p_nocolumn) + 1); // loop for all facts for (var i = 0; i &lt; l_otherFacts.length; i++) { l_duplicate = {}; //check if vlume mix is greater than 0 if (l_otherFacts[i]['VolumeMix'] &gt; 0) { l_allowanceValue = l_otherFacts[i][p_AllowanceName]; // check for first value if (l_allowanceValue != undefined) { //&amp;&amp; l_allowanceValue &gt;= 0 if (l_duplicateGrp.length == 0) { l_duplicate[l_allowanceValue] = {}; l_duplicate[l_allowanceValue]['DealID'] = []; l_duplicate[l_allowanceValue]['GridName'] = []; l_duplicate[l_allowanceValue]['DealID'].push(l_otherFacts[i]['DealID']); l_duplicate[l_allowanceValue]['GridName'].push(l_otherFacts[i]['GridName']); //13Nov15 l_duplicateGrp.push(l_duplicate); l_max[l_duplicateGrp.length] = l_duplicate[l_allowanceValue]['DealID'].length; } else { matched = false; // for each duplicate value in group for (var idx = 0; idx &lt; l_duplicateGrp.length; idx++) { // for each object of group array for (var grp in l_duplicateGrp[idx]) { // check if it match with current ID SKU exclusion if (this.compareExclusion(l_pricePlanExclusionData[l_duplicateGrp[idx][grp]['DealID'][0]][l_timeMemberCode], l_pricePlanExclusionData[l_otherFacts[i]['DealID']][l_timeMemberCode], &quot;SKU_Exluded&quot;)) { // check for same allowns value in group if (l_duplicateGrp[idx][l_allowanceValue] == undefined) { l_duplicateGrp[idx][l_allowanceValue] = {}; l_duplicateGrp[idx][l_allowanceValue]['DealID'] = []; l_duplicateGrp[idx][l_allowanceValue]['GridName'] = []; l_duplicateGrp[idx][l_allowanceValue]['DealID'].push(l_otherFacts[i]['DealID']); l_duplicateGrp[idx][l_allowanceValue]['GridName'].push(l_otherFacts[i]['GridName']); //13Nov15 //l_duplicateGrp[idx] = l_duplicate; l_max[idx] = l_duplicateGrp[idx][l_allowanceValue]['DealID'].length; } else { l_duplicateGrp[idx][l_allowanceValue]['DealID'].push(l_otherFacts[i]['DealID']); l_duplicateGrp[idx][l_allowanceValue]['GridName'].push(l_otherFacts[i]['GridName']); //13Nov15 l_max[idx] = l_duplicateGrp[idx][l_allowanceValue]['DealID'].length; } matched = true; } break; } if (matched == true) { break; } } if (matched == false) { l_duplicate[l_allowanceValue] = {}; l_duplicate[l_allowanceValue]['DealID'] = []; l_duplicate[l_allowanceValue]['GridName'] = []; l_duplicate[l_allowanceValue]['DealID'].push(l_otherFacts[i]['DealID']); l_duplicate[l_allowanceValue]['GridName'].push(l_otherFacts[i]['GridName']); //13Nov15 l_duplicateGrp.push(l_duplicate); l_max[idx] = l_duplicate[l_allowanceValue]['DealID'].length; } } } } }; var iSameCount = 0; for (var idx = 0; idx &lt; l_duplicateGrp.length; idx++) { l_duplicate = l_duplicateGrp[idx]; iSameCount = 0; if (p_AllowanceName == &quot;Net_List_ATAX&quot;) { for (var netlist in l_duplicate) { if (l_duplicate[netlist]['DealID'].length &gt; 1) { p_objlist.count += 1; var l_objBestPractice = {}; l_objBestPractice.GridName = p_sGridName; //l_objBestPractice.GridName = l_duplicate[netlist]['GridName']; l_objBestPractice.Qualifier = 'Net List'; l_objBestPractice.Column = p_nocolumn; l_objBestPractice.DealID = l_duplicate[netlist]['DealID']; p_objlist.list.push(l_objBestPractice); p_objlist.count += 1; } } } else { for (var allowance in l_duplicate) { iSameCount = iSameCount + 1; }; if (iSameCount &gt; 1) { for (allowance in l_duplicate) { if (l_duplicate[allowance]['DealID'].length &lt;= l_max[idx]) { //m_objlistPractices.AllowanceSame.count += 1; var l_objBestPractice = {}; l_objBestPractice.GridName = p_sGridName; // if allownce is DA den assign grid name array if (p_AllowanceName == &quot;DA&quot; || p_AllowanceName == &quot;WP&quot;) { l_objBestPractice.GridName = l_duplicate[allowance]['GridName']; } l_objBestPractice.Column = p_nocolumn; l_objBestPractice.Qualifier = p_AllowanceName; l_objBestPractice.DealID = l_duplicate[allowance]['DealID']; p_objlist.list.push(l_objBestPractice); p_objlist.count += 1; } }; } } } }; this.compareExclusion = function(pVal1, pVal2, pExclusion) { // get length both array var l_val1Length = pVal1[pExclusion].length; var l_val2Length = pVal2[pExclusion].length; var match; // check both array has same length if (l_val1Length == l_val2Length) { // if legth is zero if (l_val1Length == 0) { return true; } else { // loop to comapre code for (var idx1 = 0; idx1 &lt; l_val1Length; idx1++) { match = false; for (var idx2 = 0; idx2 &lt; l_val2Length; idx2++) { if (pVal1[pExclusion][idx1].Code == pVal2[pExclusion][idx2].Code) { match = true; break; } } if (!match) { return false; } } return true; } } return false; }; this.checkAllowance = function(l_otherFacts, p_nocolumn, p_sGridName) { /* To check allowance we need to check if Volume Mix is not 0 if volume mix is 0 then it is meant that the Deal is inactive */ var l_duplicate = {}; var l_max; for (var i = 0; i &lt; l_otherFacts.length; i++) { if (l_otherFacts[i]['VolumeMix'] &gt; 0) { if (l_duplicate[l_otherFacts[i]['Allowance']] == undefined) { l_duplicate[l_otherFacts[i]['Allowance']] = []; l_duplicate[l_otherFacts[i]['Allowance']].push(l_otherFacts[i]['DealID']); l_max = l_duplicate[l_otherFacts[i]['Allowance']].length; } else { l_duplicate[l_otherFacts[i]['Allowance']].push(l_otherFacts[i]['DealID']); l_max = l_duplicate[l_otherFacts[i]['Allowance']].length; } } }; for (var allowance in l_duplicate) { if (l_duplicate[allowance].length &lt;= l_max) { //m_objlistPractices.AllowanceSame.count += 1; var l_objBestPractice = {}; l_objBestPractice.GridName = p_sGridName; l_objBestPractice.Column = p_nocolumn; l_objBestPractice.Qualifier = 'Allowance'; l_objBestPractice.DealID = l_duplicate[allowance]; //l_objBestPractice.dealidd = l_duplicate[allowance]; m_objlistPractices.AllowanceSame.list.push(l_objBestPractice); m_objlistPractices.AllowanceSame.count += 1; } }; }; this.checkDuplicateNetList = function(p_otherFacts, p_nocolumn, p_sGridName) { //Check Duplication Net List var l_duplicate = {}; for (var i = 0; i &lt; p_otherFacts.length; i++) { if (p_otherFacts[i]['VolumeMix'] &gt; 0) { if (p_otherFacts[i]['Net_List_ATAX'] != undefined &amp;&amp; p_otherFacts[i]['Net_List_ATAX'] &gt; 0) { if (l_duplicate[p_otherFacts[i]['Net_List_ATAX']] == undefined) { l_duplicate[p_otherFacts[i]['Net_List_ATAX']] = []; l_duplicate[p_otherFacts[i]['Net_List_ATAX']].push(p_otherFacts[i]['DealID']); } else { l_duplicate[p_otherFacts[i]['Net_List_ATAX']].push(p_otherFacts[i]['DealID']); } } } }; for (var netlist in l_duplicate) { if (l_duplicate[netlist].length &gt; 1) { m_objlistPractices.DuplicateNetList.count += 1; var l_objBestPractice = {}; l_objBestPractice.GridName = p_sGridName; l_objBestPractice.Qualifier = 'Net List'; l_objBestPractice.Column = p_nocolumn; l_objBestPractice.DealID = l_duplicate[netlist]; m_objlistPractices.DuplicateNetList.list.push(l_objBestPractice); m_objlistPractices.DuplicateNetList.count += 1; } }; }; this.checkDealName = function(p_gridRow, p_sGridName) { if ((p_gridRow.data.MetricsType != &quot;Business&quot;) &amp;&amp; (p_gridRow.data.MetricsType != &quot;Volume&quot;)) { if (p_gridRow.data[&quot;DealName&quot;] == undefined || p_gridRow.data[&quot;DealName&quot;] == &quot;&quot; || p_gridRow.data[&quot;DealName&quot;] == 0) { var msg = 'Incomplete Price Line'; this.buildBestPractices(p_gridRow, &quot;Deal Name&quot;, p_sGridName, m_objlistPractices.IncompletePriceLine.list, m_objlistPractices.IncompletePriceLine.text); m_objlistPractices.IncompletePriceLine.count += 1; } } }; /*creates best practice object*/ this.buildBestPractices = function(p_gridRow, p_gridColumn, p_sGridName, p_list, p_text, p_Lvl, p_Qualifier) { var l_objBestPractice = {}; //assign grid name l_objBestPractice.GridName = p_sGridName; //if summary section if (p_sGridName == &quot;Summary&quot;) { l_objBestPractice.DealID = &quot;&quot;; l_objBestPractice.Qualifier = p_Qualifier; l_objBestPractice.RowIdx = p_gridRow; } else { //for volume/Buisness add deal id as metrics tpe if (p_gridRow.data.MetricsType == &quot;Volume&quot; || p_gridRow.data.MetricsType == &quot;Business&quot;) { l_objBestPractice.DealID = p_gridRow.data.MetricsType; } else { //assign deal id if (p_Lvl == &quot;DEAL&quot;) { l_objBestPractice.DealID = [p_gridRow.data.DealID]; } else { l_objBestPractice.DealID = p_gridRow.data.DealID; } //assign qualifier if (p_Qualifier != undefined) { l_objBestPractice.Qualifier = p_Qualifier; } } } //asign text to show and grid column l_objBestPractice.text = p_text; l_objBestPractice.Column = p_gridColumn; p_list.push(l_objBestPractice); }; this.fetchDealSubChl = function(p_DealName) { var l_arrName = p_DealName.split(&quot;-&quot;); return l_arrName[1]; }; /** * Childrens in the grid consist of facts, this function loops through children to look for * * IncompletePriceLine * * ProposedNetListDeeeper * * MinNetListGuidance * * RABNegative * * MinRABGuidance * * ProposedNetFOBDeeeper * * MinNetFOBGuidance * &lt;p&gt; &lt;img uml=&quot; * object FactList { * WP = value * WPRow = value * DA = value * DARow = value * Net_FOB = value * Net_List_ATAX = value * SDA = value * SDA = value * } * &quot;&gt; &lt;/p&gt; * @param {object} p_children children object from tree grid * @param {string} p_gridRow Grid Row index * @param {string} p_Month Month Name * @param {string} p_sGridName Grid Name * @param {object} p_guidance Guidance Data * @return {object} FactList */ this.lookupChildForBestPractices = function(p_children, p_gridRow, p_Month, p_sGridName, p_curChildren, p_guidance) { var l_facts = {}; l_facts['DealID'] = p_gridRow.data['DealID']; var l_DealName = p_gridRow.data['DealName']; //CR 1135 where when Frontline deal has a mix we have to consider WP and DA as zero if (p_gridRow.data[&quot;DealLevelCode&quot;] == &quot;Frontline&quot;) { l_facts[&quot;WP&quot;] = 0; l_facts[&quot;WPRow&quot;] = 0; l_facts[&quot;DA&quot;] = 0; l_facts[&quot;DARow&quot;] = 0; } // get lowest value facts from current grid section - to find deeper value in proposed var l_lowestFactValueArr = this.getLowestFactValueArray([&quot;Net_FOB&quot;, &quot;Net_List_ATAX&quot;], p_Month, p_sGridName); for (var childrens in p_children) { //if (this.getMonthFromString(p_Month) &gt;= this.getMonthFromString(p_children[childrens][&quot;EditableFrom&quot;])) { if ((this.getMonthFromString(p_Month) &gt;= this.getMonthFromString(m_EditableFrom) || m_HistorEditFrom[p_sGridName].hasOwnProperty(p_Month)) &amp;&amp; m_PGEffectivity[p_Month]) { //Check if this is actual based on editable from if (m_FactCode.indexOf(p_children[childrens].FactCode) &gt; 0) { if (this.ValidateNumberReturnBlank(p_children[childrens][p_Month]) === &quot;&quot;) { this.buildBestPractices(p_gridRow, p_Month, p_sGridName, m_objlistPractices.IncompletePriceLine.list, m_objlistPractices.IncompletePriceLine.text, &quot;&quot;, p_children[childrens].Qualifier); m_objlistPractices.IncompletePriceLine.count += 1; } else { if (p_children[childrens].FactCode == 'Net_List_ATAX' &amp;&amp; this.fetchDealSubChl(l_DealName) != 'WHS') { l_facts[p_children[childrens].FactCode] = p_children[childrens][p_Month]; l_facts[p_children[childrens].FactCode + 'Row'] = childrens; }; } //New priceline is deepest - Proposed priceline is deeper (NET FOB or Net List) than any current if (p_children[childrens].FactCode == &quot;Net_List_ATAX&quot;) { // check for deeper value if (l_lowestFactValueArr[p_children[childrens].FactCode] &gt; p_children[childrens][p_Month]) { this.buildBestPractices(p_gridRow, p_Month, p_sGridName, m_objlistPractices.ProposedNetListDeeeper.list, m_objlistPractices.ProposedNetListDeeeper.text + &quot; \\&quot;&quot; + l_lowestFactValueArr[p_children[childrens].FactCode] + &quot;\\&quot;&quot;, &quot;DEAL&quot;); m_objlistPractices.ProposedNetListDeeeper.count += 1; } //check with guidace value if (this.ValidateNumberReturnZero(p_children[childrens][p_Month]) &lt; this.ValidateNumberReturnZero(p_guidance[&quot;MIN_NET_LIST_GUIDLINE&quot;])) { this.buildBestPractices(p_gridRow, p_Month, p_sGridName, m_objlistPractices.MinNetListGuidance.list, m_objlistPractices.MinNetListGuidance.text + &quot; \\&quot;&quot; + p_guidance[&quot;MIN_NET_LIST_GUIDLINE&quot;] + &quot; \\&quot;&quot;, &quot;&quot;, p_children[childrens].Qualifier); m_objlistPractices.MinNetListGuidance.count += 1; } } } else { // to check RAB if (p_children[childrens].FactCode == 'RAB') { if (this.ValidateNumberReturnZero(p_children[childrens][p_Month]) &lt; 0) { this.buildBestPractices(p_gridRow, p_Month, p_sGridName, m_objlistPractices.RABNegative.list, m_objlistPractices.RABNegative.text, &quot;&quot;, p_children[childrens].Qualifier); m_objlistPractices.RABNegative.count += 1; } if (this.ValidateNumberReturnZero(p_children[childrens][p_Month]) &lt; this.ValidateNumberReturnZero(p_guidance[&quot;MIN_RAB_GUIDLINE&quot;])) { this.buildBestPractices(p_gridRow, p_Month, p_sGridName, m_objlistPractices.MinRABGuidance.list, m_objlistPractices.MinRABGuidance.text + &quot; \\&quot;&quot; + p_guidance[&quot;MIN_RAB_GUIDLINE&quot;] + &quot;\\&quot;&quot;, &quot;&quot;, p_children[childrens].Qualifier); m_objlistPractices.MinRABGuidance.count += 1; } } //31Oct15 - SDA delta - 634 if (p_children[childrens].FactCode == 'SDA' &amp;&amp; this.fetchDealSubChl(l_DealName) != 'WHS') { l_facts[p_children[childrens].FactCode] = p_children[childrens][p_Month]; l_facts[p_children[childrens].FactCode + 'Row'] = childrens; }; if (p_children[childrens].FactCode == 'DA') { //&amp;&amp; this.ValidateNumberReturnZero(p_children[childrens][p_Month]) &gt;= 0 l_facts[p_children[childrens].FactCode] = p_children[childrens][p_Month]; l_facts[p_children[childrens].FactCode + 'Row'] = childrens; }; //31Oct15 - if (p_children[childrens].FactCode == 'WP') { //&amp;&amp; this.ValidateNumberReturnZero(p_children[childrens][p_Month]) &gt;= 0 l_facts[p_children[childrens].FactCode] = p_children[childrens][p_Month]; l_facts[p_children[childrens].FactCode + 'Row'] = childrens; }; if (p_children[childrens].FactCode == &quot;Net_FOB&quot;) { // check for deeper value if (l_lowestFactValueArr[p_children[childrens].FactCode] &gt; p_children[childrens][p_Month]) { //this.buildBestPractices(p_gridRow, p_Month, p_sGridName, m_objlistPractices.ProposedNetFOBDeeeper.list, p_children[childrens].Qualifier); this.buildBestPractices(p_gridRow, p_Month, p_sGridName, m_objlistPractices.ProposedNetFOBDeeeper.list, m_objlistPractices.ProposedNetFOBDeeeper.text + &quot; \\&quot;&quot; + l_lowestFactValueArr[p_children[childrens].FactCode] + &quot;\\&quot;&quot;, &quot;DEAL&quot;); m_objlistPractices.ProposedNetFOBDeeeper.count += 1; } //check with guidace value if (this.ValidateNumberReturnZero(p_children[childrens][p_Month]) &lt; this.ValidateNumberReturnZero(p_guidance[&quot;MIN_NET_FOB_GUIDLINE&quot;])) { this.buildBestPractices(p_gridRow, p_Month, p_sGridName, m_objlistPractices.MinNetFOBGuidance.list, m_objlistPractices.MinNetFOBGuidance.text + &quot; \\&quot;&quot; + p_guidance[&quot;MIN_NET_FOB_GUIDLINE&quot;] + &quot;\\&quot;&quot;, &quot;&quot;, p_children[childrens].Qualifier); m_objlistPractices.MinNetFOBGuidance.count += 1; } } }; }; }; return l_facts; }; // to create lowest fact value array for given facts this.getLowestFactValueArray = function(p_FactNameArr, p_Month, p_sGridName) { var l_CurGrdMapping = m_ProGrdMapping[p_sGridName]; var l_lowestFactValue = []; for (var idx in l_CurGrdMapping) { // itrate for each fact name for (var factIdx in p_FactNameArr) { if (l_CurGrdMapping[idx][p_FactNameArr[factIdx]] &amp;&amp; l_CurGrdMapping[idx][p_FactNameArr[factIdx]][p_Month] &gt; 0) { if (l_lowestFactValue[p_FactNameArr[factIdx]]) { if (l_lowestFactValue[p_FactNameArr[factIdx]] &gt; l_CurGrdMapping[idx][p_FactNameArr[factIdx]][p_Month]) { l_lowestFactValue[p_FactNameArr[factIdx]] = l_CurGrdMapping[idx][p_FactNameArr[factIdx]][p_Month]; } } else { l_lowestFactValue[p_FactNameArr[factIdx]] = l_CurGrdMapping[idx][p_FactNameArr[factIdx]][p_Month]; } } } } return l_lowestFactValue; }; // check if given facts value is lesser accross deals this.compareForDeeperPrice = function(p_GridID, p_FactName, p_FactValue, p_Month, p_sGridName) { var l_ProGrdMapping = m_ProGrdMapping[p_sGridName]; var l_lowestFactValue; for (var idx in l_ProGrdMapping) { if (l_lowestFactValue) { if (l_ProGrdMapping[idx][p_FactName]) { if (l_lowestFactValue &gt; l_ProGrdMapping[idx][p_FactName][p_Month]) { l_lowestFactValue = l_ProGrdMapping[idx][p_FactName][p_Month]; } } } else { l_lowestFactValue = l_ProGrdMapping[idx][p_FactName][p_Month]; } } if (l_lowestFactValue &gt; p_FactValue) { return true } return false; }; this.ValidateNumberReturnBlank = function(p_number) { if (isNaN(p_number) || !isFinite(p_number) || (p_number == null) || (p_number === &quot;&quot;) || (p_number == undefined)) { return &quot;&quot;; } else { return p_number; } }; this.ValidateNumberReturnZero = function(p_number) { if (isNaN(p_number) || !isFinite(p_number) || (p_number == null) || (p_number === &quot;&quot;) || (p_number == undefined)) { return 0; } else { return p_number; } }; this.PanelHideEvent = function(component, eOpts) { this.removeClsfromPrevElement(); this.hideBestPracticePopup(); }; this.addClstoElement = function(p_arrelement) { if (Ext.getCmp(&quot;btnOnPremiseToggleValues&quot;).pressed) { Ext.getCmp(&quot;btnOnPremiseToggleValues&quot;).toggle(); VistaarExtjs.getCmp(&quot;tabPnlOnPremise&quot;).setActiveTab(0); } if (Ext.getCmp(&quot;btnOffPremiseToggleValues&quot;).pressed) { Ext.getCmp(&quot;btnOffPremiseToggleValues&quot;).toggle(); VistaarExtjs.getCmp(&quot;tabPnlOffPremise&quot;).setActiveTab(0); } var l_Element = []; for (var i = 0; i &lt; p_arrelement.length; i++) { var l_GridContainer = Ext.getCmp('cntPricePlanGridView'); var element = Ext.get(p_arrelement[i].id); l_Element.push(Ext.get(p_arrelement[i].id)); l_GridContainer.scrollTo(element.getX(), 0, false); l_GridContainer.scrollTo(element.getX(), element.getY() - l_GridContainer.getY() - 100, false); } this.removeClsfromPrevElement(); Ext.defer(function() { for (var i = 0; i &lt; l_Element.length; i++) { l_Element[i].removeCls('animated zoomInOut'); } Ext.defer(function() { for (var i = 0; i &lt; l_Element.length; i++) { m_prevCellElement.push(l_Element[i]); l_Element[i].addCls('animated zoomInOut'); if (p_arrelement[i].type == &quot;HardStop&quot;) { l_Element[i].addCls('clsErrorBestPractices'); } else { l_Element[i].addCls('clsSoftStopBestPractices'); } } }, 50); }, 50); }; // remove best practicce cls this.removeClsfromPrevElement = function() { if (m_prevCellElement != undefined) { for (var i = 0; i &lt; m_prevCellElement.length; i++) { try { if (m_prevCellElement[i].hasCls('clsErrorBestPractices')) { //20Oct15 m_prevCellElement[i].removeCls('clsErrorBestPractices'); } else if (m_prevCellElement[i].hasCls('clsSoftStopBestPractices')) { //20Oct15 m_prevCellElement[i].removeCls('clsSoftStopBestPractices'); } } catch (err) { console.log('Error in removeCls from previous element'); } } } m_prevCellElement = []; }; this.getRowfromGrid = function(p_GridObj, p_RowValue) { //Get the row from the grid object with uniquie DealID var l_gridRow; var l_rootNode = p_GridObj.getRootNode(); var l_data = l_rootNode.data; for (var rowIdx in l_rootNode.childNodes) { if (l_rootNode.childNodes[rowIdx].data.DealID == p_RowValue || l_rootNode.childNodes[rowIdx].data.MetricsType == p_RowValue || l_rootNode.childNodes[rowIdx].data.Qualifier == p_RowValue) { return p_GridObj.store.getAt(rowIdx); } } }; this.getRowFromSummaryGrid = function(p_GridObj, p_RowValue) { var l_data = VistaarDG.getDataFromDynamicGrid(m_DGSUMMARYPROPOSED); for (var rowIdx in l_data) { if (l_data[rowIdx].Metrics == p_RowValue) { return p_GridObj.store.getAt(rowIdx); } } } this.getRowNofromGrid = function(p_GridObj, p_RowValue) { //Get the row from the grid object with uniquie DealID var l_gridRow; var l_rootNode = p_GridObj.getRootNode(); var l_data = l_rootNode.data; for (var rowIdx in l_rootNode.childNodes) { if (l_rootNode.childNodes[rowIdx].data.DealID == p_RowValue || l_rootNode.childNodes[rowIdx].data.MetricsType == p_RowValue || l_rootNode.childNodes[rowIdx].data.Qualifier == p_RowValue) { return rowIdx; } } }; this.getColumFromGrid = function(p_GridObj, p_ColumnName) { var l_column; var l_grdColumns; l_grdColumns = p_GridObj.columns; for (var colIdx in l_grdColumns) { var l_column = l_grdColumns[colIdx]; if (l_column.text == p_ColumnName) { return l_column; } } }; this.getChildRowFrom = function(p_gridRow, p_Qualifier) { // body... for (var rowIdx in p_gridRow.childNodes) { if (p_gridRow.childNodes[rowIdx].data.Qualifier == p_Qualifier) { return rowIdx; } } }; // expand proposed Net FOB - set flag and refresh grid - 1Oct15 this.expandSummaryGrid = function() { var el = VistaarExtjs.getCmp(m_DGSUMMARYPROPOSED).DGObj.getEl(); var l_str_ParentKey = &quot;ProposedNetFOB&quot;; var l_index_ParentNode = getCommonFuncMgr().arrSummaryGrdParentRowInfo.indexOf(l_str_ParentKey); var l_objHiddenFieldInfo = getCommonFuncMgr().objSummaryGrdHiddenFieldInfo; if (l_index_ParentNode != -1) { if (l_objHiddenFieldInfo[l_str_ParentKey].hidden) { el.addCls(l_objHiddenFieldInfo[l_str_ParentKey].expandCls); l_objHiddenFieldInfo[l_str_ParentKey].hidden = false; } } VistaarExtjs.getCmp(m_DGSUMMARYPROPOSED).DGObj.view.refresh(); }; this.getElementtoaddCls = function(p_list) { var l_idlist = []; var cell = {}; // if its summary grid - 1oct15 if (p_list.GridName == &quot;Summary&quot;) { //get grid objects this.setActiveGridForBestPractice(p_list.GridName); var l_objGrid = m_objSummaryTreeGrid; //get grid view var l_grdview = l_objGrid.getView(); //get grid row and column object var l_gridRow = this.getRowFromSummaryGrid(l_objGrid, p_list.Qualifier); //l_objGrid.store.getAt(p_list.RowIdx); var l_gridCol = this.getColumFromGrid(l_objGrid, p_list.Column); //expand summary section this.expandSummaryGrid(); //get cell id //var cell = l_grdview.getCell(l_gridRow, l_gridCol); // 20Oct15 cell = {}; cell.id = l_grdview.getCell(l_gridRow, l_gridCol).id; cell.type = p_list.type; l_idlist.push(cell); } else { //17Nov15 - DA Across channel var l_objGrid = {}; var l_grdview = {}; var l_rootNode = {}; if (typeof p_list.GridName == 'object') { l_objGrid[&quot;OFF&quot;] = m_objTreeGridOff; l_objGrid[&quot;ON&quot;] = m_objTreeGridOn; l_grdview[&quot;OFF&quot;] = l_objGrid[&quot;OFF&quot;].getView(); l_grdview[&quot;ON&quot;] = l_objGrid[&quot;ON&quot;].getView(); l_rootNode[&quot;OFF&quot;] = l_objGrid[&quot;OFF&quot;].getRootNode(); l_rootNode[&quot;ON&quot;] = l_objGrid[&quot;ON&quot;].getRootNode(); l_rootNode[&quot;OFF&quot;].collapseChildren(); l_rootNode[&quot;ON&quot;].collapseChildren(); } else { l_objGrid[p_list.GridName] = (p_list.GridName == 'OFF' ? m_objTreeGridOff : m_objTreeGridOn); l_grdview[p_list.GridName] = l_objGrid[p_list.GridName].getView(); l_rootNode[p_list.GridName] = l_objGrid[p_list.GridName].getRootNode(); l_rootNode[p_list.GridName].collapseChildren(); } if (typeof p_list.DealID == 'object') { for (var i = 0; i &lt; p_list.DealID.length; i++) { //17Nov15 - DA Across channel if (typeof p_list.GridName == 'object') { var l_grdName = p_list.GridName[i]; } else { var l_grdName = p_list.GridName; } this.setActiveGridForBestPractice(l_grdName); var l_gridRow = this.getRowfromGrid(l_objGrid[l_grdName], p_list.DealID[i]); // l_rootNode.getChildAt(p_list.DealID[i]); //var cell = l_grdview.getCell(l_gridRow, this.getColumFromGrid(l_objGrid, p_list.Column)); cell = {}; cell.id = l_grdview[l_grdName].getCell(l_gridRow, this.getColumFromGrid(l_objGrid[l_grdName], p_list.Column)).id; cell.type = p_list.type; l_idlist.push(cell); cell = {} cell.id = l_grdview[l_grdName].getCell(l_gridRow, this.getColumFromGrid(l_objGrid[l_grdName], 'Deal Name')).id; cell.type = p_list.type; l_idlist.push(cell); }; } else { var l_grdName = p_list.GridName; this.setActiveGridForBestPractice(l_grdName); var l_gridRow = this.getRowfromGrid(l_objGrid[l_grdName], p_list.DealID); // l_rootNode.getChildAt(p_list.row); var l_gridCol = this.getColumFromGrid(l_objGrid[l_grdName], p_list.Column); if (p_list.Qualifier != undefined) { this.displayQualifier(p_list.Qualifier); var l_dealRow = l_rootNode[l_grdName].getChildAt(this.getRowNofromGrid(l_objGrid[l_grdName], p_list.DealID)); l_dealRow.expand(); var l_childRow = this.getChildRowFrom(l_dealRow, p_list.Qualifier); //var cell = l_grdview.getCell(l_dealRow.getChildAt(l_childRow), l_gridCol); // 20Oct15 cell = {}; cell.id = l_grdview[l_grdName].getCell(l_dealRow.getChildAt(l_childRow), l_gridCol).id; cell.type = p_list.type; l_idlist.push(cell); } else { // 28Oct15 cell = {}; cell.id = l_grdview[l_grdName].getCell(l_gridRow, l_gridCol).id; cell.type = p_list.type; l_idlist.push(cell); } } } this.addClstoElement(l_idlist); }; //This function should Ideally move into PricePlanGrid.js this.setActiveGridForBestPractice = function(p_strGridName) { if (getCommonFuncMgr().isNonDeskTopView()) { var pnlParentCard = VistaarExtjs.getCmp('cnt_PricePlan_Grid_Card'); if (p_strGridName.toLowerCase() == &quot;summary&quot;) { pnlParentCard.setActiveItem(VistaarExtjs.getCmp(&quot;cntPricePlanSummary&quot;)); } else if (p_strGridName.toLowerCase() == &quot;on&quot;) { var tabOnPremise = VistaarExtjs.getCmp(&quot;tabPnlOnPremise&quot;); pnlParentCard.setActiveItem(VistaarExtjs.getCmp(&quot;cnt_PricePlanOnPremise&quot;)); tabOnPremise.setActiveTab(0); } else if (p_strGridName.toLowerCase() == &quot;off&quot;) { var tabOffPremise = VistaarExtjs.getCmp(&quot;tabPnlOffPremise&quot;); pnlParentCard.setActiveItem(VistaarExtjs.getCmp(&quot;cnt_PricePlanOffPremise&quot;)); tabOffPremise.setActiveTab(0); } } }; this.displayQualifier = function(p_QualifierName) { var l_preference = getPricePlanControllerManagerObj().getPricePlanUIManager().m_UserPrefrence; var l_QualifierCode = this.fetchCodefromName(p_QualifierName); if (!l_preference[l_QualifierCode]) { l_preference[l_QualifierCode] = true; getPricePlanControllerManagerObj().getPricePlanUIManager().getPricePlanGridManager().refreshAllPricePlanGridsView(); } }; this.fetchCodefromName = function(p_QualifierName) { var l_arrCodeName = getPricePlanControllerManagerObj().getActivePricePlanData().UserPreference; for (var j = 0, length2 = l_arrCodeName.length; j &lt; length2; j++) { if (l_arrCodeName[j].Name == p_QualifierName) { return l_arrCodeName[j].Code; } } return undefined; }; this.PrevButtonClick = function(button, e, eOpts) { var currElement = m_currentPracticeList.getElement(); var prevElement = m_currentPracticeList.getPrevElement(); if (currElement == prevElement) { var l_prevPractice = this.getPreviousBestPractice(m_currentPracticeList.text); m_currentPracticeList = new list(l_prevPractice); m_currentPracticeList.pos = l_prevPractice.list.length - 1; prevElement = m_currentPracticeList.getElement(); var panelInfo = m_PricePlanBestPracticePopupObject.getComponent('pnlNotificationDetailInfo'); var l_pnlElement = panelInfo.getEl(); l_pnlElement.removeCls('fadeInLeft'); l_pnlElement.removeCls('fadeInRight'); l_pnlElement.removeCls('fadeOutLeft'); l_pnlElement.removeCls('fadeOutRight'); l_pnlElement.addCls('fadeOutLeft'); setTimeout(function() { l_pnlElement.removeCls('fadeOutLeft'); l_pnlElement.addCls('fadeInRight'); }, 300); } this.updateNotificationPanel(); this.getElementtoaddCls(prevElement); }; this.NextButtonClick = function(button, e, eOpts) { var currElement = m_currentPracticeList.getElement(); var nextElement = m_currentPracticeList.getNextElement(); if (currElement == nextElement) { var l_nextPractice = this.getNextBestPractice(m_currentPracticeList.text); m_currentPracticeList = new list(l_nextPractice); nextElement = m_currentPracticeList.getElement(); var panelInfo = m_PricePlanBestPracticePopupObject.getComponent('pnlNotificationDetailInfo'); var l_pnlElement = panelInfo.getEl(); l_pnlElement.removeCls('fadeInLeft'); l_pnlElement.removeCls('fadeInRight'); l_pnlElement.removeCls('fadeOutLeft'); l_pnlElement.removeCls('fadeOutRight'); l_pnlElement.addCls('fadeOutRight'); setTimeout(function() { l_pnlElement.removeCls('fadeOutRight'); l_pnlElement.addCls('fadeInLeft'); }, 300); } this.updateNotificationPanel(); this.getElementtoaddCls(nextElement); }; this.MainButtonClick = function(button, e, eOpts) { try { setWaitCursor(); Ext.defer(function() { //TOGGLE BEST PRACTICES BUTTON ................... var btn = VistaarExtjs.getCmp(&quot;btnBestPractices&quot;); btn.toggle(true); //get position this.show(btn.getX(), btn.getY(), btn.getWidth(), btn.getHeight()); this.hideBestPracticePopup(); //IT 1052 Best Practice pop up remain open this.focusBestPracticeWindow(); setDefaultCursor(); }, 20, this); } catch (err) { setDefaultCursor(); getCommonFuncMgr().printLog(err); } }; var list = function(l_data) { this.pos = 0; this.dataStore = l_data.list; this.length = this.dataStore.length; this.text = l_data.text; this.type = l_data.type; this.isReadOnly = l_data.isReadOnly; this.previous = function() { if (this.pos &gt; 0) { --this.pos; } return this.pos; }; this.next = function() { // if (this.isReadOnly) { 28Oct15 // ++this.pos; // } if (this.pos &lt; this.dataStore.length - 1) { ++this.pos; } return this.pos; }; this.getElement = function() { var l_element = this.dataStore[this.pos]; l_element[&quot;type&quot;] = this.type; // 20Oct15 //return this.dataStore[this.pos]; return l_element; }; this.getNextElement = function() { var l_element = this.dataStore[this.next()]; l_element[&quot;type&quot;] = this.type; // 20Oct15 return l_element; //return this.dataStore[this.next()]; }; this.getPrevElement = function() { var l_element = this.dataStore[this.previous()]; l_element[&quot;type&quot;] = this.type; // 20Oct15 return l_element; //return this.dataStore[this.previous()]; }; }; this.setCountOfBestPractice = function() { var l_Count = this.getCountOfBestPractice(); this.removeCountOnBestButton(); if (l_Count &gt; 0) { var l_objCount = document.createElement('span'); l_objCount.id = &quot;btnPracticeCount&quot;; l_objCount.className = &quot;notification-balloon-button&quot;; l_objCount.innerHTML = &quot;&lt;div class = 'balloon-button-inner'&gt;&quot; + l_Count + &quot;&lt;/div&gt;&quot;; var l_objParentContainer = Ext.DomQuery.selectNode('#btnBestPractices-btnEl'); l_objParentContainer.insertBefore(l_objCount, l_objParentContainer.firstChild); } }; this.removeCountOnBestButton = function() { var l_btnpractice = Ext.ComponentQuery.query('button[id=btnBestPractices]')[0]; var l_btnEl = l_btnpractice.btnEl; for (var i = l_btnEl.dom.childNodes.length - 1; i &gt;= 0; i--) { if (l_btnEl.dom.childNodes[i].id == 'btnPracticeCount') { l_btnEl.dom.removeChild(l_btnEl.dom.childNodes[i]); } }; }; this.getCountOfBestPractice = function() { var l_Count = 0; for (var practices in m_objlistPractices) { l_Count = l_Count + m_objlistPractices[practices].count; } return ('0' + l_Count).slice(-2); }; this.getCountOfHardStop = function() { var l_Count = 0; for (var practices in m_objlistPractices) { if (m_objlistPractices[practices].type == 'HardStop') { l_Count = l_Count + m_objlistPractices[practices].count; } } return l_Count; }; this.getCountOfSoftStop = function() { var l_Count = 0; for (var practices in m_objlistPractices) { if (m_objlistPractices[practices].type == 'SoftStop') { l_Count = l_Count + m_objlistPractices[practices].count; } } return l_Count; }; this.checkBestPractices = function() { // get best practicce data var l_BestPractice = getPricePlanControllerManagerObj().getBestracticeGuidanceData(); //check for best practicce data if (l_BestPractice) { //this.show(); var l_HardCount = this.getCountOfHardStop(); var l_SoftCount = this.getCountOfSoftStop(); if (l_HardCount &gt; 0) { return 'HardStop'; } else if (l_SoftCount &gt; 0) { return 'SoftStop'; } else { return false; this.hide(); } } return &quot;error&quot;; }; this.showOnSubmit = function() { if (getCommonFuncMgr().isNonDeskTopView() &amp;&amp; !VistaarExtjs.getCmp(&quot;btnExpandCollpseToolBar&quot;).pressed) { VistaarExtjs.getCmp(&quot;btnExpandCollpseToolBar&quot;).toggle(true); getPricePlanControllerManagerObj().getPricePlanUIManager().btn_ExpandCollapsePricePlanTabTool_Click(VistaarExtjs.getCmp(&quot;btnExpandCollpseToolBar&quot;)); } var obj_MenuViolation = Ext.getCmp(&quot;menuBestPractices&quot;); var l_btnpractice = Ext.ComponentQuery.query('button[id=btnBestPractices]')[0]; l_xPosition = l_btnpractice.getX(); l_yPostion = l_btnpractice.getY(); l_width = l_btnpractice.getWidth(); l_height = l_btnpractice.getHeight(); if (m_PricePlanViolationObject == undefined) { m_PricePlanViolationObject = obj_MenuViolation; obj_MenuViolation.showAt(l_xPosition - ((obj_MenuViolation.width) / 2) + (l_width / 2) - 6, l_yPostion + l_height - 5); } else { obj_MenuViolation.showAt(l_xPosition - ((obj_MenuViolation.width) / 2) + (l_width / 2) - 6, l_yPostion + l_height - 5); } /**IPAD related changes**/ obj_MenuViolation.setX(l_xPosition - ((obj_MenuViolation.width) / 2) + (l_width / 2) - 6); obj_MenuViolation.setY(l_yPostion + l_height - 5); }; this.focusBestPracticeWindow = function() { var obj_MenuViolation = Ext.getCmp(&quot;menuBestPractices&quot;); obj_MenuViolation.focus(); }; } × Search results Close "},"PricePlanFinderManager.js.html":{"id":"PricePlanFinderManager.js.html","title":"Source: PricePlanFinderManager.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: PricePlanFinderManager.js /** * * &lt;p&gt; &lt;img uml=&quot; * class PricePlanFinderManager { * -m_PricePlanFinderViewObj * -m_objCatalogGrid -m_InitialComboData * +initialize() * +initializeAllCombos() * +validateCombos() * +loadCombos() * +callPricePlanwithScope() * +btnPricePlanFinderSearch_Click() * +btnPricePlanFinderCopyPricePlan_Click() * +btnPricePlanFinderClose_Click() * } * &quot;&gt;&lt;/p&gt; * @class PricePlanFinderManager * @memberof WebUI */ function PricePlanFinderManager() { var m_PricePlanFinderViewObj; var m_MESSAGES = getObjectFactory().getGlobalConstants().PRICE_PLAN_FINDER_MESSAGE; var m_IS_AUDIT_REQUIRED = true; var m_objCatalogGrid; var m_InitialComboData; var m_CMB_PPF_FINANCIAL_YEAR = &quot;cmbPricePlanFinderFinancialYear&quot;; var m_CMB_PPF_REGION = &quot;cmbPricePlanFinderRegion&quot;; var m_CMB_PRICINGMARKET = &quot;cmbPricePlanFinderPricingMarket&quot;; var m_CMB_PPF_BRAND = &quot;cmbPricePlanFinderBrand&quot;; var m_CMB_PPF_PRICING_GROUP = &quot;cmbPricePlanFinderPricingGroup&quot;; //*****This flag is added to fixed the issue of recursive Pricing group's focus event call when script failed. var m_focusEventFlag = true; //************Function to initialize the main object of the screen************** /** * This function is used to initialize the Price Plan Finder Manager * @name initialize * @memberof WebUI.PricePlanFinderManager */ this.initialize = function () { try { if (m_PricePlanFinderViewObj == undefined) { //************PricePlanFinder View object************** m_PricePlanFinderViewObj = VistaarFunctionLib.showWindow(&quot;viewPricePlanFinder&quot;); getObjectFactory().getPricePlanFinderManager().addPPF_ComboBoxStoreSorter(); //Apply Tool-tip for PPF Work-flow Combo................. getObjectFactory().getPricePlanFinderManager().applyTooltipFor_PPF_Combo(); VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing initializeAllCombos Started&quot; }, m_IS_AUDIT_REQUIRED, 200); getObjectFactory().getPricePlanFinderManager().initializeAllCombos(); getObjectFactory().getPricePlanFinderManager().registerPricingGroupTriggerClickEvent(); } else { m_PricePlanFinderViewObj.show(); /** HANDLE FAILURE OF INITIAL LOADING **/ if (!m_InitialComboData) { getObjectFactory().getPricePlanFinderManager().initializeAllCombos(); } } getObjectFactory().getUIACLManager().applyACL(getGlobalConstantsObj().m_PRICEPLANFINDER); } catch (err) { getCommonFuncMgr().printLog(err); } //to set Window width as per resolution this.setFinderWindowWidth(); }; //Add Sorter object(Case Insensitive Sort Config) to comboBoxes store.................... this.addPPF_ComboBoxStoreSorter = function () { try { var l_objComboStoreSorter = getGlobalConstantsObj().m_ComboStoreSorter; Ext.getStore(&quot;store_TestCombo&quot;).getSorters().add(l_objComboStoreSorter); Ext.getStore(&quot;store_ComboPricingMarket&quot;).getSorters().add(l_objComboStoreSorter); Ext.getStore(&quot;store_ComboBrand&quot;).getSorters().add(l_objComboStoreSorter); Ext.getStore(&quot;store_ComboPricingGroup&quot;).getSorters().add(l_objComboStoreSorter); } catch (err) { getCommonFuncMgr().printLog(err); } } //Add Tool-tip to Price Plan Finder Combo.......... this.applyTooltipFor_PPF_Combo = function () { try { var l_ARR_PPF_ComboRef = [m_CMB_PPF_FINANCIAL_YEAR, m_CMB_PPF_REGION, m_CMB_PRICINGMARKET, m_CMB_PPF_BRAND, m_CMB_PPF_PRICING_GROUP]; for (var comboRefIndex in l_ARR_PPF_ComboRef) { getCommonFuncMgr().createToolTipForComponent(VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, l_ARR_PPF_ComboRef[comboRefIndex])[&quot;id&quot;], &quot;combobox&quot;); } } catch (err) { getCommonFuncMgr().printLog(err); } } //************Function to RegisterTriggerEvent of Pricing Group Combo************** this.registerPricingGroupTriggerClickEvent = function () { var combo = VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP); combo.triggers.picker.handler = function () { this.expand(); }; }; /** * Init function for all combo box * @name initializeAllCombos * @memberof WebUI.PricePlanFinderManager */ this.initializeAllCombos = function () { setWaitCursor(&quot;window_PricePlanFinder&quot;); var input = []; var paramValues = []; //FETCH INPUT input[0] = { &quot;Query_Id&quot; : &quot;RegionQuery&quot;, &quot;UIInput&quot; : {} }; input[1] = { &quot;Query_Id&quot; : &quot;MarketQuery&quot;, &quot;UIInput&quot; : {} }; input[2] = { &quot;Query_Id&quot; : &quot;BrandQuery&quot;, &quot;UIInput&quot; : { &quot;Brand&quot; : &quot;Brand&quot; } }; //input[3] ={&quot;Query_Id&quot;: &quot;PricingQuery&quot;,&quot;UIInput&quot;:{}}; input[3] = { &quot;Query_Id&quot; : &quot;TimeMasterQuery&quot;, &quot;UIInput&quot; : { &quot;Year&quot; : &quot;Year&quot; } }; paramValues.push(input); //************Call Script Initialize all combo************** VistaarAjax.callESExecuteScript('FetchMetaData', ['input'], paramValues, '', true, getObjectFactory().getPricePlanFinderManager().InitializeAllCombosCallBack); }; //************CallBack For Initialize All Combos************** this.InitializeAllCombosCallBack = function (ScriptOutput) { try { //************Exception Handler************** if (ScriptOutput.status.toLowerCase() == &quot;success&quot;) { var l_output = Ext.decode(ScriptOutput.response); if (l_output.solStatus.toLowerCase() == &quot;success&quot;) { var scriptResponse = JSON.parse(ScriptOutput.response).solResponse; m_InitialComboData = scriptResponse; //************Load Data Into Combo-box stores************** Ext.getStore(&quot;store_TestCombo&quot;).loadData(scriptResponse[&quot;RegionQuery&quot;]); Ext.getStore(&quot;store_ComboPricingMarket&quot;).loadData(scriptResponse[&quot;MarketQuery&quot;]); Ext.getStore(&quot;store_ComboBrand&quot;).loadData(scriptResponse[&quot;BrandQuery&quot;]); //Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData(scriptResponse[&quot;PricingQuery&quot;]); Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData([]); //Enable Pricing Group Focus event.............. m_focusEventFlag = true; VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP).setValue(&quot;&quot;); Ext.getStore(&quot;store_ComboFinancialYear&quot;).loadData(scriptResponse[&quot;TimeMasterQuery&quot;]); VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_FINANCIAL_YEAR).setValue(new Date().getFullYear().toString()); setDefaultCursor(); VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing initializeAllCombos Ended&quot; }, m_IS_AUDIT_REQUIRED, 200); } else { Ext.MessageBox.show({ title : m_MESSAGES[&quot;PPF_Script_Error&quot;][&quot;Title&quot;], msg : m_MESSAGES[&quot;PPF_Script_Error&quot;][&quot;Message&quot;], buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); setDefaultCursor(); } } else { Ext.MessageBox.show({ title : m_MESSAGES[&quot;Script Failure&quot;][&quot;Title&quot;], msg : m_MESSAGES[&quot;Script Failure&quot;][&quot;Message&quot;], buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); setDefaultCursor(); }; } catch (err) { getCommonFuncMgr().printLog(err); } }; //************Function to identify selected value of combo ************** this.onComboboxSelect = function onComboboxSelect(combobox, records, eOpts) { try { //VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, &quot;btnClosePricePlanFinder_LeftPanel&quot;).setVisible(true); //I).CALLBACK ON 'REGION' DROP DOWN SELECTION TO FETCH DATA FOR 'PRICING MARKET' DROP DOWN if (combobox.reference == m_CMB_PPF_REGION) { getObjectFactory().getPricePlanFinderManager().loadCombo_PricingMarket(); } //II).CALLBACK ON 'PRICING MARKET' DROP DOWN SELECTION TO FETCH DATA FOR 'BRAND' DROP DOWN if (combobox.reference == m_CMB_PRICINGMARKET) { //getObjectFactory().getPricePlanFinderManager().loadCombo_Brand(); getObjectFactory().getPricePlanFinderManager().validateOnPricingMarketSelection(); } //III).CALLBACK ON 'BRAND' DROP DOWN SELECTION TO FETCH DATA FOR 'PRICING GROUP' DROP DOWN if (combobox.reference == m_CMB_PPF_BRAND) { //getObjectFactory().getPricePlanFinderManager().loadCombo_PricingGroup(); getObjectFactory().getPricePlanFinderManager().validateOnBrandSelection(); } else if (combobox.reference == m_CMB_PPF_FINANCIAL_YEAR) { //Empty Pricing Group Store.............. getObjectFactory().getPricePlanFinderManager().validateOnBrandSelection(); } } catch (err) { getCommonFuncMgr().printLog(err); } }; //************Function to Load data into Pricing Group combo on expansion************** this.onComboboxExpand = function onComboboxExpand(field, eOpts) { try { var store = Ext.getStore(&quot;store_ComboPricingGroup&quot;); if (store.data.length == 0 &amp;&amp; store.getNewRecords().length == 0) { getObjectFactory().getPricePlanFinderManager().loadCombo_PricingGroup(); } } catch (err) { getCommonFuncMgr().printLog(err); } } this.loadCombo_PricingMarket = function () { try { VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing loadCombo_PricingMarket Started&quot; }, m_IS_AUDIT_REQUIRED, 201); setWaitCursor(&quot;window_PricePlanFinder&quot;); var ScriptInput = []; //Fetch selected values var valueRegionSelection = VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_REGION).getValue(); //call script var inputRegionSelection = []; ScriptInput[0] = { &quot;Query_Id&quot; : &quot;MarketQuery&quot;, &quot;UIInput&quot; : { &quot;Region&quot; : [valueRegionSelection] } } //ScriptInput[1] = { &quot;Query_Id&quot; : &quot;BrandQuery&quot;, &quot;UIInput&quot; : {} } //ScriptInput[2] ={&quot;Query_Id&quot;: &quot;PricingQuery&quot;,&quot;UIInput&quot;:{}} var paramValues = []; paramValues.push(ScriptInput); //Scrip Call VistaarAjax.callESExecuteScript('FetchMetaData', ['input'], paramValues, '', true, getObjectFactory().getPricePlanFinderManager().loadComboPricingMarketCallBack); } catch (err) { getCommonFuncMgr().printLog(err); } }; //************Call Back for Script call of load data into pricing market combo************** this.loadComboPricingMarketCallBack = function (ScriptOutput) { try { //Update data store with script output //************Exception Handler************** if (ScriptOutput.status.toLowerCase() == &quot;success&quot;) { var l_output = Ext.decode(ScriptOutput.response); if (l_output.solStatus.toLowerCase() == &quot;success&quot;) { var scriptResponse = Ext.decode(ScriptOutput.response).solResponse //************Load Data Into Combo-box stores************** Ext.getStore(&quot;store_ComboPricingMarket&quot;).loadData(scriptResponse[&quot;MarketQuery&quot;]); //Ext.getStore(&quot;store_ComboBrand&quot;).loadData(scriptResponse[&quot;BrandQuery&quot;]); //Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData(scriptResponse[&quot;PricingQuery&quot;]); //Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData([]); //Enable Pricing Group Focus event.............. m_focusEventFlag = true; VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP).setValue(&quot;&quot;); //setDefaultCursor(); VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing loadCombo_PricingMarket Ended&quot; }, m_IS_AUDIT_REQUIRED, 201); //Validate combo on Region Selection......... getObjectFactory().getPricePlanFinderManager().validateOnRegionSelection(); } else { Ext.MessageBox.show({ title : m_MESSAGES[&quot;PPF_Script_Error&quot;][&quot;Title&quot;], msg : m_MESSAGES[&quot;PPF_Script_Error&quot;][&quot;Message&quot;], buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); //setDefaultCursor(); } } else { Ext.MessageBox.show({ title : m_MESSAGES[&quot;Script Failure&quot;][&quot;Title&quot;], msg : m_MESSAGES[&quot;Script Failure&quot;][&quot;Message&quot;], buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); //setDefaultCursor(); }; } catch (err) { getCommonFuncMgr().printLog(err); } finally { setDefaultCursor(); } }; this.validateOnRegionSelection = function () { try { //Remove Data from PricingGroup Store.............. VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP).setValue(&quot;&quot;); Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData([]); //Enable Pricing Group Focus event.............. m_focusEventFlag = true; //Validate Pricing Market var l_cmb_PPF_Market = VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PRICINGMARKET); var valueMarketSelection = l_cmb_PPF_Market.getValue(); var l_bln_isMarketPresent = l_cmb_PPF_Market.findRecord(l_cmb_PPF_Market.valueField, valueMarketSelection); if (!l_bln_isMarketPresent) { l_cmb_PPF_Market.setValue(&quot;&quot;); } } catch (err) { getCommonFuncMgr().printLog(err); } }; this.validateOnPricingMarketSelection = function () { try { //Validation checking for Brand Combo doesn't required......... //Validate Pricing Group....... VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP).setValue(&quot;&quot;); Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData([]); //Enable Pricing Group Focus event.............. m_focusEventFlag = true; } catch (err) { getCommonFuncMgr().printLog(err); } } this.validateOnBrandSelection = function () { try { //Validate Pricing Group Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData([]); //Enable Pricing Group Focus event.............. m_focusEventFlag = true; VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP).setValue(&quot;&quot;); } catch (err) { getCommonFuncMgr().printLog(err); } }; //************Function to Load data into Brand Combo************** this.loadCombo_Brand = function () { try { setWaitCursor(&quot;window_PricePlanFinder&quot;); VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing loadCombo_Brand Started&quot; }, m_IS_AUDIT_REQUIRED, 202); //Fetch selected values var valuePricingMarketSelection = VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PRICINGMARKET).getValue(); var valueRegionSelection = VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_REGION).getValue(); //call script var ScriptInput = []; // ScriptInput[0] = { &quot;Query_Id&quot; : &quot;BrandQuery&quot;, &quot;UIInput&quot; : { &quot;Region&quot; : [valueRegionSelection], &quot;Market&quot; : [valuePricingMarketSelection] } } //ScriptInput[1] ={&quot;Query_Id&quot;: &quot;PricingQuery&quot;,&quot;UIInput&quot;:{&quot;Region&quot;:[valueRegionSelection],&quot;Market&quot;:[valuePricingMarketSelection]}} var paramValues = []; paramValues.push(ScriptInput); //call script VistaarAjax.callESExecuteScript('FetchMetaData', ['input'], paramValues, '', true, getObjectFactory().getPricePlanFinderManager().loadComboBrandCallBack); } catch (err) { getCommonFuncMgr().printLog(err); } } //************Call back Function on script call for load data into Brand combo ************** this.loadComboBrandCallBack = function (ScriptOutput) { try { //************Exception Handler************** if (ScriptOutput.status.toLowerCase() == &quot;success&quot;) { var l_output = Ext.decode(ScriptOutput.response); if (l_output.solStatus.toLowerCase() == &quot;success&quot;) { //Update data store with script output var scriptResponse = Ext.decode(ScriptOutput.response).solResponse; //************Load Data Into Combo-box stores************** Ext.getStore(&quot;store_ComboBrand&quot;).loadData(scriptResponse[&quot;BrandQuery&quot;]); //Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData(scriptResponse[&quot;PricingQuery&quot;]); Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData([]); //Enable Pricing Group Focus event.............. m_focusEventFlag = true; VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP).setValue(&quot;&quot;); //setDefaultCursor(); VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing loadCombo_Brand Ended&quot; }, m_IS_AUDIT_REQUIRED, 202); } else { Ext.MessageBox.show({ title : m_MESSAGES[&quot;PPF_Script_Error&quot;][&quot;Title&quot;], msg : m_MESSAGES[&quot;PPF_Script_Error&quot;][&quot;Message&quot;], buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); //setDefaultCursor(); } } else { Ext.MessageBox.show({ title : m_MESSAGES[&quot;Script Failure&quot;][&quot;Title&quot;], msg : m_MESSAGES[&quot;Script Failure&quot;][&quot;Message&quot;], buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); //setDefaultCursor(); }; } catch (err) { getCommonFuncMgr().printLog(err); } finally { setDefaultCursor(); } }; //************Function to Load data into PricingGroup Combo************** this.loadCombo_PricingGroup = function () { try { setWaitCursor(&quot;window_PricePlanFinder&quot;); VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing loadCombo_PricingGroup Started&quot; }, m_IS_AUDIT_REQUIRED, 203); var objPricingGroupData; //Fetch selected values var valueRegionSelection = VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_REGION).getValue(); var valuePricingMarketSelection = VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PRICINGMARKET).getValue(); var valueBrandSelection = VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_BRAND).getValue(); var valueYearSelection = getCommonFuncMgr().getComboBoxValue(VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_FINANCIAL_YEAR)); //call script var inputBrandSelection = []; inputBrandSelection[0] = { &quot;Query_Id&quot; : &quot;PricingQuery&quot;, &quot;UIInput&quot; : { &quot;Region&quot; : (valueRegionSelection == null) || (valueRegionSelection == &quot;&quot;) ? [] : [valueRegionSelection], &quot;Market&quot; : (valuePricingMarketSelection == null) || (valuePricingMarketSelection == &quot;&quot;) ? [] : [valuePricingMarketSelection], &quot;Brand&quot; : (valueBrandSelection == null) || (valueBrandSelection == &quot;&quot;) ? [] : [valueBrandSelection], &quot;Year&quot; : (valueYearSelection == null) || (valueYearSelection == &quot;&quot;) ? [] : [valueYearSelection] } } var paramValues = []; paramValues.push(inputBrandSelection); //Script call VistaarAjax.callESExecuteScript('FetchMetaData', ['input'], paramValues, '', true, getObjectFactory().getPricePlanFinderManager().loadComboPricingGroupCallBack); } catch (err) { getCommonFuncMgr().printLog(err); } } //************Call back Function on script call for load data into PricingGroup combo ************** this.loadComboPricingGroupCallBack = function (ScriptOutput) { try { //************Exception Handler************** if (ScriptOutput.status.toLowerCase() == &quot;success&quot;) { var l_output = Ext.decode(ScriptOutput.response); if (l_output.solStatus.toLowerCase() == &quot;success&quot;) { //Update data store with script output var scriptResponse = Ext.decode(ScriptOutput.response).solResponse; //************Load Data Into Combo-box stores************** Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData(scriptResponse[&quot;PricingQuery&quot;]); //setDefaultCursor(); VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing loadCombo_PricingGroup Ended&quot; }, m_IS_AUDIT_REQUIRED, 203); m_focusEventFlag = true; } else { Ext.MessageBox.show({ title : m_MESSAGES[&quot;PPF_Script_Error&quot;][&quot;Title&quot;], msg : m_MESSAGES[&quot;PPF_Script_Error&quot;][&quot;Message&quot;], buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); //setDefaultCursor(); m_focusEventFlag = false; } } else { Ext.MessageBox.show({ title : m_MESSAGES[&quot;Script Failure&quot;][&quot;Title&quot;], msg : m_MESSAGES[&quot;Script Failure&quot;][&quot;Message&quot;], buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); m_focusEventFlag = false; //setDefaultCursor(); }; } catch (err) { getCommonFuncMgr().printLog(err); } finally { setDefaultCursor(); } }; //************Function to Search PricePlan as per selected scope************** this.btnPricePlanFinderSearch_Click = function () { try { VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing PricePlanFinderSearch_Click Started&quot; }, m_IS_AUDIT_REQUIRED, 204); //************Fetch Selection of all combos ************** var inputComboSelection = { &quot;Region&quot; : getCommonFuncMgr().getComboBoxValue(VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_REGION)), &quot;Pricing Market&quot; : getCommonFuncMgr().getComboBoxValue(VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PRICINGMARKET)), &quot;Brand&quot; : getCommonFuncMgr().getComboBoxValue(VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_BRAND)), &quot;Price Category&quot; : getCommonFuncMgr().getComboBoxValue(VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP)), &quot;Year&quot; : getCommonFuncMgr().getComboBoxValue(VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_FINANCIAL_YEAR)) }; //inputComboSelection = getObjectFactory().getPricePlanFinderManager().InputComboSelectionValidate(inputComboSelection) //var l_arrFilterCondition = getObjectFactory().getPricePlanFinderManager().getFilterStringsForCE(inputComboSelection); var l_arrFilterCondition = getObjectFactory().getPricePlanFinderManager().getAdvancedFilterStringsForCE(inputComboSelection); if (m_objCatalogGrid === undefined) { /********* PPF Right Panel Initial Configuration *********/ //************Right Side Panel object************** VistaarExtjs.getCmp(&quot;cntPricePlanFinderSearch&quot;).show(); //show left Panel Collapse button....... VistaarExtjs.getCmp(&quot;btnPPFCollapseLeftPanel&quot;).show(); //Remove Close button of left panel VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, &quot;btnClosePricePlanFinder_LeftPanel&quot;).hide(); //Create PPF Catalog Explorer............. var CEGridConfig = getObjectFactory().getConfigurationManager().getCatalogExplorerPPFConfig(l_arrFilterCondition); m_objCatalogGrid = VistaarCE.openCatalogExplorer(CEGridConfig); } else { /*loadLibraryWithFilters API problem has been solved in 1.3.0.0 release*/ //VistaarCE.loadLibraryWithFilters('PricePlanFinderCE', 'PricePlanView', getObjectFactory().getPricePlanFinderManager().getAdvancedFilterStringsForCE(inputComboSelection)); VistaarCE.destroyCatalogExplorer('PricePlanFinderCE'); var CEGridConfig = getObjectFactory().getConfigurationManager().getCatalogExplorerPPFConfig(l_arrFilterCondition); m_objCatalogGrid = VistaarCE.openCatalogExplorer(CEGridConfig); } VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing PricePlanFinderSearch_Click Ended&quot; }, m_IS_AUDIT_REQUIRED, 204); } catch (err) { getCommonFuncMgr().printLog(err); } }; //************Function to Validate Selection of all combos************** this.InputComboSelectionValidate = function (l_inputcombovalues) { for (var key in l_inputcombovalues.UIInput) { if (l_inputcombovalues.UIInput[key] == null) l_inputcombovalues.UIInput[key] = &quot;&quot;; } return l_inputcombovalues; }; //************Function to return Filter String for CE****************************** this.getFilterStringsForCE = function (p_objSelectedScope) { try { var p_arrFilterConndition = []; var l_objFilterCondition; for (var l_fieldName in p_objSelectedScope) { if (p_objSelectedScope[l_fieldName] != &quot;&quot; &amp;&amp; p_objSelectedScope[l_fieldName] != null) { l_objFilterCondition = { &quot;FieldName&quot; : l_fieldName, &quot;Value&quot; : { &quot;Type&quot; : &quot;Text&quot;, &quot;Content&quot; : p_objSelectedScope[l_fieldName] }, &quot;ConditionType&quot; : &quot;=&quot; }; p_arrFilterConndition.push(l_objFilterCondition); } } return p_arrFilterConndition; } catch (err) { getCommonFuncMgr().printLog(err); } } this.getAdvancedFilterStringsForCE = function (p_objSelectedScope) { try { var l_filterString = { &quot;CaseInsensitiveSearch&quot; : &quot;true&quot;, &quot;OrderBy&quot; : [{ &quot;FieldName&quot; : &quot;Region Name&quot;, &quot;Ascending&quot; : &quot;True&quot; }, { &quot;FieldName&quot; : &quot;Pricing Market Name&quot;, &quot;Ascending&quot; : &quot;True&quot; }, { &quot;FieldName&quot; : &quot;Brand Name&quot;, &quot;Ascending&quot; : &quot;True&quot; }, { &quot;FieldName&quot; : &quot;Price Category Name&quot;, &quot;Ascending&quot; : &quot;True&quot; } ], &quot;Units&quot; : [{ &quot;Units&quot; : [], &quot;UnitOperator&quot; : &quot;Or&quot;, &quot;ConditionOperator&quot; : &quot;And&quot;, &quot;Condition&quot; : [] } ] }; for (var l_fieldName in p_objSelectedScope) { if (p_objSelectedScope[l_fieldName] != &quot;&quot; &amp;&amp; p_objSelectedScope[l_fieldName] != null) { l_objFilterCondition = { &quot;FieldName&quot; : l_fieldName, &quot;Value&quot; : { &quot;Type&quot; : &quot;Text&quot;, &quot;Content&quot; : p_objSelectedScope[l_fieldName] }, &quot;ConditionType&quot; : &quot;=&quot; }; l_filterString[&quot;Units&quot;][0][&quot;Condition&quot;].push(l_objFilterCondition); } } return l_filterString; } catch (err) { getCommonFuncMgr().printLog(err); } } /* this.getTimeUnitObj = function (pValue) { try { var l_requiredArray = [{ &quot;Units&quot; : [], &quot;UnitOperator&quot; : &quot;Or&quot;, &quot;ConditionOperator&quot; : &quot;And&quot;, &quot;Condition&quot; : [{ &quot;FieldName&quot; : &quot;Year&quot;, &quot;Value&quot; : { &quot;Type&quot; : &quot;Text&quot;, &quot;Content&quot; : pValue }, &quot;ConditionType&quot; : &quot;=&quot; } ] }, { &quot;Units&quot; : [], &quot;UnitOperator&quot; : &quot;Or&quot;, &quot;ConditionOperator&quot; : &quot;And&quot;, &quot;Condition&quot; : [{ &quot;FieldName&quot; : &quot;Year&quot;, &quot;Value&quot; : { &quot;Type&quot; : &quot;Text&quot;, &quot;Content&quot; : pValue }, &quot;ConditionType&quot; : &quot;ISNULL&quot; }, { &quot;FieldName&quot; : &quot;PC_START_DATE&quot;, &quot;Value&quot; : { &quot;Type&quot; : &quot;Text&quot;, &quot;Content&quot; : pValue }, &quot;ConditionType&quot; : &quot;&gt;=&quot; }, { &quot;FieldName&quot; : &quot;PC_END_DATE&quot;, &quot;Value&quot; : { &quot;Type&quot; : &quot;Text&quot;, &quot;Content&quot; : pValue }, &quot;ConditionType&quot; : &quot;&lt;=&quot; } ] } ]; } catch (err) { getCommonFuncMgr().printLog(err); } } */ //************Function to display search count************** this.displaySearchResultCount = function (pCount) { //************Count search Result************** Ext.getCmp(&quot;lblPricePlanFinderSearchCount&quot;).setText(pCount); if (pCount &lt;= 0) { Ext.MessageBox.show({ title : 'Information', msg : &quot;No Price Plans found for this Scope&quot;, buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.INFO }); }; // setDefaultCursor(); }; //************Function to close PriceplanFinder************** this.btnPricePlanFinderClose_Click = function () { var w = Ext.getCmp('window_PricePlanFinder'); /*var el = w.getEl(); el.removeCls('slideInLeft'); el.addCls('slideOutLeft'); setTimeout(function () { var w = Ext.getCmp('window_PricePlanFinder'); w.hide(); el.removeCls('slideOutLeft'); }, 500);*/ w.hide(); } //Show Price Plan Finder Window................ this.showPricePlanFinderScreen = function () { VistaarExtjs.getCmp('window_PricePlanFinder').show(); getObjectFactory().getUIACLManager().applyACL(getGlobalConstantsObj().PRICEPLANFINDER); } //************Function to open Deal view From PricePlanFinder************** this.btnPricePlanFinderOpenPricePlan_Click = function (p_button, l_e, l_eOpts) { try { var l_arrSelectionData = []; //var l_rowselectionData; var l_OpenPPStatus; l_arrSelectionData = VistaarExtjs.getCmp(VistaarCE.getDynamicGridViewId(&quot;PricePlanFinderCE&quot;)).getSelectionModel().getSelection(); if (l_arrSelectionData.length &gt; 0) { //l_rowselectionData = l_arrSelectionData[0]; getObjectFactory().getPricePlanFinderManager().btnPricePlanFinderClose_Click(); getPricePlanControllerManagerObj().setPricePlanViewWaitCursor('viewContainer'); //window_PricePlanFinder Ext.defer(function () { l_OpenPPStatus = getObjectFactory().getPricePlanFinderManager().callPricePlanwithScope(l_arrSelectionData[0]); if (l_OpenPPStatus === false) { //Stay on Price Plan Finder Screen ........................ getObjectFactory().getPricePlanFinderManager().showPricePlanFinderScreen(); } }, 10); } else { Ext.MessageBox.show({ title : 'Price Plan Finder', msg : &quot;Please Select Price Plan&quot;, buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); } } catch (err) { console.log(err); } }; //************Function to open deal View on price-plan double click************** this.onItemDblClick = function (p_button, p_e, p_eOpts) { try { var l_OpenPPStatus; getPricePlanControllerManagerObj().setPricePlanViewWaitCursor('viewContainer'); getObjectFactory().getPricePlanFinderManager().btnPricePlanFinderClose_Click(); Ext.defer(function () { l_OpenPPStatus = getObjectFactory().getPricePlanFinderManager().callPricePlanwithScope(p_e); if (l_OpenPPStatus === false) { //Stay on Price Plan Finder Screen ........................ getObjectFactory().getPricePlanFinderManager().showPricePlanFinderScreen(); } }, 100); } catch (err) { console.log(err); } }; this.callPricePlanwithScope = function (p_objSelectedGridRow) { try { var l_scopeObj = {}; var SkipOpenPricePlanCall = false; var l_rowselectionData = p_objSelectedGridRow.getData(); var l_scopeObj = { &quot;Region&quot; : l_rowselectionData['Region'], &quot;Region Name&quot; : l_rowselectionData['Region Name'], &quot;Pricing Market Name&quot; : l_rowselectionData['Pricing Market Name'], &quot;Pricing Market&quot; : l_rowselectionData['Pricing Market'], &quot;Brand Name&quot; : l_rowselectionData['Brand Name'], &quot;Brand&quot; : l_rowselectionData['Brand'], &quot;Pricing Group Name&quot; : l_rowselectionData['Price Category Name'], &quot;Pricing Group&quot; : l_rowselectionData['Price Category'], &quot;Time&quot; : l_rowselectionData['Year'] }; //Check for Incomplete Scope.......................... for (var scopeAttr in l_scopeObj) { if (l_scopeObj[scopeAttr] === undefined || l_scopeObj[scopeAttr] === null) { SkipOpenPricePlanCall = true; break; } } if (SkipOpenPricePlanCall) { Ext.MessageBox.show({ title : m_MESSAGES[&quot;IncompleteScope&quot;][&quot;Title&quot;], msg : m_MESSAGES[&quot;IncompleteScope&quot;][&quot;Message&quot;], buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.INFO }); //getObjectFactory().getPricePlanFinderManager().showPricePlanFinderScreen(); setDefaultCursor(); } else { //Check whether already opened price plan has been changed or not......................... if (getPricePlanControllerManagerObj().isPricePlanDirty()) { Ext.MessageBox.confirm(m_MESSAGES[&quot;Save&quot;][&quot;Title&quot;], m_MESSAGES[&quot;Save&quot;][&quot;Message&quot;], function (p_btn) { //Discard the changes and Open New Price Plan............. if (p_btn == &quot;yes&quot;) { Ext.defer(function () { getObjectFactory().getPricePlanFinderManager().openPricePlanCallback(l_scopeObj); }, 100); } else { setDefaultCursor(); //Stay on Price Plan Finder Screen ........................ return false; } }); } else { getObjectFactory().getPricePlanFinderManager().openPricePlanCallback(l_scopeObj); } } } catch (err) { getCommonFuncMgr().printLog(err); } } this.openPricePlanCallback = function (p_scopeObj) { // getObjectFactory().getPricePlanFinderManager().btnPricePlanFinderClose_Click(); Ext.getCmp(&quot;btnToolbarHome&quot;).toggle(false); getObjectFactory().getPricePlanControllerManager().renderPricePlanUI(p_scopeObj); // setDefaultCursor(); } //************Function to Clear All Filters of grid************** this.btnPricePlanFinderClearFilter_Click = function () { try { VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing clearAllFilters Started&quot; }, m_IS_AUDIT_REQUIRED, 205); getObjectFactory().getCommonFunctionsManager().removeInlineFiltersForGrid(VistaarCE.getDynamicGridId(&quot;PricePlanFinderCE&quot;)); VistaarAuditingManager.audit({ &quot;name&quot; : &quot;UIProcessing clearAllFilters Ended&quot; }, m_IS_AUDIT_REQUIRED, 205); } catch (err) { getCommonFuncMgr().printLog(err); } }; //************Function to Reset all combo values************** this.btnPricePlanFinderResetCombos_Click = function () { try { VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_REGION).clearValue(); VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PRICINGMARKET).clearValue(); VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_BRAND).clearValue(); VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP).clearValue(); VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_FINANCIAL_YEAR).clearValue(); if (m_InitialComboData === undefined) { getObjectFactory().getPricePlanFinderManager().initializeAllCombos(); } else { //************Load Data Into Combo-box stores************** Ext.getStore(&quot;store_TestCombo&quot;).loadData(m_InitialComboData[&quot;RegionQuery&quot;]); Ext.getStore(&quot;store_ComboPricingMarket&quot;).loadData(m_InitialComboData[&quot;MarketQuery&quot;]); Ext.getStore(&quot;store_ComboBrand&quot;).loadData(m_InitialComboData[&quot;BrandQuery&quot;]); //Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData(scriptResponse[&quot;PricingQuery&quot;]); Ext.getStore(&quot;store_ComboPricingGroup&quot;).loadData([]); //Enable Pricing Group Focus event.............. m_focusEventFlag = true; Ext.getStore(&quot;store_ComboFinancialYear&quot;).loadData(m_InitialComboData[&quot;TimeMasterQuery&quot;]); VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_FINANCIAL_YEAR).setValue(new Date().getFullYear().toString()); } } catch (err) { getCommonFuncMgr().printLog(err); } } this.onPGComboboxFocus = function (component, event, eOpts) { if (m_focusEventFlag) { VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, m_CMB_PPF_PRICING_GROUP).expand(); } } this.onBtnPPFExpandCollapseLeftPanelClick = function (button, e, eOpts) { try { if (button.id === &quot;btnPPFCollapseLeftPanel&quot;) { VistaarExtjs.getCmp(&quot;PPFLeftPanel&quot;).hide(); VistaarExtjs.getCmp(&quot;btnPPFExpandLeftPanel&quot;).show(); } else { VistaarExtjs.getCmp(&quot;PPFLeftPanel&quot;).show(); VistaarExtjs.getCmp(&quot;btnPPFExpandLeftPanel&quot;).hide(); } getObjectFactory().getPricePlanFinderManager().setFinderWindowWidth(); } catch (err) { getCommonFuncMgr().printLog(err); } } this.afterPPFGridRenderer = function () { try { var l_searchCount = parseInt(Ext.getCmp('PricePlanFinderCE').m_numTotalCount); getObjectFactory().getPricePlanFinderManager().displaySearchResultCount(l_searchCount); if (l_searchCount &lt;= 0) { //Disabled Open and Copy PP Button................. VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, &quot;btnPricePlanFinderOpenPricePlan&quot;).setDisabled(true); VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, &quot;btnPricePlanFinderCopyPricePlan&quot;).setDisabled(true); } else { //Enabled Open and Copy PP Button................. VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, &quot;btnPricePlanFinderOpenPricePlan&quot;).setDisabled(false); VistaarFunctionLib.getCompByReference(m_PricePlanFinderViewObj, &quot;btnPricePlanFinderCopyPricePlan&quot;).setDisabled(false); } } catch (err) { getCommonFuncMgr().printLog(err); } } this.btnPricePlanFinderCopyPricePlan_Click = function () { try { var l_arrSelectionData = []; //var l_rowselectionData; l_arrSelectionData = VistaarExtjs.getCmp(VistaarCE.getDynamicGridViewId(&quot;PricePlanFinderCE&quot;)).getSelectionModel().getSelection(); if (l_arrSelectionData.length &gt; 0) { //l_rowselectionData = l_arrSelectionData[0]; getObjectFactory().getPricePlanFinderManager().btnPricePlanFinderClose_Click(); setWaitCursor('viewContainer'); //window_PricePlanFinder Ext.defer(function () { getObjectFactory().getPricePlanFinderManager().callCopyPricePlanWithScope(l_arrSelectionData[0]); }, 100); } else { Ext.MessageBox.show({ title : 'Price Plan Finder', msg : &quot;Please Select Price Plan&quot;, buttons : Ext.MessageBox.OK, icon : Ext.MessageBox.ERROR }); } } catch (err) { getCommonFuncMgr().printLog(err); } } this.callCopyPricePlanWithScope = function (p_objSelectedGridRow) { try { var l_scopeObj = {}; var l_rowselectionData = p_objSelectedGridRow.getData(); var l_scopeObj = { &quot;Region&quot; : l_rowselectionData['Region'], &quot;Pricing Market&quot; : l_rowselectionData['Pricing Market'], &quot;Brand&quot; : l_rowselectionData['Brand'], &quot;Price Category&quot; : l_rowselectionData['Price Category'], &quot;Year&quot; : l_rowselectionData['Year'] }; //CALL COPY PRICE PLAN API WITH SCOPE OBJECT................................. getMPCObjectFactory().getPriceMaintenanceManager().initialize(l_scopeObj); } catch (err) { getCommonFuncMgr().printLog(err); } } this.setFinderWindowWidth = function () { var l_ScreenWidth = Ext.Element.getViewportWidth(); if (Ext.getCmp(&quot;PPFLeftPanel&quot;).hidden) { var l_computedWidth = parseFloat(l_ScreenWidth)-40; Ext.getCmp(&quot;cntPricePlanFinderSearch&quot;).setWidth(l_computedWidth); } else { var l_computedWidth = parseFloat(l_ScreenWidth) - 390; Ext.getCmp(&quot;cntPricePlanFinderSearch&quot;).setWidth(l_computedWidth); } } } × Search results Close "},"WF_NS_PS_Generic.js.html":{"id":"WF_NS_PS_Generic.js.html","title":"Source: WF_NS_PS_Generic.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: WF_NS_PS_Generic.js /******************************************************************************** This work contains or references Vistaar generic components or Vistaar API, and is developed in accordance with Vistaar best practices and solution development guidelines. This work is designed and intended to be used only with licensed Vistaar software. ********************************************************************************/ /** * @fileOverview Generic Functions for Workflow Process definition inline scripts * @author anadar * @version 1.0.0 */ /** * ![Process Defintion](img/processDefinitionImage.jpg) * @class WF_NS_PS_Generic * @requires GWF_Normalize * @requires BRMSConnector * @requires WF_NS_PriceStructure */ function WF_NS_PS_Generic() { /** * It is called from process definition and it executes `ApprovalDecision_NodeEnter_Execute` function * @memberof WF_NS_PS_Generic * @function * @name ApprovalDecision_NodeEnter * @param {object} executionContext Workflow Execution Context * @example * &lt;super-state name=&quot;super-state1&quot;&gt; &lt;decision name=&quot;Approval Decision&quot; expression=&quot;#{ApprovalDecisionTransition}&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.ApprovalDecision_NodeEnter(executionContext); @--&gt; &lt;/javascript&gt; &lt;/action&gt; &lt;/event&gt; &lt;transition to=&quot;Pending Approval&quot; name=&quot;Approval Required&quot;&gt;&lt;/transition&gt; &lt;transition to=&quot;Publish Decision&quot; name=&quot;Approve&quot;&gt;&lt;/transition&gt; */ this.ApprovalDecision_NodeEnter = function (executionContext) { //throw(&quot;Document is updated by another user. &quot;); try { var startTime = new Date(); this.ApprovalDecision_NodeEnter_Execute(executionContext); var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### ApprovalDecision_NodeEnter End : Execution Time (milliseconds) : &quot; + executionTime); } catch (error) { println(&quot;#### Error occured in ApprovalDecision_NodeEnter : &quot; + error); println(&quot;#### Rejecting PriceStructure&quot;); executionContext.setVariable(&quot;ApproveMailUser&quot;, &quot;&quot;); executionContext.leaveNode(&quot;Reject&quot;); throw(error); } } /** * This where approval decesion starts following things are done here * * Check if its Future Planning if it is then auto publish the plan * * Check the current Level of the Price Plan * * Look up Delegates for the the current Level of the Price Plan * * If there are Delegates do a transition to Pending Approval * * If thera are no Delegates do a transition to Approved/Published based on Posting Market Information * @name ApprovalDecision_NodeEnter_Execute * @memberof WF_NS_PS_Generic * @function * @param {object} executionContext Workflow Execution Context */ this.ApprovalDecision_NodeEnter_Execute = function(executionContext) { //Place Transition name in ApprovalDecisionTransition //Setting default to Reject println(&quot;START :: ApprovalDecision_NodeEnter_Execute&quot;); var ActorHistoryInfo = executionContext.getVariable(&quot;ActorHistoryInfo&quot;); if(ActorHistoryInfo != null){ ActorHistoryInfo = new JSONObject(ActorHistoryInfo); println(&quot;##Inside IF&quot;); }else{ println(&quot;##Inside ELSE&quot;); ActorHistoryInfo = new JSONObject(); } var approvalDecisionTransition = &quot;Reject&quot;; var module = &quot;ApproverMatrix&quot;; executionContext.setVariable(&quot;CurrentState&quot;, &quot;Approval Decision&quot;); var userDecision = executionContext.getVariable(&quot;UserDecision&quot;); if (userDecision == null) userDecision = &quot;&quot;; var IsNonPostingMarket = executionContext.getVariable(&quot;IsNonPostingMarket&quot;); var IsFuturePlanning = executionContext.getVariable(&quot;IsFuturePlanning&quot;); println(&quot;IsNonPostingMarket &gt;&gt; &quot; + IsNonPostingMarket + &quot; / IsFuturePlanning &gt;&gt; &quot; + IsFuturePlanning); var userConnInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var ppdocID=executionContext.getVariable(&quot;Document Id&quot;); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); println(&quot;Document Id &gt; &quot; + ppdocID); println(&quot;userConnInfo &gt; &quot; + userConnInfo); println(&quot;docProvider &gt; &quot; + docProvider); var Current_Level = parseInt(executionContext.getVariable(&quot;Approve_Level&quot;)); var Max_Level = parseInt(executionContext.getVariable(&quot;MaxApproval&quot;)); var isScopeValid = true; println(&quot;Max_Level &gt; &quot; + Max_Level); println(&quot;Current_Level || &quot; + Current_Level); //Planning year condition for auto-approval if(IsFuturePlanning == 1){ println(&quot;####################### In ApprovalDecision_NodeEnter_Execute: IsFuturePlanning SYSTEM Approve&quot;); executionContext.setVariable(&quot;ApproveMailUser&quot;, &quot;&quot;); executionContext.setVariable(&quot;ApproverRoles&quot;,&quot;&quot;); approvalDecisionTransition = &quot;Approve&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, true); /* println(&quot;\\n\\n \\n saveHistoricData Start &gt; =====================&quot; ); var historicImpactObj = new HistoricImapact(); historicImpactObj.saveHistoricData(ppdocID, docProvider, userConnInfo); println(&quot; saveHistoricData end &gt; =====================&quot; ); */ }else{ //println(&quot;Max_Level &gt; &quot; + Max_Level); //println(&quot;Current_Level || &quot; + Current_Level); for (;Current_Level &lt;= Max_Level; Current_Level++) { //================================================================ //Get Approver Roles from BRMS and set executionContext variables - START //================================================================ // update Approve_Level in executionContext executionContext.setVariable(&quot;Approve_Level&quot;, String(Current_Level)); //Get Price Structure Doc var priceStructureDoc = this.GetPriceStructure(executionContext); var approverLevelNumber = executionContext.getVariable(&quot;Approve_Level&quot;); var approverLevel = &quot;Level&quot; + approverLevelNumber; println(&quot;Approval Level ....&gt;&gt; &quot; + approverLevelNumber); //Get BRMS Input Object var DefinitionType = &quot;PricePlan&quot;; var scope = executionContext.getVariable(&quot;Scope&quot;); var scopeJSONObj = new org.json.JSONObject(scope); println(&quot;scopeJSONObj &gt; &quot; + scopeJSONObj); var userConnInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var permissionAdapter = new PermissionMtxAdapter_Intf(); permissionAdapter.Init(docProvider, userConnInfo); var approversInfo = permissionAdapter.getApprover(DefinitionType, scopeJSONObj, priceStructureDoc, ApproverMatrixConditional, approverLevel); println(&quot;approversInfo: &quot; + approversInfo); var approverRoles; if (approversInfo.has(&quot;Delegates&quot;)) { approverRoles = approversInfo.get(&quot;Delegates&quot;); approverRoles = new org.json.JSONArray(approverRoles.toString()); } else approverRoles = new org.json.JSONArray(); //Get approverMessages from approversInfo var approverMessages; if (approversInfo.has(&quot;Messages&quot;)) { approverMessages = approversInfo.get(&quot;Messages&quot;); approverMessages = new org.json.JSONArray(approverMessages.toString()); } else approverMessages = new org.json.JSONArray(); if(approverLevelNumber &gt; 1){ var currentUserRole = userConnInfo.getRoleName(); var oldLevelNumber = approverLevelNumber - 1; var oldApproverLevel = &quot;Level&quot; + oldLevelNumber; executionContext.setVariable(oldApproverLevel, currentUserRole.toString()); } println(&quot;###### in ApprovalDecision_NodeEnter_Execute : approverRoles : &quot; + approverRoles.toString()); println(&quot;###### in ApprovalDecision_NodeEnter_Execute : approverMessages : &quot; + approverMessages.toString()); var approverMessagesString = this.FormatUserMessage(approverMessages); if(approverMessagesString!=null) executionContext.setVariable(&quot;ApproverRoleMessagesString&quot;, approverMessagesString.toString()); //Add audit logs println(&quot;###### in ApprovalDecision_NodeEnter_Execute : Add audit logs&quot;); var auditLogDocIds = this.AddAuditLog(&quot;Approver Matrix&quot;, approverRoles, approverMessages, executionContext); var auditLogMessageIDs = new org.json.JSONObject(); auditLogMessageIDs.put(&quot;MessageIds&quot;, auditLogDocIds); println(&quot;###### in ApprovalDecision_NodeEnter_Execute : auditLogMessageIDs : &quot; + auditLogMessageIDs.toString()); if(auditLogMessageIDs != null) executionContext.setVariable(&quot;AuditLogMessages&quot;, auditLogMessageIDs.toString()); println(&quot;###### in ApprovalDecision_NodeEnter_Execute : Take Transition based on output&quot;); isScopeValid = approversInfo.get(&quot;isScopeValid&quot;); if (approverRoles.length() != 0) { ActorHistoryInfo.put(approverLevel, approverRoles.toString()); } println(&quot;ActorHistoryInfo put called : &quot; + ActorHistoryInfo); println(&quot;Current_Level &gt;&gt; &quot; + Current_Level); if(isScopeValid == false) { println(&quot;####################### No Scope Matched #######################&quot;); executionContext.setVariable(&quot;ApproverRoles&quot;,approverRoles.toString()); Current_Level = Max_Level; executionContext.setVariable(&quot;Approve_Level&quot;, String(Current_Level)); approvalDecisionTransition = &quot;Approval Required&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, false); break; } else { if (approverRoles.length() == 0) { println(&quot;No Approver found&quot;); executionContext.setVariable(&quot;isAutoPublish&quot;, false); continue; } else if (this.ContainsInList(approverRoles,&quot;SYSTEM Reject&quot;)) { println(&quot;####################### In ApprovalDecision_NodeEnter_Execute: SYSTEM Reject&quot;); executionContext.setVariable(&quot;ApproveMailUser&quot;, &quot;&quot;); executionContext.setVariable(&quot;ApproverRoles&quot;,&quot;&quot;); approvalDecisionTransition = &quot;Reject&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, false); break; } else if (this.ContainsInList(approverRoles,&quot;SYSTEM Approve&quot;)) { println(&quot;####################### In ApprovalDecision_NodeEnter_Execute: SYSTEM Approve&quot;); executionContext.setVariable(&quot;ApproveMailUser&quot;, &quot;&quot;); executionContext.setVariable(&quot;ApproverRoles&quot;,&quot;&quot;); approvalDecisionTransition = &quot;Approve&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, false); break; } else //conditional with approval roles { if(AutoApproveIfSameApprovers == true) { var previousRoleArray = executionContext.getVariable(&quot;ApproverRoles&quot;); if(previousRoleArray == null || previousRoleArray.equals(&quot;&quot;)) { var creatorRole = executionContext.getVariable(&quot;CurrentRole&quot;).split(&quot;,&quot;); var creatorRoleJSONArray = new JSONArray(creatorRole); previousRoleArray = creatorRoleJSONArray; } else { previousRoleArray = new JSONArray(previousRoleArray); } // If Same Approvers found if (this.checkArrayContainsAllElement(approverRoles, previousRoleArray)) { continue; } } println(&quot;####################### In ApprovalDecision_NodeEnter_Execute: Approver Found&quot;); executionContext.setVariable(&quot;ApproverRoles&quot;,approverRoles.toString()); approvalDecisionTransition = &quot;Approval Required&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, false); break; } } } } println(&quot;###### NS WF_PS_Ge ActorHistoryInfo &gt; &quot; + ActorHistoryInfo); executionContext.setVariable(&quot;ActorHistoryInfo&quot;, ActorHistoryInfo.toString()); if (Current_Level &gt; Max_Level &amp;&amp; isScopeValid == true) { println(&quot;Current_level&gt;Max_Level&quot;); executionContext.setVariable(&quot;ApproverRoles&quot;,&quot;&quot;); approvalDecisionTransition = &quot;Approve&quot;; println(&quot;\\n\\n \\n saveHistoricData Start &gt; =====================&quot; ); var historicImpactObj = new HistoricImapact(); historicImpactObj.saveHistoricData(ppdocID, docProvider, userConnInfo); println(&quot; saveHistoricData end &gt; =====================&quot; ); } executionContext.setVariable(&quot;ApprovalDecisionTransition&quot;, approvalDecisionTransition); println(&quot;END :: ApprovalDecision_NodeEnter_Execute&quot;); } this.ContainsInList=function (list, element) { for(var iCount=0;iCount&lt;list.length();iCount++) { if(list.get(iCount).toString().equals(element)) { return true; } } return false; } var messageMaxLength = 2000;// Maximum 2000 chars supported in workflow context variable var terminateChars = &quot;...&quot;; this.FormatUserMessage = function(approverMessages) { //Set approverMessagesString in executionContext println(&quot;###### in FormatUserMessage : Set approverMessagesString in executionContext&quot;); var approverMessagesString = &quot;&quot;; if (approverMessages != null &amp;&amp; approverMessages.length() &gt; 0) { for (var i = 0; i &lt; approverMessages.length(); i++) { var bullet = i+1; if (approverMessagesString == &quot;&quot;) { approverMessagesString = &quot;(&quot; + bullet + &quot;) &quot; + approverMessages.get(i); } else { approverMessagesString += &quot; (&quot; + bullet + &quot;) &quot; + approverMessages.get(i); } if (approverMessagesString.length &gt; messageMaxLength) { approverMessagesString = approverMessagesString.substr(0, messageMaxLength - terminateChars.length - 1); approverMessagesString += terminateChars; break; } } } return approverMessagesString; } /** * It is called from process definition and it executes `PendingApproval_NodeEnter_Execute * @name PendingApproval_NodeEnter * @memberof WF_NS_PS_Generic * @function * @param {object} executionContext Workflow Execution Context * @example * &lt;event type=&quot;node-enter&quot;&gt; * * &lt;action name=&quot;PendingApproval_NodeEnter&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; * &lt;javascript&gt; * &lt;!--@ WF_NS_PS_Generic.PendingApproval_NodeEnter(executionContext); @--&gt; &lt;/javascript&gt; &lt;/action&gt; */ this.PendingApproval_NodeEnter = function (executionContext) { try { var startTime = new Date(); this.PendingApproval_NodeEnter_Execute(executionContext); var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### PendingApproval_NodeEnter End : Execution Time (milliseconds) : &quot; + executionTime); } catch (error) { println(&quot;#### Error occured in PendingApproval_NodeEnter : &quot; + error); println(&quot;#### Rejecting PriceStructure&quot;); executionContext.setVariable(&quot;ApproveMailUser&quot;, &quot;&quot;); executionContext.leaveNode(&quot;Recall PricePlan&quot;); throw(error); } } /** * In here task for the approvers/delegates found in approval decision node execute are created which will show up in there My Task screen. * * This function call `WF_NS_PriceStructure_createTaskForApprovalRoles` which fetchs list of Approvers that mail has to be sent hence a context variable `ApproveMailUser` will set * with list of mail string * @name PendingApproval_NodeEnter_Execute * @memberof WF_NS_PS_Generic * @function * @param {object} executionContext Workflow Execution Context */ this.PendingApproval_NodeEnter_Execute = function (executionContext) { println(&quot;At start of function PendingApproval_NodeEnter&quot;); executionContext.setVariable(&quot;CurrentState&quot;, &quot;Pending Approval&quot;); var approverRoles = executionContext.getVariable(&quot;ApproverRoles&quot;); if(approverRoles == null) approverRoles = new org.json.JSONArray(); else approverRoles = new org.json.JSONArray(approverRoles); var MailUserString = WF_NS_PriceStructure_createTaskForApprovalRoles(approverRoles, executionContext); println(&quot;############ Mail Users String: &quot; + MailUserString); executionContext.setVariable(&quot;ApproveMailUser&quot;, MailUserString); println(&quot;###### in PendingApproval_NodeEnter_Execute : END&quot;); } /** * It is called from process definition and it executes `PendingApproval_TaskEnd_Execute` * @name PendingApproval_TaskEnd * @memberof WF_NS_PS_Generic * @function * @param {object} executionContext Workflow Execution Context * @example * &lt;event type=&quot;task-end&quot;&gt; &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.Approved_TaskEnd(executionContext); @--&gt; &lt;/javascript&gt; &lt;/action&gt; &lt;/event&gt; */ this.PendingApproval_TaskEnd = function (executionContext) { try { this.PendingApproval_TaskEnd_Execute(executionContext); } catch (error) { // executionContext.setVariable(&quot;ExecutedApprovers&quot;, &quot;&quot;); println(&quot;#### Error occured in PendingApproval_TaskEnd : &quot; + error); println(&quot;#### Rejecting PriceStructure&quot;); executionContext.leaveNode(&quot;Recall PricePlan&quot;); throw(error); } } /** * The function does the leave Node for the Price Plan from Approval Decision * * Reject - Leave Node in `Recal PricePlan` * * Approve - Leave Node in `NextApproveTask PS` * @name PendingApproval_TaskEnd_Execute * @param {object} executionContext Workflow execution context * @function * @memberof WF_NS_PS_Generic */ this.PendingApproval_TaskEnd_Execute = function (executionContext) { println(&quot;PendingApproval_TaskEnd_Execute...............&quot;); var decision = executionContext.getVariable(&quot;UserDecision&quot;); println(&quot;User decision-&quot; + decision); if (String(decision) == &quot;Reject&quot;) { // executionContext.setVariable(&quot;ExecutedApprovers&quot;, &quot;&quot;); executionContext.setVariable(&quot;ApproveMailUser&quot;, &quot;&quot;); executionContext.setVariable(&quot;ApproverRoles&quot;,&quot;&quot;); executionContext.leaveNode(&quot;Recall PricePlan&quot;); } else if (String(decision) == &quot;Approve&quot;) { var Get_Level = executionContext.getVariable(&quot;Approve_Level&quot;); var Next_Level = parseInt(Get_Level) + 1; println(&quot;Next Level: &quot; + Next_Level); executionContext.setVariable(&quot;Approve_Level&quot;, String(Next_Level)); executionContext.leaveNode(&quot;NextApproveTask PS&quot;); } } /** * Function to fetch Price Plan Document * @name GetPriceStructure * @param {object} executionContext Script execution context * @function * @memberOf WF_NS_PS_Generic */ this.GetPriceStructure = function (executionContext) { var userConnInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var options = new java.util.HashMap(); var libraryName = executionContext.getVariable(&quot;libraryName&quot;); var jsonPSDoc; var DocumentIDForPP = executionContext.getVariable(&quot;documentId&quot;); //create JSONQuery with DocumentIDForPP // docIDMap.put(&quot;Document Id&quot;, executionContext.getVariable(&quot;documentId&quot;)); // println(&quot;##########################&quot; + docIDMap.get(&quot;Document Id&quot;)); options.put(&quot;ColumnOptions&quot;, &quot;DocumentColumn&quot;); try { var finalQuery = new JSONObject(); var conditionFieldNames = new JSONArray(); var conditionType = new JSONArray(); var conditionValues = new JSONArray(); var units = new JSONArray(); conditionFieldNames.put(&quot;Document Id&quot;); conditionValues.put(DocumentIDForPP); conditionType.put(&quot;IN&quot;); var conditionalUnit = this.getUnitConditionalQuery(&quot;AND&quot;, &quot;OR&quot;, conditionFieldNames, conditionType, conditionValues); units.put(conditionalUnit); finalQuery.put(&quot;Units&quot;, units); finalQuery.put(&quot;UnitOperator&quot;, &quot;OR&quot;); var jsonQuery = finalQuery.toString(); jsonPSDoc = mergePricePlanAndDealContainerDocuments(jsonQuery, docProvider, userConnInfo).get(0); // println(&quot;GetPriceStructure jsonPSDoc: &quot; + jsonPSDoc); } catch (error) { println(&quot;Failed to fetch Price Structure for Document ID: &quot; + DocumentIDForPP); throw(error); } if (jsonPSDoc == null) { throw(&quot;Failed to fetch Price Structure for Document ID: &quot; + DocumentIDForPP); } return jsonPSDoc; } /** * It fetchs the Price Plan and constructs the object to send to BRMS to get Delegates. * The object that is formed is said 'Normalized Structure'. The Normalized Structure is build using `GWF_Normalize` * @function * @name InitializeBRMSInput * @memberof WF_NS_PS_Generic * @param {string} DefinitionType Process Definition Name * @param {object} scope Price Plan Scope * @param {object} structureObject Price Plan structured Object * @param {Boolean} isModuleConditional BRMS rule is it conditional * @param {object} additionalParams Addistion Parameters * @param {object} userConnInfo User Connection Info * @param {Boolean} isPermissionCheckOnly Is the call for permission check only */ this.InitializeBRMSInput = function (DefinitionType, scope, structureObject, isModuleConditional, additionalParams, userConnInfo, isPermissionCheckOnly) { println(&quot;START :: this.InitializeBRMSInput function&quot;); println(&quot;scope &gt;&gt; &quot; + scope); DefinitionType = &quot;PricePlan&quot;; var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); // var returnObjStr = '{&quot;DOARequest&quot; :{&quot;isApproverSet&quot; : false}}'; // var returnObjStr = '{&quot;DOARequest&quot; :{}}'; var DOARequestObj = new JSONObject(); var DOARequestArray = new JSONArray(); var returnObj = new org.json.JSONObject(); if(structureObject != null) structureObject = new org.json.JSONObject(structureObject.toString()); else structureObject = new org.json.JSONObject(); DOARequestObj.put(&quot;DefinitionType&quot;, &quot;PricePlan&quot;); DOARequestObj.put(&quot;OriginalStructure&quot;, structureObject); //AdditionalParams var addParamsItr = additionalParams.keys(); while (addParamsItr.hasNext()) { var addParamKey = addParamsItr.next(); var addParamValue = additionalParams.get(addParamKey); DOARequestObj.put(addParamKey, addParamValue); } if (!DOARequestObj.has(&quot;DelegationLevel&quot;)) DOARequestObj.put(&quot;DelegationLevel&quot;, &quot;Level1&quot;); DOARequestArray.put(DOARequestObj); //structureObject object /* var definitionTypeArray = new JSONArray(); var currentDefinitionType = new JSONObject(); currentDefinitionType.put(&quot;Module&quot;,&quot;Current Module&quot;); currentDefinitionType.put(&quot;Current Module&quot;,DefinitionType); definitionTypeArray.put(currentDefinitionType); */ if(permissionHierarchyDetail.has(DefinitionType)) { var parentModuleArray = permissionHierarchyDetail.get(DefinitionType).get(&quot;DependsOnModule&quot;); for(var iCount = 0; iCount &lt; parentModuleArray.length(); iCount++) { /* var parentDefinitionType = new JSONObject(); parentDefinitionType.put(&quot;Module&quot;,&quot;Parent Module&quot;); parentDefinitionType.put(&quot;Parent Module&quot;,parentModuleArray.get(iCount)); definitionTypeArray.put(parentDefinitionType); */ DOARequestObj = new JSONObject(); structureObject = new org.json.JSONObject(); DOARequestObj.put(&quot;DefinitionType&quot;, parentModuleArray.get(iCount)); DOARequestObj.put(&quot;OriginalStructure&quot;, structureObject); //AdditionalParams var addParamsItr = additionalParams.keys(); while (addParamsItr.hasNext()) { var addParamKey = addParamsItr.next(); var addParamValue = additionalParams.get(addParamKey); DOARequestObj.put(addParamKey, addParamValue); } if (!DOARequestObj.has(&quot;DelegationLevel&quot;)) DOARequestObj.put(&quot;DelegationLevel&quot;, &quot;Level1&quot;); DOARequestArray.put(DOARequestObj); } } // returnObj.get(&quot;DOARequest&quot;).put(&quot;DefinitionType&quot;, DefinitionType); //returnObj.get(&quot;DOARequest&quot;).put(&quot;DefinitionType&quot;, definitionTypeArray); //returnObj.get(&quot;DOARequest&quot;).put(&quot;OriginalStructure&quot;, structureObject); //println(&quot;########### structureObject in GetBRMSInputObject: &quot; + structureObject.toString()); returnObj.put(&quot;Scope&quot;, new org.json.JSONObject()); returnObj.put(&quot;DOARequest&quot;, DOARequestArray); var normalizedFacts = null; if(isModuleConditional == true) { // if(structureObject.length() != 0) // { if(typeof(NormalizeStructure_Custom) === 'function') //if condition added to support PreScripting. { normalizedFacts = NormalizeStructure_Custom(structureObject); } else { if(DefinitionType == 'PricePlan') { // println(&quot;structureObject &gt;&gt; &quot; + structureObject); normalizedFacts = GWF_Normalize(structureObject, docProvider, userConnInfo, isPermissionCheckOnly); //Normalized_StructureObject } } // } if(normalizedFacts==null) { normalizedFacts = new org.json.JSONArray(); normalizedFacts.put(new org.json.JSONObject()); } else normalizedFacts = new org.json.JSONArray(normalizedFacts); returnObj.put(&quot;NormalizedStructure&quot;, normalizedFacts); } var membersArray = getMembersFromScope(scope); returnObj.put(&quot;Member&quot;, membersArray); //println(&quot;NIR ================================== Putting NStr&quot; + returnObj); returnObj = VistaarJSUtils.newObject(returnObj.toString()); println(&quot;END :: this.InitializeBRMSInput function&quot;); return returnObj; } /** * Runs BRMS rules and get the list of Delegates for the input object * @memberof WF_NS_PS_Generic * @name GetDelegatesFromBRMS * @param {string} module Rule Name * @param {object} brmsInputObject Normalized Structure of BRMS * @param {object} userConnInfo User Connection Info */ this.GetDelegatesFromBRMS = function (module, brmsInputObject, userConnInfo) { println(&quot;###### At start of function GetDelegatesRoles&quot;); var rbName = &quot;DOA_&quot; + module + &quot;_RB&quot;; var conditional = false; var delegatesArray = new org.json.JSONArray(); var isValidScopeFlag = false; try { var BRMSConnector = VistaarJSUtils.getBRMSConnector(userConnInfo); //println(&quot;brmsInputObject : &quot;+brmsInputObject); //var fileToWrite = new File(&quot;/home/cloud_es1/nshetye/workflow/brmsInputObject.out&quot;); //var FW = new FileWriter(fileToWrite); //FW.write(brmsInputObject); //FW.close(); var result = BRMSConnector.runRules(rbName, brmsInputObject, null, null, false); println(&quot;result.EvaluationSucceeded=&quot; + result.evaluationSucceeded); if (result.evaluationSucceeded == false) { println(&quot;Error while rule evaluation:&quot; + result.errors); throw new Error(&quot;Error occured while running rule: &quot; + result.errors); } println(&quot;Rule logs are: &quot; + result.errors + &quot;\\n&quot;); } catch (error) { println(&quot;Failed to run Rule Bundle&quot;); throw(error); } var jsonResult = new org.json.JSONObject(result); var decisionInfoList = new org.json.JSONArray(); if (jsonResult != null &amp;&amp; jsonResult.get(&quot;RuleOutput&quot;) != null) { var ruleOp1 = new org.json.JSONObject(jsonResult.get(&quot;RuleOutput&quot;)); if (ruleOp1.has(&quot;DOARequest&quot;)) { var ruleOp = ruleOp1.get(&quot;DOARequest&quot;); var ruleOp = new org.json.JSONArray(ruleOp.toString()); //println(&quot;####### DEBUG ######### ruleOp1.DOARequest: &quot; + ruleOp); if (ruleOp != null &amp;&amp; ruleOp.length() &gt; 0) { for(var iCount = 0; iCount &lt; ruleOp.length(); iCount++) { var ruleOpTemp = ruleOp.get(iCount); if (ruleOpTemp.has(&quot;Delegates&quot;)) { if(delegatesArray.length() &lt;= 0) delegatesArray = ruleOpTemp.get(&quot;Delegates&quot;); else { for(var jCount = 0; jCount &lt; ruleOpTemp.get(&quot;Delegates&quot;).length(); jCount++) { delegatesArray.put(ruleOpTemp.get(&quot;Delegates&quot;).get(jCount)); } } } if (ruleOpTemp.has(&quot;isScopeValid&quot;)) { if( isValidScopeFlag == true || ruleOpTemp.get(&quot;isScopeValid&quot;) == true) isValidScopeFlag = true; else isValidScopeFlag = false; } if (ruleOpTemp.has(&quot;DecisionInfoList&quot;)) { if(decisionInfoList.length() &lt;= 0) decisionInfoList = ruleOpTemp.get(&quot;DecisionInfoList&quot;); else { for(var jCount = 0; jCount &lt; ruleOpTemp.get(&quot;DecisionInfoList&quot;).length(); jCount++) { decisionInfoList.put(ruleOpTemp.get(&quot;DecisionInfoList&quot;).get(jCount)); } } } } } } } else { throw(&quot;Failed to get BRMS output for structureObject&quot;); } var returnObj = new org.json.JSONObject(); if (delegatesArray) returnObj.put(&quot;Delegates&quot;, delegatesArray); if (decisionInfoList) returnObj.put(&quot;DecisionInfoList&quot;, decisionInfoList); returnObj.put(&quot;isScopeValid&quot;, isValidScopeFlag); if(typeof(ProcessDOAOutput_Custom) === 'function') //if condition added to support PostScripting. { returnObj = ProcessDOAOutput_Custom(returnObj); } //println(&quot;########### returnObj in GetDelegatesRoles: &quot; + returnObj.toString()); return returnObj; } this.AddAuditLog = function (module, delegatesRoleNames, delegatesRoleMessages, executionContext) { println(&quot;#############################At start of function AddAuditLog&quot;); var userConnInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var options = new java.util.HashMap(); var libraryName = &quot;AuditLog&quot;; if (delegatesRoleNames == null) delegatesRoleNames = new org.json.JSONArray(); else delegatesRoleNames = new org.json.JSONArray(delegatesRoleNames.toString()); if (delegatesRoleMessages == null) delegatesRoleMessages = new org.json.JSONArray(); else delegatesRoleMessages = new org.json.JSONArray(delegatesRoleMessages.toString()); var auditLogDocIds = new org.json.JSONArray(); var messagesSizeLimited = new org.json.JSONArray(); for (var i = 0; i &lt; delegatesRoleMessages.length(); i++) { var messagesSizeLimitedPrev = new org.json.JSONArray(messagesSizeLimited.toString()); messagesSizeLimited.put(delegatesRoleMessages.get(i)); if (messagesSizeLimited.toString().length() &gt; messageMaxLength) { messagesSizeLimited = messagesSizeLimitedPrev; break; } } try { var dateTime = new Date(); var jsonDataDoc = new org.json.JSONObject(); jsonDataDoc.put(&quot;TimeStamp&quot;, dateTime.toUTCString() + &quot; (&quot; + dateTime.getTime() + &quot;)&quot;); jsonDataDoc.put(&quot;Module&quot;, module); jsonDataDoc.put(&quot;Role&quot;, delegatesRoleNames); jsonDataDoc.put(&quot;PSDocId&quot;, executionContext.getVariable(&quot;documentId&quot;) + &quot;&quot;); jsonDataDoc.put(&quot;Message&quot;, messagesSizeLimited); var responseDoc = docProvider.createDoc(libraryName, jsonDataDoc.toString(), userConnInfo, options); if(responseDoc != null) { responseDoc = new org.json.JSONObject(responseDoc); auditLogDocIds.put(responseDoc.get(&quot;System Fields&quot;).get(&quot;Document Id&quot;)); } println(&quot;####################### In AddAuditLog : done&quot;); } catch (error) { println(&quot;###### Failed to create Audit Logs for doc id: &quot; + error); throw(error); } return auditLogDocIds; } /** * It is called from process definition and it set email notifiers list in workflow execution context * @param {object} executionContext Workflow execution context * @memberof WF_NS_PS_Generic * @name PublishDecision_NodeEnter_FetchNotifiers * @function * @example * &lt;decision name=&quot;Publish Decision&quot; expression=&quot;#{PublishDecisionTransition}&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.PublishDecision_NodeEnter_FetchNotifiers(executionContext); @--&gt; &lt;/javascript&gt; &lt;/action&gt; */ this.PublishDecision_NodeEnter_FetchNotifiers = function (executionContext) { var NotifierString = WF_NS_PriceStructure_getNotificationUserString(executionContext); NotifierString = &quot;&quot;; executionContext.setVariable(&quot;NotifyMailUserApproved&quot;,NotifierString); } /** * It is called from process defintion and it executes `PublishDecision_NodeEnter_Execute' * @param {object} executionContext Workflow execution context * @memberof WF_NS_PS_Generic * @function * @name PublishDecision_NodeEnter * @example * &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.PublishDecision_NodeEnter(executionContext); @--&gt; &lt;/javascript&gt; &lt;/action&gt; */ this.PublishDecision_NodeEnter = function (executionContext) { //try //{ var startTime = new Date(); this.PublishDecision_NodeEnter_Execute(executionContext); var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### PublishDecision_NodeEnter End : Execution Time (milliseconds) : &quot; + executionTime); /*} catch (error) { println(&quot;#### Error occured in PublishDecision_NodeEnter : &quot; + error); println(&quot;#### Rejecting PriceStructure&quot;); executionContext.setVariable(&quot;ApproveMailUser&quot;, &quot;&quot;); executionContext.leaveNode(&quot;Reject&quot;); throw(error); }*/ } /** * In here based on Decision and Parameter the next transtion is done * * isAuto Publish and Publish Decsion - Publish the Price Plan * * not is Auto Publish and Delegates pres - Price Plan in approved state, Publisher required * @param {object} executionContext Workflow Execution Context * @name PublishDecision_NodeEnter_Execute * @memberof WF_NS_PS_Generic * @function */ this.PublishDecision_NodeEnter_Execute = function(executionContext) { //Place Transition name in publisherDecisionTransition //Setting default to Reject var publisherDecisionTransition = &quot;Reject&quot;; var module = &quot;PublisherMatrix&quot;; println(&quot;#### PublishDecision_NodeEnter_Execute Start&quot;); executionContext.setVariable(&quot;CurrentState&quot;, &quot;Publish Decision&quot;); var userDecision = executionContext.getVariable(&quot;UserDecision&quot;); if (userDecision == null) userDecision = &quot;&quot;; var IsNonPostingMarket = executionContext.getVariable(&quot;IsNonPostingMarket&quot;); var IsFuturePlanning = executionContext.getVariable(&quot;IsFuturePlanning&quot;); println(&quot;IsNonPostingMarket &gt;&gt; &quot; + IsNonPostingMarket + &quot; / IsFuturePlanning &gt;&gt; &quot; + IsFuturePlanning); var userConnInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var isScopeValid = true; //================================================================ //Get Approver Roles from BRMS and set executionContext variables - START //================================================================ //Get Price Structure Doc var priceStructureDoc = this.GetPriceStructure(executionContext); var additionalParams = new org.json.JSONObject(); //Get BRMS Input Object var definitionType = &quot;PricePlan&quot;; var scope = executionContext.getVariable(&quot;Scope&quot;); var scopeJSONObj = new org.json.JSONObject(scope); var docProvider = getJBPMConfigObject(VAR_DOCPROVIDER); var permissionAdapter = new PermissionMtxAdapter_Intf(); permissionAdapter.Init(docProvider, userConnInfo); var publisherInfo = permissionAdapter.getPublisher(definitionType, scopeJSONObj, priceStructureDoc, PublisherMatrixConditional); var publisherRoles; if (publisherInfo.has(&quot;Delegates&quot;)) { publisherRoles = publisherInfo.get(&quot;Delegates&quot;); publisherRoles = new org.json.JSONArray(publisherRoles.toString()); } else publisherRoles = new org.json.JSONArray(); //Get publisherMessages from publisherInfo var publisherMessages; if (publisherInfo.has(&quot;Messages&quot;)) { publisherMessages = publisherInfo.get(&quot;Messages&quot;); publisherMessages = new org.json.JSONArray(publisherMessages.toString()); } else publisherMessages = new org.json.JSONArray(); println(&quot;###### in PublishDecision_NodeEnter_Execute : PublisherRoles : &quot; + publisherRoles.toString()); println(&quot;###### in PublishDecision_NodeEnter_Execute : publisherMessages : &quot; + publisherMessages.toString()); var publisherMessagesString = this.FormatUserMessage(publisherMessages); if(publisherMessagesString!=null) executionContext.setVariable(&quot;PublisherRoleMessagesString&quot;, publisherMessagesString.toString()); //Add audit logs println(&quot;###### in PublishDecision_NodeEnter_Execute : Add audit logs&quot;); var auditLogDocIds = this.AddAuditLog(&quot;Publisher Matrix&quot;, publisherRoles, publisherMessages, executionContext); var auditLogMessageIDs = new org.json.JSONObject(); auditLogMessageIDs.put(&quot;MessageIds&quot;, auditLogDocIds); println(&quot;###### in PublishDecision_NodeEnter_Execute : auditLogMessageIDs : &quot; + auditLogMessageIDs.toString()); if(auditLogMessageIDs != null) executionContext.setVariable(&quot;AuditLogMessages&quot;, auditLogMessageIDs.toString()); println(&quot;###### in PublishDecision_NodeEnter_Execute : Take Transition based on output&quot;); isScopeValid = publisherInfo.get(&quot;isScopeValid&quot;); if(IsNonPostingMarket == 1 || IsFuturePlanning == 1){ println(&quot;####################### In PublishDecision_NodeEnter_Execute:IsNonPostingMarket 1 SYSTEM Publish&quot;); g_checkLockDocument(executionContext); executionContext.setVariable(&quot;PublishMailUser&quot;, &quot;&quot;); //do remaining executionContext.setVariable(&quot;PublisherRoles&quot;,&quot;&quot;); publisherDecisionTransition = &quot;Publish&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, true); }else{ if(isScopeValid == false) { println(&quot;####################### No Scope Matched #######################&quot;); executionContext.setVariable(&quot;PublisherRoles&quot;,publisherRoles.toString()); publisherDecisionTransition = &quot;Publish Required&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, false); } else { if (publisherRoles.length() == 0) { println(&quot;No Publisher found&quot;); executionContext.setVariable(&quot;PublishMailUser&quot;, &quot;&quot;); publisherDecisionTransition = &quot;Publish&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, false); } else if (this.ContainsInList(publisherRoles,&quot;SYSTEM Reject&quot;)) { println(&quot;####################### In PublishDecision_NodeEnter_Execute: SYSTEM Reject&quot;); executionContext.setVariable(&quot;PublishMailUser&quot;, &quot;&quot;); executionContext.setVariable(&quot;PublisherRoles&quot;,&quot;&quot;); publisherDecisionTransition = &quot;Reject&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, false); } else if (this.ContainsInList(publisherRoles,&quot;SYSTEM Publish&quot;)) { println(&quot;####################### In PublishDecision_NodeEnter_Execute: SYSTEM Publish&quot;); g_checkLockDocument(executionContext); executionContext.setVariable(&quot;PublishMailUser&quot;, &quot;&quot;); //do remaining executionContext.setVariable(&quot;PublisherRoles&quot;,&quot;&quot;); publisherDecisionTransition = &quot;Publish&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, false); } else //conditional with approval roles { println(&quot;####################### In PublishDecision_NodeEnter_Execute: Publisher Found&quot;); executionContext.setVariable(&quot;PublisherRoles&quot;,publisherRoles.toString()); publisherDecisionTransition = &quot;Publish Required&quot;; executionContext.setVariable(&quot;isAutoPublish&quot;, false); } } } executionContext.setVariable(&quot;PublishDecisionTransition&quot;, publisherDecisionTransition); println(&quot;###### in PublishDecision_NodeEnter_Execute : END&quot;); } /** * Run from process defintion and executes `Approved_NodeEnter_Execute` * @memberof WF_NS_PS_Generic * @function * @name Approved_NodeEnter * @param {object} executionContext Workflow Execution Context * @example * &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;Approved_NodeEnter&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.Approved_NodeEnter(executionContext); @--&gt; &lt;/javascript&gt; &lt;/action&gt; */ this.Approved_NodeEnter = function (executionContext) { try { var startTime = new Date(); this.Approved_NodeEnter_Execute(executionContext); var endTime = new Date(); var executionTime = endTime - startTime; println(&quot;#### Approved_NodeEnter End : Execution Time (milliseconds) : &quot; + executionTime); } catch (error) { println(&quot;#### Error occured in Approved_NodeEnter : &quot; + error); println(&quot;#### Rejecting PriceStructure&quot;); executionContext.setVariable(&quot;PublishMailUser&quot;, &quot;&quot;); executionContext.leaveNode(&quot;Recall PricePlan&quot;); throw(error); } } /** * Creates task for the delegates of the Approved Decision Node * @memberOf WF_NS_PS_Generic * @name Approved_NodeEnter_Execute * @function * @param {object} executionContext Workflow Execution Context */ this.Approved_NodeEnter_Execute = function (executionContext) { println(&quot;At start of function Approved_NodeEnter_Execute&quot;); executionContext.setVariable(&quot;CurrentState&quot;, &quot;Approved&quot;); var publisherRoles = executionContext.getVariable(&quot;PublisherRoles&quot;); if(publisherRoles == null) publisherRoles = new org.json.JSONArray(); else publisherRoles = new org.json.JSONArray(publisherRoles); var MailUserString = WF_NS_PriceStructure_createTaskForPublisher(publisherRoles, executionContext); println(&quot;############ Mail Users String: &quot; + MailUserString); executionContext.setVariable(&quot;PublishMailUser&quot;, MailUserString); println(&quot;###### in Approved_NodeEnter_Execute : END&quot;); } /** * Run from process definition and executes `Approved_TaskEnd_Execute` * @memberof WF_NS_PS_Generic * @function * @name Approved_TaskEnd * @param {object} executionContext Workflow execution context * @example * &lt;event type=&quot;task-end&quot;&gt; &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.Approved_TaskEnd(executionContext); @--&gt; &lt;/javascript&gt; &lt;/action&gt; */ this.Approved_TaskEnd = function (executionContext) { //try //{ this.Approved_TaskEnd_Execute(executionContext); /*} catch (error) { println(&quot;#### Error occured in Approved_TaskEnd : &quot; + error); println(&quot;#### Rejecting PriceStructure&quot;); executionContext.leaveNode(&quot;Recall PricePlan&quot;); throw(error); }*/ } /** * Leave Node from Approved Plan * * Reject - Leave as Recall Price Plan * * Publish - Leave as Publish * @memberof WF_NS_PS_Generic * @function * @name Approved_TaskEnd_Execute * @param {object} executionContext Workflow execution context */ this.Approved_TaskEnd_Execute = function (executionContext) { println(&quot;Approved_TaskEnd_Execute&quot;); var decision = executionContext.getVariable(&quot;UserDecision&quot;); println(&quot;User decision-&quot; + decision); if (String(decision) == &quot;Reject&quot;) { executionContext.setVariable(&quot;PublishMailUser&quot;, &quot;&quot;); executionContext.setVariable(&quot;PublisherRoles&quot;,&quot;&quot;); executionContext.leaveNode(&quot;Recall PricePlan&quot;); } else if (String(decision) == &quot;Publish&quot;) //Verify { g_checkLockDocument(executionContext); executionContext.leaveNode(&quot;Publish&quot;); } } /** * External API to run BRMSrule other the workflow * @memberof WF_NS_PS_Generic * @function * @name GetRolesFromBRMS_ExternalInterface * @param {string} module Rule bundle Name * @param {string} definitionType Process Defintion Name * @param {object} scope Price Plan Scope * @param {object} structureObject Normalized Price Plan Structure * @param {object} additionalParams Additional parameter * @param {object} userConnInfo User Connection Info */ this.GetRolesFromBRMS_ExternalInterface = function (module, definitionType, scope, structureObject, additionalParams, userConnInfo) { println(&quot;######## GetRolesFromBRMS_ExternalInterface : Start&quot;); var matrixConditional = false; if(module.equals(&quot;ApproverMatrix&quot;)) matrixConditional = true; else if(module.equals(&quot;PublisherMatrix&quot;)) matrixConditional = true; println(&quot;CAlling from GetRolesFromBRMS_ExternalInterface&quot;); var brmsInputObject = this.InitializeBRMSInput(definitionType, scope, structureObject, matrixConditional, additionalParams, userConnInfo, isPermissionCheckOnly); //Get roles info from BRMS var brmsOutputObject = this.GetDelegatesFromBRMS(module, brmsInputObject, userConnInfo); //Get Roles and Messages from brmsOutputObject. var roles; if (brmsOutputObject.has(&quot;Delegates&quot;)) { roles = brmsOutputObject.get(&quot;Delegates&quot;); roles = new org.json.JSONArray(roles.toString()); } else roles = new org.json.JSONArray(); var messages; if (brmsOutputObject.has(&quot;Messages&quot;)) { messages = brmsOutputObject.get(&quot;Messages&quot;); messages = new org.json.JSONArray(messages.toString()); } else messages = new org.json.JSONArray(); var ruleOp = new org.json.JSONObject(); ruleOp.put(&quot;Roles&quot;, roles); ruleOp.put(&quot;Messages&quot;, messages); return ruleOp; } this.checkArrayContainsAllElement = function(array1, array2) { for(var iCount = 0; iCount &lt; array1.length(); iCount++) { if(!this.ContainsInList(array2, array1.get(iCount))) { return false; } } return true; } this.getUnitConditionalQuery = function(conditionOperator, unitOperator, conditionFieldNames, conditionType, conditionValues) { var condition = new JSONObject(); condition.put(&quot;ConditionOperator&quot;, conditionOperator); condition.put(&quot;UnitOperator&quot;, unitOperator); var conditionArray = this.constructConditionArray(conditionFieldNames, conditionType, conditionValues); condition.put(&quot;Condition&quot;, conditionArray); return condition; } //Construct JSON Conditional Array this.constructConditionArray = function(conditionFieldNames, conditionType, conditionValues) { var finalConditionArray = new JSONArray(); for (var i = 0; i &lt; conditionFieldNames.length(); i++) { var condition = new JSONObject(); condition.put(&quot;FieldName&quot;, conditionFieldNames.get(i)); condition.put(&quot;ConditionType&quot;, conditionType.get(i)); var Value = new JSONObject(); Value.put(&quot;Type&quot;, &quot;text&quot;); Value.put(&quot;Content&quot;, conditionValues.get(i)); condition.put(&quot;Value&quot;, Value); finalConditionArray.put(condition); } return finalConditionArray; } } var WF_NS_PS_Generic = new WF_NS_PS_Generic(); × Search results Close "},"Workflow.js.html":{"id":"Workflow.js.html","title":"Source: Workflow.js","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Source: Workflow.js /** * @namespace Workflow * @see {@link WF_NS_PS_Generic} * @see {@link module:WF_NS_PriceStructure} * @see {@link module:WF_Execution} * @see {@link module:GWF_Normalize} */ × Search results Close "},"modules.list.html":{"id":"modules.list.html","title":"Modules","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Modules Classes ExportPricePlan PricePlanBestPracticesManager PricePlanFinderManager WF_NS_PS_Generic Namespaces WebUI Workflow × Search results Close "},"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Classes Classes ExportPricePlan PricePlanBestPracticesManager PricePlanFinderManager WF_NS_PS_Generic Namespaces WebUI Workflow × Search results Close "},"namespaces.list.html":{"id":"namespaces.list.html","title":"Namespaces","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Namespaces Classes ExportPricePlan PricePlanBestPracticesManager PricePlanFinderManager WF_NS_PS_Generic Namespaces WebUI Workflow × Search results Close "},"index.html":{"id":"index.html","title":"Index","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Index ApproverMatrix.js This files contain Approver Matrix functions for BRMS Approver deployment Version: 1.0.0 Author: anadar Source: ApproverMatrix.js, line 1 Index CreatorMatrix.js This files contain Creator Matrix functions for BRMS Creator deployment Version: 1.0.0 Author: anadar Source: CreatorMatrix.js, line 2 Index ExportPricePlan.js This files contain module Export Price Plan to export Price Plan in pdf and Excel Format. It fetches Price Plan using scope data from the UI and then builds report using Jasper report and returns to the UI Version: 1.0.0 Author: anadar Source: ExportPricePlan.js, line 7 Index WF_Execution.js This files contain function related to Workflow Exection/Transition It updates the Price Plan with persistent variables information needed during the Transition. Version: 1.0.0 Author: anadar Source: WF_Execution.js, line 1 Index WF_NS_PriceStructure.js This files contain Workflow Task and Notification assignment Script Version: 1.0.0 Author: anadar Source: WF_NS_PriceStructure.js, line 10 Index WF_NS_PS_Generic.js Generic Functions for Workflow Process definition inline scripts Version: 1.0.0 Author: anadar Source: WF_NS_PS_Generic.js, line 8 × Search results Close "},"ExportPricePlan.html":{"id":"ExportPricePlan.html","title":"Class: ExportPricePlan","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Class: ExportPricePlan ExportPricePlan new ExportPricePlan() Source: ExportPricePlan.js, line 34 Members &lt;inner&gt; m_docServerManager :object Type: object Source: ExportPricePlan.js, line 41 &lt;inner&gt; m_exportConfig :object Type: object Source: ExportPricePlan.js, line 39 &lt;inner&gt; m_exportData :object Type: object Source: ExportPricePlan.js, line 43 &lt;inner&gt; m_pricePlan :object Type: object Source: ExportPricePlan.js, line 40 &lt;inner&gt; m_scopeData :object Type: object Source: ExportPricePlan.js, line 38 &lt;inner&gt; m_userConnInfo :object Type: object Source: ExportPricePlan.js, line 42 Methods BuildObjectForReport() Thde data that has been fetch with fetchPrice Plan is formatted in this function Source: ExportPricePlan.js, line 140 BuildReport(pValue) It builds report by fetching CSV data and the jasper files Parameters: Name Type Description pValue object Json object of the report data Source: ExportPricePlan.js, line 298 Example var returnByteArrayPDF = jasperReportUtilObj.exportBinaryArrayOneReport(exportType,compiledReportNamePath,reportJsonData,reportParameters); BuildReportDataFromUI(p_inputContext) The data from front is converted to Report in this function Parameters: Name Type Description p_inputContext Object Input Constext from the front end Source: ExportPricePlan.js, line 239 fetchPricePlan() To fetch Price Plan data using the scope Source: ExportPricePlan.js, line 89 getCSVData(dataNode) Converts Json to CSV Parameters: Name Type Description dataNode object JSON object to convert Source: ExportPricePlan.js, line 338 Returns: Converted CSV data Type string getReport(p_inputContext) It returns the final report to the Front End Parameters: Name Type Description p_inputContext object Input Context Source: ExportPricePlan.js, line 72 Returns: Report either excel/pdf Type object initModule(p_inputContext) InitModule Parameters: Name Type Description p_inputContext object The input Context to init the Export Price Plan this contains 'Scope Data', 'Export Config', 'Export Type', 'DocServer' and 'UserInfo' Source: ExportPricePlan.js, line 53 × Search results Close "},"module-ApproverMatrix.html":{"id":"module-ApproverMatrix.html","title":"Module: ApproverMatrix","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Module: ApproverMatrix Source: ApproverMatrix.js, line 8 × Search results Close "},"module-CreatorMatrix.html":{"id":"module-CreatorMatrix.html","title":"Module: CreatorMatrix","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Module: CreatorMatrix Source: CreatorMatrix.js, line 8 × Search results Close "},"module-GWF_Normalize.html":{"id":"module-GWF_Normalize.html","title":"Module: GWF_Normalize","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Module: GWF_Normalize Source: GWF_Normalize.js, line 6 Methods &lt;static&gt; GWF_Normalize(structureObject, docProvider, userConnInfo, isPermissionCheckOnly) GWF_Normalize function to convert the Price Plan document to Normalized structure that will be inputed to BRMS Parameters: Name Type Description structureObject object Price Plan structured object docProvider object Document Provider userConnInfo object User connection info isPermissionCheckOnly Boolean Price Plan Permission check Source: GWF_Normalize.js, line 19 × Search results Close "},"module-WF_Execution.html":{"id":"module-WF_Execution.html","title":"Module: WF_Execution","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Module: WF_Execution WF_Execution holds function for perform Workflow transition. Source: WF_Execution.js, line 9 Requires module:WF_NS_PriceStructure Methods &lt;static&gt; performWorkFlowTransitions(documentId, scope, priceplanSystemFileds, wfConnectionObj, docServerManager, userConnInfo, wfTransition, extraAttributes, bAutoPublish) Perform Workflow Transtion of Price Plan whose documet Id is passed The list of persistent parameter that are added to the Price Plan Comments Product Name Geography Name Region Name Geography Code Product Code URL Region Code Brand Code HTML Comments What The current Workflow Status of plan is checked and based on the status the parameters are put and api // executeScript docServerManager.executeScript(&quot;ExecuteWorkflowTask&quot;, paramName, paramValue, userConnInfo); is called and the workflow transtion is performed. Parameters: Name Type Description documentId string Price Plan Document Id in string scope object Scope of the Price Plan priceplanSystemFileds object Price Plan System Fields wfConnectionObj object Vistaar Workflow Connection Object docServerManager object Docment Server Managers userConnInfo object User Connection Info wfTransition string Next workflow Transtion extraAttributes object Persistent Parameter List bAutoPublish boolean Auto PUblish boolean Source: WF_Execution.js, line 215 &lt;static&gt; WF_Execution(inputContext, docServerManager, userConnInfo, bAutoPublish) This is the main function which sets up persistent parameter and performs the Workflow Transtion of the Price Plan from UI Parameters: Name Type Description inputContext object Workflow input Context docServerManager object Entity Doc ServerManager userConnInfo object User Connection Info bAutoPublish object Boolean auto publish Source: WF_Execution.js, line 19 × Search results Close "},"module-WF_NS_PriceStructure.html":{"id":"module-WF_NS_PriceStructure.html","title":"Module: WF_NS_PriceStructure","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Module: WF_NS_PriceStructure Source: WF_NS_PriceStructure.js, line 16 Requires module:WF_NS_PS_Generic Methods &lt;static&gt; WF_NS_PriceStructure_createTaskForApprovalRoles(executionContext) It is called from WF_NS_PS_Generic.PendingApproval_NodeEnter_Execute it creates Task for all the Delegates withapproval permission on the Price Plan Parameters: Name Type Description executionContext Object Workflow Execution Context Source: WF_NS_PriceStructure.js, line 559 &lt;static&gt; WF_NS_PriceStructure_createTaskForPublisher(executionContext) It is called from WF_NS_PS_Generic.Approved_NodeEnter_Execute it creates Task for all the Delegates withapproval permission on the Price Plan Parameters: Name Type Description executionContext Object Workflow Execution Context Source: WF_NS_PriceStructure.js, line 642 &lt;static&gt; WF_NS_PriceStructure_getMaxSequence(executionContext) Runs from process definition is used to get the Max Approval Level of the Price Plan which is stored in the entity Parameters: Name Type Description executionContext Object Workflow Execution Context Source: WF_NS_PriceStructure.js, line 23 Example &lt;action name=&quot;executeStartTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ println(&quot;# Inside node enter of Start!!&quot;); var LogUserInfo = executionContext.getContextInstance().getTransientVariable(&quot;UserConnectionInfo&quot;); var LogUserName = LogUserInfo.getUserName(); var LogUserRole = LogUserInfo.roleName; println(&quot;# Price structure Created by -: &quot;+LogUserName+&quot; / Role &quot; + LogUserRole); executionContext.setVariable(&quot;PS_Creator&quot;,LogUserName); executionContext.setVariable(&quot;PS_CreatorRole&quot;,LogUserRole); executionContext.setVariable(&quot;isAutoPublish&quot;, true); var TotalApprovalLevel = WF_NS_PriceStructure_getMaxSequence(executionContext); println(&quot;# Total number of approval level -: &quot; + TotalApprovalLevel); executionContext.setVariable(&quot;MaxApproval&quot;,TotalApprovalLevel); //var requiredFieldsArray = createTemplatePSAttributeList(); putTemplateRequiredInfoFromReportInExecutionContext(&quot;PricePlanView&quot;,executionContext); &lt;static&gt; WF_NS_PriceStructure_getNotificationUserString(executionContext) Runs from process definition Parameters: Name Type Description executionContext Object Workflow Execution Context Source: WF_NS_PriceStructure.js, line 718 Example &lt;state name=&quot;Published&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;setPublisherRoles_PS&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Published&quot;); var NotifierString = WF_NS_PriceStructure_getNotificationUserString(executionContext); println(&quot;Notifier User String : &quot; + NotifierString); executionContext.setVariable(&quot;NotifyMailUser&quot;,NotifierString); &lt;static&gt; WF_NS_PriceStructure_getRecallRole(executionContext) Runs from process definition Parameters: Name Type Description executionContext Object Workflow Execution Context Source: WF_NS_PriceStructure.js, line 403 Example &lt;node name=&quot;Rejected&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;setMailUsers&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ var isRejectFlg = executionContext.getVariable(&quot;isRejectFlg&quot;); if(isRejectFlg == true){ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Rejected&quot;); var MailUserString = WF_NS_PriceStructure_getRejectRole(executionContext); println(&quot;#### Rejected Node - Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;RejectMailUser&quot;,MailUserString); executionContext.setVariable(&quot;RejectSubject&quot;,&quot;Rejected&quot;); println(&quot;#### Rejected Node javascript end&quot;); }else{ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Recall&quot;); var MailUserString = WF_NS_PriceStructure_getRecallRole(executionContext); println(&quot;#### Recall Node - Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;RejectMailUser&quot;,MailUserString); executionContext.setVariable(&quot;RejectSubject&quot;,&quot;Recalled&quot;); println(&quot;#### Recall Node javascript end&quot;); } &lt;static&gt; WF_NS_PriceStructure_getRejectRole(executionContext) Runs from process definition Parameters: Name Type Description executionContext Object Workflow Execution Context Source: WF_NS_PriceStructure.js, line 202 Example &lt;node name=&quot;Rejected&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;setMailUsers&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ var isRejectFlg = executionContext.getVariable(&quot;isRejectFlg&quot;); if(isRejectFlg == true){ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Rejected&quot;); var MailUserString = WF_NS_PriceStructure_getRejectRole(executionContext); println(&quot;#### Rejected Node - Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;RejectMailUser&quot;,MailUserString); executionContext.setVariable(&quot;RejectSubject&quot;,&quot;Rejected&quot;); println(&quot;#### Rejected Node javascript end&quot;); }else{ executionContext.setVariable(&quot;CurrentState&quot;,&quot;Recall&quot;); var MailUserString = WF_NS_PriceStructure_getRecallRole(executionContext); println(&quot;#### Recall Node - Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;RejectMailUser&quot;,MailUserString); executionContext.setVariable(&quot;RejectSubject&quot;,&quot;Recalled&quot;); println(&quot;#### Recall Node javascript end&quot;); } &lt;static&gt; WF_NS_PriceStructure_getSubmitRole(executionContext) It is called from WF_NS_PriceStructure_getSubmitRoleOnRejectionState it creates Task for all the Delegates withsubmit permission on the Price Plan Parameters: Name Type Description executionContext Object Workflow Execution Context Source: WF_NS_PriceStructure.js, line 74 &lt;static&gt; WF_NS_PriceStructure_getSubmitRoleOnRejectionState(executionContext) Runs from process definition Parameters: Name Type Description executionContext Object Workflow Execution Context Source: WF_NS_PriceStructure.js, line 148 Example &lt;task-node name=&quot;WIP&quot; create-tasks=&quot;false&quot; end-tasks=&quot;true&quot;&gt; &lt;task name=&quot;Submit Task&quot;&gt; &lt;description&gt;Task for Submit the price structure&lt;/description&gt; &lt;/task&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;setSubmitterRoles_PS&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ executionContext.setVariable(&quot;CurrentState&quot;,&quot;WIP&quot;); println(&quot;Processdefinition Step 1 : Create Submit Task !!&quot;); var App_Level =1; executionContext.setVariable(&quot;Approve_Level&quot;,String(App_Level)); var MailUserString = WF_NS_PriceStructure_getSubmitRoleOnRejectionState(executionContext); println(&quot;Mail Users String: &quot;+ MailUserString); executionContext.setVariable(&quot;UserDecision&quot;,&quot;&quot;); executionContext.setVariable(&quot;SubmitMailUser&quot;,MailUserString); &lt;inner&gt; g_ExecuteWorkflowOperation(systemFieldsObject, wfConnectionObj, userConnInfo) Execute Workflow Operation Parameters: Name Type Description systemFieldsObject object System Fields wfConnectionObj object Workflow Connection Object userConnInfo object User Connection Info Source: WF_NS_PriceStructure.js, line 912 × Search results Close "},"WebUI.html":{"id":"WebUI.html","title":"Namespace: WebUI","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Namespace: WebUI WebUI Source: PricePlanBestPractices.js, line 8 Classes PricePlanBestPracticesManager PricePlanFinderManager × Search results Close "},"WebUI.PricePlanBestPracticesManager.html":{"id":"WebUI.PricePlanBestPracticesManager.html","title":"Class: PricePlanBestPracticesManager","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Class: PricePlanBestPracticesManager WebUI. PricePlanBestPracticesManager new PricePlanBestPracticesManager() Source: PricePlanBestPractices.js, line 21 Members &lt;inner&gt; m_objlistPractices :Object List of Best Practices Type Best Practice Message Hardstop VolumeNot100 The % of Business must sum to 100% for each month Hardstop VolumeNotPresent Deal Line does not have volume entered for the year Hardstop DuplicateNetList Deal Lines in the same channel cannot have the same Net List in same month Hardstop WPSame WP cannot be different for the same month across Deal Lines Hardstop DASame DA cannot be different for the same month across Deal Lines Hardstop IncompletePriceLine Deal Line is missing required inputs Softstop RABNegative RAB cannot be negative Softstop ProposedNetFOBDeeeper Proposed Priceline Net FOB is deeper than current Softstop ProposedNetListDeeeper Proposed Priceline Net List is deeper than current Softstop MinNetFOBGuidance Net FOB is below guidance value Softstop MinNetListGuidance Net list is below guidance value Softstop MinRABGuidance RAB is below guidance value Softstop AvgRABGuidance Avg full Year RAB is below guidance value Softstop AvgNetFOBGuidance Avg full Year Net FOB is below guidance value Softstop AvgPYNetFOBGuidance Avg full Year Net FOB is below previous year avg full Year Net FOB Softstop NegativePerctBusiness Percentage of business is negative Softstop MinDaysToChange This is a posting market. Please make sure pricing is submitted within the posting window Softstop AvgVolumeGuidance Full year volume percent for Priceline is either below or above threshold Softstop AvgFOBDecreased Proposed Avg FOB decreased from Current Avg FOB Type: Object Source: PricePlanBestPractices.js, line 93 Methods evalBestPractice() This is function run on show of the Best Practice popup Source: PricePlanBestPractices.js, line 591 initializeModuleObjects() Intialize function of Price Plan Best Practice it does following Init m_objlistPractices object count to zero Init SKUMaster and DistributoMaster for Across Channel Best Practices Init Current Grid Mapping Source: PricePlanBestPractices.js, line 372 lookupChildForBestPractices(p_children, p_gridRow, p_Month, p_sGridName, p_guidance) Childrens in the grid consist of facts, this function loops through children to look for IncompletePriceLine ProposedNetListDeeeper MinNetListGuidance RABNegative MinRABGuidance ProposedNetFOBDeeeper MinNetFOBGuidance Parameters: Name Type Description p_children object children object from tree grid p_gridRow string Grid Row index p_Month string Month Name p_sGridName string Grid Name p_guidance object Guidance Data Source: PricePlanBestPractices.js, line 1602 Returns: FactList Type object lookupForAvgBestPractice(p_data, p_bCheckDealName, p_sGridName, p_BPGuidanceData) To Check following best Practice VolumeNotPresent AvgVolumeGuidance Parameters: Name Type Description p_data object Grid Data p_bCheckDealName boolean Check Deal Name p_sGridName string Grid Name ON/OFF p_BPGuidanceData object Guidance Data Source: PricePlanBestPractices.js, line 977 lookupGridForBestPractice(p_sGridName, p_BPGuidanceData, p_factCodeArr) The function that loops through grid data Parameters: Name Type Description p_sGridName string Grid Name ON/OFF p_BPGuidanceData object Guidance Data p_factCodeArr object Fact Code to check Source: PricePlanBestPractices.js, line 827 show(l_xPosition, l_yPostion, l_width, l_height) When user clicks on Best Practice button this function is called Parameters: Name Type Description l_xPosition number X postion l_yPostion number Y position l_width number Width l_height number Height Source: PricePlanBestPractices.js, line 317 × Search results Close "},"WebUI.PricePlanFinderManager.html":{"id":"WebUI.PricePlanFinderManager.html","title":"Class: PricePlanFinderManager","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Class: PricePlanFinderManager WebUI. PricePlanFinderManager new PricePlanFinderManager() Source: PricePlanFinderManager.js, line 2 Members &lt;static&gt; initialize This function is used to initialize the Price Plan Finder Manager Source: PricePlanFinderManager.js, line 36 &lt;static&gt; initializeAllCombos Init function for all combo box Source: PricePlanFinderManager.js, line 105 × Search results Close "},"WF_NS_PS_Generic.html":{"id":"WF_NS_PS_Generic.html","title":"Class: WF_NS_PS_Generic","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Class: WF_NS_PS_Generic WF_NS_PS_Generic new WF_NS_PS_Generic() Source: WF_NS_PS_Generic.js, line 14 Requires: module:GWF_Normalize module:BRMSConnector module:WF_NS_PriceStructure Requires module:GWF_Normalize module:BRMSConnector module:WF_NS_PriceStructure Members &lt;static&gt; GetDelegatesFromBRMS Runs BRMS rules and get the list of Delegates for the input object Source: WF_NS_PS_Generic.js, line 683 Methods &lt;static&gt; ApprovalDecision_NodeEnter(executionContext) It is called from process definition and it executes ApprovalDecision_NodeEnter_Execute function Parameters: Name Type Description executionContext object Workflow Execution Context Source: WF_NS_PS_Generic.js, line 23 Example &lt;super-state name=&quot;super-state1&quot;&gt; &lt;decision name=&quot;Approval Decision&quot; expression=&quot;#{ApprovalDecisionTransition}&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.ApprovalDecision_NodeEnter(executionContext); &lt;static&gt; ApprovalDecision_NodeEnter_Execute(executionContext) This where approval decesion starts following things are done here Check if its Future Planning if it is then auto publish the plan Check the current Level of the Price Plan Look up Delegates for the the current Level of the Price Plan If there are Delegates do a transition to Pending Approval If thera are no Delegates do a transition to Approved/Published based on Posting Market Information Parameters: Name Type Description executionContext object Workflow Execution Context Source: WF_NS_PS_Generic.js, line 67 &lt;static&gt; Approved_NodeEnter(executionContext) Run from process defintion and executes Approved_NodeEnter_Execute Parameters: Name Type Description executionContext object Workflow Execution Context Source: WF_NS_PS_Generic.js, line 1063 Example &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;Approved_NodeEnter&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.Approved_NodeEnter(executionContext); &lt;static&gt; Approved_NodeEnter_Execute(executionContext) Creates task for the delegates of the Approved Decision Node Parameters: Name Type Description executionContext object Workflow Execution Context Source: WF_NS_PS_Generic.js, line 1101 &lt;static&gt; Approved_TaskEnd(executionContext) Run from process definition and executes Approved_TaskEnd_Execute Parameters: Name Type Description executionContext object Workflow execution context Source: WF_NS_PS_Generic.js, line 1126 Example &lt;event type=&quot;task-end&quot;&gt; &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.Approved_TaskEnd(executionContext); &lt;static&gt; Approved_TaskEnd_Execute(executionContext) Leave Node from Approved Plan Reject - Leave as Recall Price Plan Publish - Leave as Publish Parameters: Name Type Description executionContext object Workflow execution context Source: WF_NS_PS_Generic.js, line 1157 &lt;static&gt; GetPriceStructure(executionContext) Function to fetch Price Plan Document Parameters: Name Type Description executionContext object Script execution context Source: WF_NS_PS_Generic.js, line 491 &lt;static&gt; GetRolesFromBRMS_ExternalInterface(module, definitionType, scope, structureObject, additionalParams, userConnInfo) External API to run BRMSrule other the workflow Parameters: Name Type Description module string Rule bundle Name definitionType string Process Defintion Name scope object Price Plan Scope structureObject object Normalized Price Plan Structure additionalParams object Additional parameter userConnInfo object User Connection Info Source: WF_NS_PS_Generic.js, line 1185 &lt;static&gt; InitializeBRMSInput(DefinitionType, scope, structureObject, isModuleConditional, additionalParams, userConnInfo, isPermissionCheckOnly) It fetchs the Price Plan and constructs the object to send to BRMS to get Delegates. The object that is formed is said 'Normalized Structure'. The Normalized Structure is build using GWF_Normalize Parameters: Name Type Description DefinitionType string Process Definition Name scope object Price Plan Scope structureObject object Price Plan structured Object isModuleConditional Boolean BRMS rule is it conditional additionalParams object Addistion Parameters userConnInfo object User Connection Info isPermissionCheckOnly Boolean Is the call for permission check only Source: WF_NS_PS_Generic.js, line 546 &lt;static&gt; PendingApproval_NodeEnter(executionContext) It is called from process definition and it executes `PendingApproval_NodeEnter_Execute Parameters: Name Type Description executionContext object Workflow Execution Context Source: WF_NS_PS_Generic.js, line 361 Example &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;PendingApproval_NodeEnter&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.PendingApproval_NodeEnter(executionContext); &lt;static&gt; PendingApproval_NodeEnter_Execute(executionContext) In here task for the approvers/delegates found in approval decision node execute are created which will show up in there My Task screen. This function call WF_NS_PriceStructure_createTaskForApprovalRoles which fetchs list of Approvers that mail has to be sent hence a context variable ApproveMailUser will set with list of mail string Parameters: Name Type Description executionContext object Workflow Execution Context Source: WF_NS_PS_Generic.js, line 400 &lt;static&gt; PendingApproval_TaskEnd(executionContext) It is called from process definition and it executes PendingApproval_TaskEnd_Execute Parameters: Name Type Description executionContext object Workflow Execution Context Source: WF_NS_PS_Generic.js, line 428 Example &lt;event type=&quot;task-end&quot;&gt; &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.Approved_TaskEnd(executionContext); &lt;static&gt; PendingApproval_TaskEnd_Execute(executionContext) The function does the leave Node for the Price Plan from Approval Decision * Reject - Leave Node in `Recal PricePlan` * Approve - Leave Node in `NextApproveTask PS` Parameters: Name Type Description executionContext object Workflow execution context Source: WF_NS_PS_Generic.js, line 460 &lt;static&gt; PublishDecision_NodeEnter(executionContext) It is called from process defintion and it executes `PublishDecision_NodeEnter_Execute' Parameters: Name Type Description executionContext object Workflow execution context Source: WF_NS_PS_Generic.js, line 881 Example &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.PublishDecision_NodeEnter(executionContext); &lt;static&gt; PublishDecision_NodeEnter_Execute(executionContext) In here based on Decision and Parameter the next transtion is done isAuto Publish and Publish Decsion - Publish the Price Plan not is Auto Publish and Delegates pres - Price Plan in approved state, Publisher required Parameters: Name Type Description executionContext object Workflow Execution Context Source: WF_NS_PS_Generic.js, line 918 &lt;static&gt; PublishDecision_NodeEnter_FetchNotifiers(executionContext) It is called from process definition and it set email notifiers list in workflow execution context Parameters: Name Type Description executionContext object Workflow execution context Source: WF_NS_PS_Generic.js, line 857 Example &lt;decision name=&quot;Publish Decision&quot; expression=&quot;#{PublishDecisionTransition}&quot;&gt; &lt;event type=&quot;node-enter&quot;&gt; &lt;action name=&quot;DecideTransition&quot; class=&quot;com.vistaar.workflow.handlers.ScriptHandler&quot;&gt; &lt;javascript&gt; &lt;!--@ WF_NS_PS_Generic.PublishDecision_NodeEnter_FetchNotifiers(executionContext); × Search results Close "},"Workflow.html":{"id":"Workflow.html","title":"Namespace: Workflow","body":" Gallo Namespaces WebUIWorkflow Modules ApproverMatrixCreatorMatrixGWF_NormalizeWF_ExecutionWF_NS_PriceStructure Classes ExportPricePlanWebUI.PricePlanBestPracticesManagerWebUI.PricePlanFinderManagerWF_NS_PS_Generic Namespace: Workflow Workflow Source: Workflow.js, line 1 See: WF_NS_PS_Generic module:WF_NS_PriceStructure module:WF_Execution module:GWF_Normalize × Search results Close "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
